---
title: "Prioritizing management goals for stream biological integrity within the context of landscape constraints"
output: 
  bookdown::word_document2:
    reference_docx: my_styles.docx
bibliography: refs.bib
author: 'Marcus W. Beck (marcusb@sccwrp.org), Raphael D. Mazor (raphaelm@sccwrp.org), Scott Johnson (scott@aquaticbioassay.com), Karin Wisenbaker (karin@aquaticbioassay.com), Joshua Westfall (jwestfall@lacsd.org), Peter D. Ode (peter.ode@wildlife.ca.gov), Ryan Hill (hill.ryan@epa.gov), Chad Loflen (Chad.Loflen@waterboards.ca.gov), Martha Sutula (marthas@sccwrp.org), Eric D. Stein (erics@sccwrp.org)'
urlcolor: blue
link-citations: true
---

```{r setup, echo = F, warning = F, message = F, results = 'hide'}
# figure path, chunk options
knitr::opts_chunk$set(fig.path = 'figs/', warning = F, message = F, echo = F, dev.args = list(family = 'serif'), dpi = 300, warning = F, out.width = '100%',
  fig.process = function(x) {
  x2 = sub('-\\d+([.][a-z]+)$', '\\1', x)
  if (file.rename(x, x2)) x2 else x
  })

# libraries
library(tidyverse)
library(Hmisc)
library(Jabbrev)
library(gridExtra)
library(sf)
library(maptools)
library(maps)
library(grid)
library(ggrepel)
library(RColorBrewer)
library(ggridges)
library(scales)
library(quantregForest)
library(leaflet)
library(raster)

# functions (incl. color palettes)
source('../R/funcs.R')

# extract bib entries from online
# bib_scrp('manu_draft.Rmd', 'refs.bib')

 # data
load(file = '../data/typetab.RData')
load(file = '../data/csci_raw.RData')
load(file = '../data/ludat.RData')
load(file = '../data/calipsa.RData')
load(file = '../data/psalab.RData')
load(file = '../data/rf_full.RData')
load(file = '../data/sgrlu.RData')
load(file = '../data/shed.RData')
load(file = '../data/spat.RData')
load(file = '../data/scrs.RData')
load(file = '../data/csci_comid.RData')
load(file = '../data/nhdplo.RData')
load(file = '../data/caliclsplo.RData')
load(file = '../data/caliexp.RData')
load(file = '../data/comid_prd.RData')
```

# Abstract 

Many streams are failing to achieve desired biological condition and require management decisions to restore designated uses.  Some management goals may be impractical with limited resources, particularly in streams where large-scale changes on the landscape (e.g., urbanization) impose constraints on the upper limit of biological integrity.  A statewide landscape model was developed that sets reasonable expectations for observed conditions within landscape constraints to prioritize management actions. The model provides a context for what is likely to be achieved at a given site independent of an actual bioassessment score.  With this approach, sites can be ranked as over- or under-scoring relative to an expectation that is typical for the observed level of landscape alteration. We developed a visualization tool to compare observed bioassessment scores with modelled expectations to rapidly identify reaches that were scoring better or worse than expected. Using this tool, a group of regulators, dischargers, stormwater agencies, and environmental advocates from the San Gabriel River watershed (Los Angeles County, California) identified regions in the watershed with consistent patterns in bioassessment scores relative to expectations. Based on these patterns, they prioritized different management actions for each region. Sites in both developed and undeveloped areas that scored below expectations were prioritized for restoration; in contrast, restoration was not a priority at developed sites where scores were low but within expected ranges. Sites scoring better than expected were prioritized for enhanced protection, as well as additional monitoring. Interactive tools that connect landscape models with observed data can help set management goals appropriate for stakeholder needs and likely constraints on biological integrity.  These tools can easily be applied to other locations where biological data are used to assess environmental condition.

# Introduction

* Degraded biological condition in streams can occur from individual or multiple stressors acting at different scales [@Novotny05;@Townsend08;@Leps15].

*	In many urban and agricultural areas the majority of stream miles are not healthy and in need of some level of management (cite SWAMP, SMC, NRSA)

* Unfortunately, there are not sufficient resources to restore all streams to reference conditions, nor is it practical (e.g., varying costs and challenges of urban stream restoration [@Kenney12;@Shoredits13])

* Need a way to comprehensively evaluate streams across large spatial scales for “management potential”.  Biological filters act at different scales [@Poff97] and we can use this information to describe an expectation for prioritization that is scale-specific. This allows establishment of reasonable expectations and prioritization of limited resources most effectively. Landscape-level constraints are particularly relevant for macroinvertebrate communities in streams [@Sponseller01]

* Once these large spatial scales are understood, sites can be prioritized by local managers to ensure resources are wisely allocated. 
     
* Goal: demonstrate application of a landscape model to classify and prioritize stream monitoring sites using estimated constraints on biological integrity. 
     * Build on knowledge and relationships developed through existing monitoring programs and apply that in a predictive manner across entire landscapes to inform decisions
     * Statewide application of the model -  The model provides an estimate of context for biological condition that provides an expectation of what is likely to be achieved at a given site relative to large-scale drivers of stream health. The model was developed and applied to all stream reaches in California.
     * A case study is used to demonstrate how the model can be used to classify and prioritize by watershed using guidance from a regional stakeholder group. Specific questions that were addressed through the case study. Active stakeholder involvement was critical in applying the landscape models to define a framework for decision-making because priorities varied with management objectives.

# Methods

## Study area and data sources

```{r calimap, fig.height = 4.5, fig.width = 7, fig.cap = 'Urban and agricultural land use (left) and distribution of observed stream CSCI scores (right) in California. Cover of urban and agricultural land use in stream catchments was used to develop landscape models for stream reach expectations of bioassessment scores.  Grey lines are ecoregions in California, CV: Central Valley, CH: Chaparral, DM: Deserts Modoc, NC: North Coast, SN: Sierra Nevada, SC: South Coast.'}

lucol <- c('lightsalmon', 'grey')

# country base
country <- map_data('state')

# state base
calista <- map_data('state', region = 'california')

# psa data fortified
psadat <- calipsa %>% 
  as('Spatial') %>%
  as.data.frame %>% 
  rownames_to_column('id') %>% 
  dplyr::select(id, PSA6) %>% 
  rename(PSA = PSA6) %>% 
  mutate(Region = factor(PSA, 
    levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
    labels = c('CV', 'Ch', 'DM', 'NC', 'SN', 'SC')
    ))
psafrt <- calipsa %>% 
  dplyr::select(-PSA_REGION, -AREA, -PERIMETER, -PSA8) %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(psadat, by = 'id')

# psalab
psalab <- psalab %>% 
  mutate(
    Region = as.character(Region),
    Region = paste0('bolditalic(', Region, ')')
    )

# land use data fortified  
toplo <- ludat %>% 
  as('Spatial') %>% 
  fortify %>% 
  filter(id %in% c(2, 3)) %>% 
  mutate(id = factor(id, levels = c(2, 3), labels = c('Agriculture', 'Urban'))) %>% 
  rename(`Land use` = id)

# csci seq for color pal
palseq <- range(csci_raw$CSCI, na.rm = T) 
palseq <- seq(palseq[1], palseq[2], length = 5)

p1 <- ggplot() + 
  geom_polygon(data = toplo, aes(x = long, y = lat, fill = `Land use`, group = group)) + 
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.7), size = 0.1) +
  geom_polygon(data = calista, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.7))

# text with outline magic
theta <- seq(pi/8, 2*pi, length.out=16)
xo <- diff(range(psalab$long))/200
yo <- diff(range(psalab$lat))/200
for(i in theta) {
  p1 <- p1 + geom_text_repel(data = psalab, 
    aes_q(x = bquote(long +.(cos(i)*xo)),
          y = bquote(lat +.(sin(i)*yo)),
          label = ~Region), point.padding = NA, parse = T, family = 'serif', size = 5, colour = 'black')
    
}
p1 <- p1 + 
  geom_text_repel(data = psalab, aes(x = long, y = lat, label = Region), point.padding = NA, parse = T, family = 'serif', size = 5, colour = 'white') + 
  coord_map() + 
  scale_fill_manual(values = lucol) +
  theme_void(base_family = 'serif') + 
  theme(
    legend.position = 'top'
    ) + 
  guides(fill = guide_legend(ncol = 3)) +
  ggsn::scalebar(location = 'bottomleft', y.min = 33, y.max = 35, x.min = -124, x.max = -120, 
           dist = 150, st.dist=.15, st.size = 3, height = 0.1, dd2km = T, model = 'WGS84')

p2 <- ggplot(csci_raw, aes(x = Longitude, y = Latitude, colour = CSCI)) +
  scale_colour_gradientn(colours = pal(palseq)) +
  geom_point(size = 1.25) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.1, colour = scales::alpha('black', 0.5)) +
  geom_polygon(data = calista, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.5)) +
  coord_map() + 
  theme_void(base_family = 'serif') + 
  theme(legend.position = 'top') + 
  guides(colour = guide_colourbar(barheight = 0.5, barwidth = 8))

pinset <- ggplot(country, aes(x = long, y = lat, group = group)) +
  geom_polygon( fill = NA, color = "black", size = 0.3) +
  geom_polygon(data = calista, fill = 'black', color = "black", size = 0.3)+
  coord_map() +
  theme_void() 
  
grid.newpage()
v1 <- viewport(width = 1, height = 1, x = 0.3, y = 0.5) 
v2 <- viewport(width = 1, height = 1, x = 0.7, y = 0.5) 
v3 <- viewport(width = 0.25, height = 0.25, x = 0.85, y = 0.65)
print(p1, vp = v1) 
print(p2, vp = v2)
print(pinset, vp = v3)
```

Landscape models were developed for California using land use data, stream hydrography, and biological assessments.  California covers 424,000 km$^2$ of land from latitudes 33 to 42$^\circ$N that includes extreme variation in altitude and climate (\@ref(fig:calimap)).  Temperate rainforests occur in the north, deserts in the northeast and southeast, and Mediterranean climates in coastal regions.  California's stream network is approximately 280,000 km in length and covers all of the major climate zones in the state. A high degree of endemism and biodiversity occurs in these streams including nearly 4000 species of vascular plants, macroinvertebrates, and vertebrates that depend on fresh water during their life history [@Howard09;@Howard15].  Approximately 30% of streams in California are perennial with the remaining as intermittent or ephemeral for portions of the year.  Much of California is publicly owned and is used heavily for recreation.  A large portion of the central region of the state is agricultural (i.e., Central Valley), whereas dense areas of urban development are in the southwest (i.e., Los Angeles and San Diego) and central (San Francisco Bay area) coast areas.  Developed lands increased in California by 38% from 1973 to 2000 [@Sleeter11].

Stream data from the National Hydrography Dataset (NHD) [@USGS14] were used to identify reaches in California for modelling biological integrity. The NHD is a surface water framework that maps drainage networks and associated features (e.g., streams, lakes, canals, etc.) in the United States.  Stream flow lines in the NHD are developed from flow accumulation models that estimate location of a stream given slope and elevation changes from existing elevation datasets.  As such, flow lines in California represent both perennial, intermittent, and ephemeral streams that have wide variation in observed flow throughout the year. Stream reaches designated in the NHD were used as the discrete spatial unit for modelling biological integrity.  A reach is defined as a continuous piece of surface water with similar hydrologic characteristics [@USGS14].  Hydrography data were combined with landscape metrics available from the StreamCat Dataset [@Hill16] to estimate land use at the catchment (nearby landscape flowing directly into a stream) and the entire upstream watershed for each reach.  The StreamCat Dataset was developed specifically for the NHD to leverage the topology of stream connections to estimate cumulative landscape metrics of all reaches.

The California Stream Condition Index (CSCI) [@Ode16;@Mazor16] was used as a measure of biological condition in California streams.  Benthic macroinvertebrate data used to calculate CSCI scores were collected at nearly 3400 sites (6270 with repeat visits) between 2000 and 2016.  Field data were collected during baseflow conditions typically between May and July following methods in @Ode07.  The CSCI is a predictive index of stream health that compares the observed taxa and metrics at a site to those expected under reference conditions.  Expected conditions at a site are based on models that estimate the likely macroinvertebrate community in relation to factors that naturally influence biology, e.g., watershed size, elevation, climate, etc.  The CSCI score at a site is based on an observed-to-expected ratio of taxa and a predictive multimetric index composed of six individual metrics that describe the structure and function of the macroinvertebrate community.  The index score at a site can vary from 0 to 1.4, with higher values indicating an observed community with less deviation from reference conditions.  Because the index was developed to minimize the influence of natural gradients, the index scores have consistent meaning across the state [@Reynoldson97].  A threshold score based on a selected lower percentile of scores (e.g., 10%) at all reference sites is used to define nominally low and high scoring sites.

## Building and validating landscape models

A prediction model of the CSCI was developed to estimate likely ranges of scores associated with land use gradients.  Land use as urban and agricultural was quantified for the catchment of each stream reach in California using the StreamCat database [@Hill16]. CSCI scores were modelled using only the estimates of urban and agricultural land use as the developed portion of the landscape within each stream reach. The model was incomplete by design to describe scores only in relation to large-scale constraints on biological condition that are not easily controlled by management actions or where costs to mitigate are likely to be excessive.  The remainder of the variation in scores not related to landscape constraints could be attributed to additional, unmeasured environmental variables that influence stream biointegrity.  Deviation of observed scores from the model predictions were considered diagnostic of variation not related to landscape effects.     

Models were developed using quantile regression forests to estimate ranges of likely CSCI scores in different landscapes [@Meinshausen06;@Meinshausen17].  Quantile models evaluate the conditional response across the range of values that are expected, such as the lower and upper percentiles of the distribution, as compared to only the mean response with conventional models [@Cade03].  This allows use of model predictions to describe where bioassessment targets are unlikely to be met or where streams are unlikely to be impacted by placing bounds on the range of expectations relative to landscape constraints. Random forest models also provide robust predictions by evaluating different subsets of observations from random splits of the predictor variables.  The final predictions are the averaged response across several models.  These models have been used extensively in bioassessment applications [@Carlisle09;@Chen14;@Mazor16] and can produce unbiased estimates that are relatively invariant to noisy relationships or non-normal distributions [@Breiman01;@Hastie09].  Quantile regression forests were used to predict CSCI scores in each stream reach from the 5th to the 95th percentile of expectations at five percent intervals (i.e., 5th, 10th, etc.). 

Calibration data for the landscape models were based on a random selection of 75% of monitoring stations with observed CSCI scores.  The random selection was stratified by ecoregion (Figure \@ref(fig:calimap)) and relative amounts of impervious surfaces in each catchment based on percentile distributions.  The stratification method was chosen to ensure sufficient representation of landscape gradients in each ecoregion.  The remaining sites were used for model validation.  

## San Gabriel River watershed case study

Stream reach and bioassessment data from the San Gabriel River (SGR) watershed in southern California were used to develop reach classifications, site performance categories, and management priorities from the landscape models. A strong land use gradient occurs in the SGR watershed (Figure \@ref(fig:sgrshd)). Headwaters begin in the San Gabriel mountains where the land is primarily undeveloped or protected for reacreational use, whereas the lower watershed is in a heavily urbanized region of Los Angeles County.  The San Gabriel river is dammed at four locations for flood control in the upper watershed and is hydrologically connected to the Los Angeles river to the west through the Whittier Reservoir in the lower watershed. Spreading grounds are present in the middle of the watershed for groundwater recharge during high flow.  Nearly all of the stream reaches in the lower half of the watershed are channelized with concrete or other reinforcements.

```{r sgrshd, fig.height = 8, fig.width = 5.5, fig.cap = 'San Gabriel River watershed in southern California. Land cover is shown in plot (a) and the predicted median CSCI scores at each stream reach and observed CSCI scores are shown in (b). The watershed is undeveloped in the north and heavily urbanized in the south. Ecoregions in the inset are identified in Figure \\@ref(fig:calimap).'}

# land use raster data
luplo <- sgrlu %>% 
  rasterToPoints %>% 
  data.frame %>% 
  rename(`Land cover` = layer) %>% 
  mutate(`Land cover` = factor(`Land cover`, levels = c(5, 4, 3, 2, 1), labels = c('Urban: hi', 'Urban: md', 'Urban: lo', 'Open: forest', 'Open: chaparral'))) 

# hydrolines
spatdat <- spat %>% 
  dplyr::select(COMID, full0.50) %>% 
  mutate(id = as.character(1:nrow(.)))
st_geometry(spatdat) <- NULL
spatfrt <- spat %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(spatdat, by = 'id') %>% 
  mutate(COMID = as.character(COMID)) %>% 
  left_join(scrs, by = 'COMID') %>% 
  mutate(csci_diff = csci - full0.50) %>% 
  filter(!is.na(full0.50))

# wshed boundary fortified
shedfrt <- shed %>% 
  as('Spatial') %>% 
  fortify 

# land use colors
lucol <- c('grey20', 'grey40', 'grey60', 'khaki3', 'khaki2')

# psa data fortified
psadat <- calipsa %>% 
  as('Spatial') %>% 
  as.data.frame %>% 
  rownames_to_column('id') %>% 
  dplyr::select(id, PSA6) %>% 
  rename(PSA = PSA6) %>% 
  mutate(Region = factor(PSA, 
    levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
    labels = c('CV', 'Ch', 'DM', 'NC', 'SN', 'SC')
    ))
psafrt <- calipsa %>% 
  dplyr::select(-PSA_REGION, -AREA, -PERIMETER, -PSA8) %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(psadat, by = 'id')

palseq <- seq(palseq[1], palseq[2], length = 5)

# pinset
pinset <- ggplot() + 
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.5), size = 0.2) +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'tomato1') +
  theme_minimal() + 
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(), 
    axis.text = element_blank(), 
    axis.title = element_blank()
    ) + 
  coord_map()

# csci seq for color pal
seqcsc <- range(spatfrt$csci, na.rm = T) 
seqcsc <- seq(seqcsc[1], seqcsc[2], length = 5)

# color legend
colleg <- ggplot() +
  geom_point(data = spatfrt, aes(x = long.y, y = lat.y, colour = csci)) +
  theme_bw(base_family = 'serif') +
  theme(
    legend.position = 'top',
    legend.justification = 'left',
    legend.box.just = 'left',
    legend.box = 'vertical'
  ) +
  scale_colour_gradientn('CSCI', colours = pal(seqcsc)) +
  guides(colour = guide_colourbar('CSCI', barheight = 0.55, barwidth = 8, title.position = 'top'))
colleg <- g_legend(colleg)

# separate lu legend
luleg <- ggplot(luplo) + 
  geom_tile(aes(x, y, fill = `Land cover`), alpha=0.8) +
  theme_bw(base_family = 'serif') +
  theme(
    legend.position = 'top', 
    legend.justification = 'left',
    legend.box.just = 'left',
    legend.box = 'vertical'
  ) +  
  scale_fill_manual('Land cover', values = lucol) +
  guides(fill = guide_legend(ncol = 2, title.position = 'top'))
luleg <- g_legend(luleg)
  
# land use plot
p1 <- ggplot(luplo) + 
  geom_tile(aes(x, y, fill = `Land cover`), alpha=0.8) +
  theme_void(base_family = 'serif') +
  scale_fill_manual('Land cover', values = lucol) +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = NA, colour = 'black', alpha = 0.7) +
  coord_equal() +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = 'none', 
    axis.title = element_blank()
    ) +
  ggtitle('(a) Land cover in the San Gabriel watershed')

# hydrolines plot with CSCI pts
p2 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long.x, y = lat.x, group = id, colour = full0.50, linetype = 'Reach predicted\nmedian CSCI')) +
  scale_colour_gradientn(colours = pal(seqcsc)) +
  geom_point(data = spatfrt, aes(x = long.y, y = lat.y, fill = csci, shape = 'Observed CSCI'), size = 3, alpha = 0.9) +
  scale_fill_gradientn('', colours = pal(seqcsc)) +
  scale_linetype_manual('', values = 'solid') +
  scale_shape_manual('', values = 21) +
  ggsn::scalebar(location = 'bottomright', y.min = 33.77, y.max = 33.8, x.min = -118, x.max = -117.7, dist = 10, st.dist=.5, st.size = 3, height = 0.3, dd2km = T, model = 'WGS84') +
  guides(fill = F, colour = F) +
  coord_equal() +
  theme_void(base_family = 'serif') +
  theme(
    # legend.position = 'top',
    legend.justification = 'left',
    legend.box.just = 'left',
    axis.title = element_blank()
    ) + 
  ggtitle('(b) Reach median predictions and observed scores for the CSCI')
p2leg <- g_legend(p2) 
p2 <- p2 + theme(legend.position = 'none')

# png('figs/sgrshd.png', height = 8, width = 5.5, units = 'in', res = 300, family = 'serif')
grid.arrange(
  arrangeGrob(p1, 
              arrangeGrob(pinset, luleg, ncol = 1, heights = c(1, 1)), ncol = 2, widths = c(1, 0.5)),
  arrangeGrob(p2, 
              arrangeGrob(colleg, p2leg, ncol = 1, heights = c(1,1)), ncol = 2, widths = c(1, 0.5)), 
  ncol = 1
)
# dev.off()
```

The SGR watershed contains a diverse group of stakeholders from local municipalities, water districts, water quality regulatory agencies, consulting groups, and non-government organizations. Collectively, the San Gabriel River Regional Monitoring Program (SGRRMP) includes stakeholders from these groups that cooperatively work to increase awareness of issues in the SGR watershed and work to improve coordination of compliance and ambient monitoring efforts.  The stakeholder workgroup included individuals from the SGRRMP with interests in water supply, improvements to water quality, habitat protection or creation, and storm water permitting. Individuals were selected for partipation to include a variety of mangement interests and based on willingness to adopt tools developed from the landscape models. The stakeholder workgroup met monthly over a six-month period to discuss model applications and to refine the interpretation of results.  Stakeholder involement was critical for developing an assessment framework that met the needs of all engaged parties and ensured that final products were more likely to be incorporated into formal processes of decision-making. 

## Reach classification, site performance, and prioritization

A framework for identifying site priorities for management actions was developed using a three-step process.  First, estimates of the range of expected CSCI scores at each stream reach in relation to land use were used to define reach classifications.  Second, the relationship between observed CSCI scores and the reach classifications were then used to assign a relative performance value for each monitoring site. Third, site performance categories in relation to reach classification and bioassessment targets were used to define management priorities.  This framework was developed through close interaction with the regional stakeholder group to demonstrate how the landscape model can be used as a management tool given that priorities will vary by interests and location.  As such, the results are provided as a guide to facilitate decision-making rather than a prescription of targeted actions to manage stream health.  The entire process is shown in Figure \@ref(fig:ridges) and Table \@ref(tab:typetab) and is described in detail below.. 

Identifying site priorities began with defining a classification framework for stream reaches to identify the possible or likely extent of biological constraints.  Classifications were developed using the range of CSCI expectations at a reach (Figure \@ref(fig:ridges)a,b) relative to a chosen threshold for the CSCI to define nominally low or high scores (Figure \@ref(fig:ridges)c).  The reach classification was based solely on the intersection of the CSCI expectations at a reach with chosen CSCI threshold, where expectations could be below, above, or overlapping the threshold.  Stream reaches with a range of CSCI score expectations entirely below the thresholds were considered likely constrained, whereas those with expectations entirely above were considered likely unconstrained.  Reaches with score expectations that included the CSCI thresholds were considered possibly constrained or possibly unconstrained, where the distinction was based on location of the median expectation of a reach relative to the threshold.  

```{r ridges, fig.height = 8, fig.width = 10, fig.cap = 'Application of landscape models to identify site expectations and bioassessment performance for sixteen example stream reaches.  A range of CSCI scores is predicted from the model (a) and the lower and upper limits of the expectations are cut to define a certainty range for the predictions (b).  Overlap of the certainty range at each reach with a chosen CSCI threshold (c) defines the stream reach classification as likely unconstrained (lu), possibly unconstrained (pu), possibly constrained (pc), and likely constrained (lc).  The site performance from the observed bioassessment score is defined as over scoring (above the certainty threshold), expected (within), and under scoring (below) for each of four stream classes (d).'}
##
# plot data

# plot data globals
sel <- 16
bnd <- 0.1
pts <- 2000
qts <- 0.05
thrsh <- 0.79

catcds <- data.frame(
  int = c('111', '011', '001', '000'),
  cls = c('likely unconstrained', 'possibly unconstrained', 'possibly constrained', 'likely constrained'),
  clsabv = c('lu', 'pu', 'pc', 'lc')
)

prfcds <- data.frame(
  int = c('00', '01', '11'), 
  cls = c('over scoring', 'expected', 'under scoring')
)

prflev <- c('over scoring', 'expected', 'under scoring')

scrs <- c(1.35, 1.15, 0.84, 0.6, 1.25, 0.95, 0.75, 0.53, 1.1, 0.83, 0.53, 0.35, 1, 0.75, 0.45, 0.15)

# plot data
set.seed(433)
rnd <- data.frame(
  id = factor(rev(1:sel), levels = rev(1:sel)),
  ave = rep(seq(0.5, 1.1, length = 4), each = 4),
  sds = sample(c(0.13), sel, replace = T), 
  scrs = rev(scrs)
  ) %>%
  group_by(id, scrs) %>% 
  nest %>%
  mutate(
    rnd = purrr::map(data, ~ rnorm(pts, .x$ave, .x$sds)), 
    estall = purrr::map(rnd, function(x){
      
      est <- density(x, n = pts, bw = bnd)
      out <- data.frame(
        xout = est$x, 
        hght = est$y
      )
      
      return(out)
      
    }), 
    estcut = purrr::pmap(list(rnd, estall), function(rnd, estall){
      
      qts <- quantile(rnd, c(qts, 1 - qts))
      out <- estall %>% 
        filter(xout >= qts[1] & xout <= qts[2])
      
      return(out)
      
    }), 
    estcat = purrr::map(estcut, function(x){
      
      out <- c(range(x$xout), median(x$xout)) %>% 
        sort %>% 
        findInterval(., thrsh) %>% 
        paste(collapse = '') %>% 
        factor(levels = catcds$int, labels = catcds$clsabv) %>% 
        as.character
      
      return(out)
      
      
    }), 
    prfcat = purrr::pmap(list(estcut, scrs), function(estcut, scrs){
      
      out <- range(estcut$xout) %>% 
        findInterval(., scrs) %>% 
        paste(collapse = '') %>% 
        factor(levels = prfcds$int, labels = prfcds$cls) %>% 
        as.character
      
      return(out)
      
    })
  )

toplo1 <- rnd %>% 
  dplyr::select(id, estall) %>% 
  unnest

toplo2 <- rnd %>% 
  dplyr::select(id, estcut) %>% 
  unnest

toplo3 <- rnd %>% 
  dplyr::select(id, estcut, estcat, prfcat) %>% 
  unnest(estcat, prfcat) %>% 
  unnest %>% 
  mutate(
    prfcat = paste0(prfcat, ' (', estcat, ')'), 
    estcat = factor(estcat, levels = catcds$clsabv, labels = catcds$cls)
  ) %>% 
  rename(`Stream class` = estcat)

toplo4 <- rnd %>% 
  dplyr::select(id, scrs, estcat, prfcat) %>% 
  unnest %>% 
  mutate(
    prfcat = factor(prfcat, levels = prflev),
    estcat = factor(estcat, levels = catcds$clsabv, labels = catcds$cls),
    hght = scrs
  ) %>% 
  rename(
    `Relative site score` = prfcat,
    `Stream class` = estcat
    )

##
# plots

# stream class colors
exp_col <- RColorBrewer::brewer.pal(9, 'Paired')[c(2, 1, 5, 6)] %>% 
  alpha(., 0.8)  

# plot globals
ht <- 0.99

# base 
pbase<- ggplot(toplo1, aes(x = xout, y = id, height = hght)) + 
  geom_density_ridges(stat = 'identity', alpha = 0.5, colour = NA, fill = 'grey', scale = ht) +
  scale_x_continuous(limits = c(0, 1.4)) + 
  theme_minimal(base_family = 'serif') + 
  theme(
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    legend.position = 'top'
  )

p1 <- pbase +
  geom_density_ridges(stat = 'identity', rel_min_height = 0.001, colour = 'black', fill = 'darkgrey', scale = ht) +
  scale_fill_gradient2(low = '#d7191c', mid = '#abd9e9', high = '#2c7bb6', midpoint = 1) +
  guides(fill = guide_colourbar('CSCI', barheight = 0.5, barwidth = 5, title.position = 'top')) +
  ggtitle('(a) Range of expected CSCI\nscores for stream reaches')

p2 <- pbase +
  geom_density_ridges(data = toplo2, stat = 'identity', rel_min_height = 0.001, colour = 'black', fill = 'darkgrey', scale = ht) +
  scale_fill_gradient2(low = '#d7191c', mid = '#abd9e9', high = '#2c7bb6', midpoint = 1) +
  ggtitle('(b) Expected CSCI scores\nwithin certainty range') +
  theme(legend.position = 'none')

p3 <- pbase +
  geom_density_ridges(data = toplo3, aes(fill = `Stream class`), stat = 'identity', colour = 'black', scale = ht) +
  geom_vline(xintercept = thrsh, linetype = 'dashed') +
  scale_fill_manual(values = exp_col) +
  guides(fill = guide_legend(title.position = 'top', nrow = 2)) +
  ggtitle('(c) Stream reach classification\nby CSCI threshold')

p4 <- pbase +
  geom_density_ridges(data = toplo3, aes(fill = `Stream class`), stat = 'identity', colour = 'black', scale = ht) +
  geom_vline(xintercept = thrsh, linetype = 'dashed') +
  geom_point(data = toplo4, aes(x = scrs, group = id, shape = `Relative site score`, fill = `Stream class`), size = 3) + 
  scale_fill_manual(values = exp_col, guide = F) +
  scale_colour_manual('Site performance', values = pal_prf2(levels(toplo4$`Site performance`)), na.value = 'yellow') + 
  scale_shape_manual(values = c(24, 21, 25)) +  
  guides(colour = guide_legend(title.position = 'top'), shape = guide_legend(title.position = 'top')) +
  ggtitle('(d) Site performance by\nstream classification')

p3leg <- g_legend(p3)
p3 <- p3 + theme(legend.position = 'none')

p4leg <- g_legend(p4)
p4 <- p4 + theme(legend.position = 'none')

grid.arrange(
  arrangeGrob(p3leg, p4leg, ncol = 2, widths = c(0.75, 1)),
  arrangeGrob(p1, p2, p3, p4, ncol = 4),
  left = 'Reach type', bottom = 'CSCI scores', ncol = 1, heights = c(0.2, 1)
)
```

CSCI scores from biomonitoring data were used to define performance of a sample site relative to the stream reach classification (Figure \@ref(fig:ridges)d). For each of the four reach classifications (likely constrained, possibly constrained, possibly unconstrained, and likely unconstrained), the site performance was defined relative to the bounds of the expected CSCI scores.  This provided a definition of site performance that can be used to understand the observed score relative to the biological context of a reach.  Sites with observed scores above the upper limit of the reach expectation (e.g., above the 95th percentile of expected scores) were considered "over-performing" and sites below the lower limit were "under-performing".  Sites with CSCI scores within the range of expectations were as "expected".   

Site performance categories were further split relative to location to the selected CSCI threshold.  This final split was created with the intent that description of site scores relative to a defined threshold (e.g., impairment threshold or restoration target) should also be considered.  Specifically, a fourth category of site performance for each reach classifcation was added to define a site as above or below the threshold.  For a likely unconstrained reach, underperforming sites below the minimum expected score were additionally defined as being above or below the CSCI threshold.  Similarly, overperforming sites above the maximum expected score in a likely constrained reach were additionally defined as being below or above the CSCI threshold.  For possibly constrained and possibly unconstrained reaches, sites that were performing as expected were addtionally defined as being below or above the CSCI threshold.  In total, sixteen site types were defined for the three reach classification and three site performance classifications (Table \@ref(tab:typetab)).

```{r typetab, tidy = F}
# table content format
totab <- typetab %>% 
  mutate(
    `Observed score` = gsub('>=', '$\\\\geq$', `Observed score`),
    `Reach expectation` = ifelse(duplicated(`Reach expectation`), '', paste0('**', `Reach expectation`, '**')), 
    Type = as.character(Type)
  ) %>% 
  dplyr::select(-Sites)

# table stuff
cap.val <- 'Possible site types based on stream reach classification, site performance, and observed CSCI score. The observed score column describes where a CSCI score is observed relative to the lower and upper percentiles (e.g., 5th and 95th) of expected scores for a reach and the chosen CSCI threshold (e.g., 10th percentile of scores at reference sites or 0.79) for nominally low or high values.'

# table
knitr::kable(totab, booktabs = T, caption = cap.val)
```

Each site type was used to define a priority as a demonstration of how results from the landscape model can help achieve different stream management objectives.  This final process relied exclusively on feedback from the stakeholder group that represented interests in monitoring, regulation, restoration, and protection.  An interactive online application was created for the stakeholder group to facilitate the recommendation of management actions for each site type (Figure \@ref(fig:app)).  Priorities for each site type were defined accordingly with the expectation that site types will have different meanings for prioritization given the interest.  Stakeholders from each sector were tasked with identifying their relevant priorities by ranking each site type from high to low priority using a blank template for reference.  A brief description of the rationale for a site priority was also requested with the feedback.  The final priorities were generalized into three categories to recommend actions in addition to baseline monitoring and maintenance. The final priorities also assumed that existing information available for each site was "true" following established practices to account for uncertainty or variation between assessments.  A consensus was reached for the following definitions of each action:

* Investigate:  Additional monitoring or review of supplementary data (e.g., aerial imagery);
* Protect: Additional scrutiny of proposed development and/or projects; 
* Restore: Targeted action for causal assessment and/or restoration funds.

Each site type was ranked as high, medium, or low priority for each action.  No priority assigned to an action for a stream type was indication that baseline monitoring and maintenance was sufficient for a site type.

```{r app, fig.cap='Screenshot of the online application used by the stakeholder group to interact with and use results from the landscape models.  The application allowed users to visualize results of reach classications, relative site scores for the CSCI based on the expectation, and recommend management actions for each reach type.  The app can be viewed at https://beckmw.shinyapps.io/sgrrmp_classify/'}
knitr::include_graphics('figs/app.png')
```

## Sensitivity analyses

Stream reach classifications and site performance categories depend on the range of score expectations from the landscape model (or certainty, Figure  \@ref(fig:ridges)b) and the CSCI threshold for defining nominally low or high scores (Figure \@ref(fig:ridges)c).  This framework for identifying priorities was developed to allow flexibility in how the model could be applied.  First, the framework can accommodate degrees of certainty in the model by allowing variation in the range of scores that are used to define a stream reach classification.  The 5th and 95th percentile of expected scores at a reach are used as a default range in which a high degree of certainty in the model output is assumed.  The ability to reduce this range (e.g., 25th to 75th percentile) to assume less certainty in the model is provided.  The CSCI threshold can also be changed to assess effects of relaxing or increasing flexibility in a potential definition of a regulatory standard. A threshold of 0.79 is used by default as a measure of the 10th percentile of scores at all reference (non-impacted) sites that were used to calibrate the CSCI index. This value can be increased to examine effects of a more stringent threshold or decreased for a more relaxed threshold.  The combined effects of changing both the certainty in the model and the CSCI threshold were evaluated to estimate the changes in stream miles in each classification and the number of sites in each priority type.     

## Unclassified reaches

Finally, some stream reaches were unclassifed following application of the landscape model to the statewide hydrography dataset.  Unclassified reaches occurred when insufficient data in the StreamCat database were available to estimate CSCI predictions or if a stream catchment basin could not be defined for a particular reach.  The latter was more common, particularly in developed areas where engineered channels or agricultural ditches were hydrologically removed from the natural stream network.  Overall, unclassified reaches were not common in the statewide dataset but they may have regional importance depending on needs of local management groups.  A preliminary approach for assigning biological expectations to unclassified reaches is demonstrated for 'typically' urban and agriculture reaches that relies on the range of expectations for reaches with similar land use by region.

# Results

### State-wide patterns

* Where does the model perform well, how does performance vary with validation and calibration datasets (Table \@ref(tab:perftab)).

```{r perftab}
# observed and predicted data
obsdat <- csci_comid %>%
  dplyr::select(COMID, StationCode, SiteSet, SelectedSample, CSCI, PSA6c, RegImpQ) %>% 
  filter(SelectedSample %in% 'Selected')
prddat <- comid_prd %>% 
  dplyr::select(COMID, full0.50)

# combined data to eval for perf
dat <- obsdat %>% 
  inner_join(prddat, by = 'COMID') %>% 
  rename(
    observed = CSCI,
    predicted = full0.50
  ) %>% 
  dplyr::select(SiteSet, PSA6c, observed, predicted)

# total dataset performance
totdf <- dat %>% 
  group_by(SiteSet) %>% 
  nest %>% 
  mutate(data = purrr::map(data, function(x){
    
    nval <- nrow(x)
    aveobs <- mean(x$observed, na.rm = T)
    sdobs <- sd(x$observed, na.rm = T)
    aveprd <- mean(x$predicted, na.rm = T)
    sdprd <- sd(x$predicted, na.rm = T)
    ttst <- with(x, t.test(observed, predicted, na.rm = T))
    tval <- ttst$statistic
    pval <- p_ast(ttst$p.value)
    corv <- with(x, cor.test(observed, predicted))$estimate
    errv <- with(x, sqrt(mean((predicted - observed)^2, na.rm = T)))
    
    out <- tibble(set = 'Statewide', nval, aveobs, sdobs, aveprd, sdprd, tval, pval, corv, errv)
    return(out)
    
  })) %>% 
  unnest

# PSA regional performance
regdf <- dat %>% 
  group_by(PSA6c, SiteSet) %>% 
  nest %>% 
  mutate(data = purrr::map(data, function(x){
    
    nval <- nrow(x)
    aveobs <- mean(x$observed, na.rm = T)
    sdobs <- sd(x$observed, na.rm = T)
    aveprd <- mean(x$predicted, na.rm = T)
    sdprd <- sd(x$predicted, na.rm = T)
    ttst <- with(x, t.test(observed, predicted, na.rm = T))
    tval <- ttst$statistic
    pval <- p_ast(ttst$p.value)
    corv <- with(x, cor.test(observed, predicted))$estimate
    errv <- with(x, sqrt(mean((predicted - observed)^2, na.rm = T)))
    
    out <- tibble(nval, aveobs, sdobs, aveprd, sdprd, tval, pval, corv, errv)
    return(out)
    
  })) %>% 
  unnest %>% 
  rename(set = PSA6c) %>% 
  dplyr::select(SiteSet, set, everything())

# combine and prep for table
allerr <- totdf %>% 
  bind_rows(regdf) %>% 
  dplyr::select(-pval) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  mutate(
    sdobs = paste0('(', sdobs, ')'), 
    sdprd = paste0('(', sdprd, ')'), 
    set = factor(set, levels = c('Statewide', 'CH', 'CV', 'DM', 'NC', 'SC', 'SN'))
  ) %>% 
  unite('Observed', aveobs, sdobs, sep = ' ') %>% 
  unite('Predicted', aveprd, sdprd, sep = ' ') %>% 
  rename(
    n = nval,
    Correlation = corv, 
    RMSE = errv, 
    `t-stat` = tval, 
    Location = set, 
    Dataset = SiteSet
  ) %>% 
  arrange(Dataset, Location) %>% 
  mutate(Dataset = ifelse(duplicated(Dataset), '', Dataset))

# table stuff
cap.val <- 'Performance of landscape models by calibration and validation datasets in predicting CSCI scores.  The statewide dataset (Figure \\@ref(fig:calires)) and individual regions of California (Figure \\@ref(fig:calimap) are evaluated.  Averages and standard deviations (in parentheses) for observed and predicted values of each dataset are shown.  Correlations, root mean squared errors, and t-statistics for comparisons of observed and predicted values are also shown to evaluate model perforance.  None of the t-statistics were significant at alpha of 0.05.'

# table
knitr::kable(allerr, booktabs = T, caption = cap.val)
```

* What is the consistency of patterns? For example, percent stream miles as xyz by PSA. Figure \@ref(fig:calires).

```{r eval = F}
# state base
calista <- map_data('state', region = 'california')

# psa data fortified
psadat <- calipsa %>%
  as('Spatial') %>%
  as.data.frame %>%
  rownames_to_column('id') %>%
  dplyr::select(id, PSA6) %>%
  rename(PSA = PSA6) %>%
  mutate(Region = factor(PSA,
                         levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
                         labels = c('CV', 'Ch', 'DM', 'NC', 'SN', 'SC')
  ))
psafrt <- calipsa %>%
  dplyr::select(-PSA_REGION, -AREA, -PERIMETER, -PSA8) %>%
  as('Spatial') %>%
  fortify %>%
  left_join(psadat, by = 'id')

# station calibration data
caldat <- csci_comid %>%
  dplyr::select(COMID, StationCode, SiteSet, SelectedSample, CSCI, RegImpQ)
locs <- csci_raw %>%
  dplyr::select(MasterID, Latitude, Longitude) %>%
  rename(StationCode = MasterID) %>%
  unique
caldat <- caldat %>%
  left_join(locs, by = 'StationCode') %>%
  filter(SelectedSample != 'NotSelected') %>%
  filter(!is.na(Latitude)) %>%
  filter(SiteSet %in% 'Cal') %>%
  mutate(RegImpQ = factor(RegImpQ, levels = c('T1', 'T2', 'T3', 'T4'), labels = c('1^st', '2^nd', '3^rd', '4^th')))

# all comid preds
calmed <- nhdplo %>%
  na.omit

# impervious quartile colors
impcol <- RColorBrewer::brewer.pal(9, 'Greys')[c(3, 5, 7, 9)]

# csci seq for color pal
palseq <- range(csci_raw$CSCI, na.rm = T)
palseq <- seq(palseq[1], palseq[2], length = 5)

# relative site scores
relscr <- caliexp %>%
  dplyr::select(lat, long, perf, strcls) %>%
  filter(!is.na(perf))

# calibration sites with impervious
p1 <- ggplot(caldat, aes(x = Longitude, y = Latitude, colour = RegImpQ)) +
  scale_colour_manual(values = impcol, labels = parse(text = levels(caldat$RegImpQ))) +
  geom_point(size = 1.25, alpha = 0.8) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() +
  guides(colour = guide_legend("Imperviousness quartiles by region\n", title.position = 'top')) +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = c(0.5, 1.06),
    legend.direction = 'horizontal',
    plot.margin = grid::unit(c(15, 0, 0, 0), units = 'pt')
  )

# median csci predictions
p2 <- ggplot(calmed) +
  geom_path(aes(x = long, y = lat, group = id, colour = full0.50), size = 0.30) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() +
  scale_colour_gradientn(colours = pal(range(calmed$full0.50, na.rm = T))) +
  guides(colour = guide_colourbar('Reach predicted median CSCI\n', barheight = 0.5, barwidth = 8, title.position = 'top')) +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = c(0.5, 1.06),
    legend.direction = 'horizontal',
    plot.margin = grid::unit(c(15, 0, 0, 0), units = 'pt')
  )

# comid class
p3 <- ggplot(caliclsplo) +
  geom_path(aes(x = long, y = lat, group = id, colour = strcls), size = 0.30) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() +
  scale_colour_manual(values = pal_exp(levels(caliclsplo$strcls))) +
  guides(colour = guide_legend('Reach classification', title.position = 'top', ncol = 2)) +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = c(0.5, 1.06),
    legend.direction = 'horizontal',
    plot.margin = grid::unit(c(15, 0, 0, 0), units = 'pt')
    )

# relative site scores
undscr <- relscr %>% 
  filter(perf %in% 'under scoring')
p4<- ggplot(undscr) +
  geom_point(aes(x = long, y = lat, fill = strcls, shape = perf)) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() + 
  scale_fill_manual(values = pal_exp(levels(caliexp$strcls)), guide = F) +
  scale_shape_manual(values = c(25)) +
  theme_void(base_family = 'serif', base_size = 14) + 
  theme(
    legend.position = c(0.5, 1.04), 
    plot.margin = grid::unit(c(7, 0, 0, 0), units = 'pt'),
    legend.title = element_blank()
  )
expscr <- relscr %>% 
  filter(perf %in% 'expected')
p5<- ggplot(expscr) +
  geom_point(aes(x = long, y = lat, fill = strcls, shape = perf)) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() + 
  scale_fill_manual(values = pal_exp(levels(caliexp$strcls)), guide = F) +
  scale_shape_manual(values = c(21)) +
  theme_void(base_family = 'serif', base_size = 14) + 
  theme(
    legend.position = c(0.5, 1.04), 
    plot.margin = grid::unit(c(7, 0, 0, 0), units = 'pt'), 
    legend.title = element_blank()
  )
ovrscr <- relscr %>% 
  filter(perf %in% 'over scoring')
p6<- ggplot(ovrscr) +
  geom_point(aes(x = long, y = lat, fill = strcls, shape = perf)) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() + 
  scale_fill_manual(values = pal_exp(levels(caliexp$strcls)), guide = F) +
  scale_shape_manual(values = c(24)) +
  theme_void(base_family = 'serif', base_size = 14) + 
  theme(
    legend.position = c(0.5, 1.04), 
    plot.margin = grid::unit(c(7, 0, 0, 0), units = 'pt'),
    legend.title = element_blank()
  )

png('figs/calires.png', height = 8.05, width = 8.5, units = 'in', res = 400, family = 'serif')
grid.arrange(
  arrangeGrob(p1, p2, p3, ncol = 3, top = textGrob('(a) Calibration sites, median CSCI predictions, and reach class\n\n', hjust = 0.98)),
  arrangeGrob(p4, p5, p6, ncol = 3, top = textGrob('(b) Relative CSCI scores from reach classes\n', hjust = 1.4)),
  ncol = 1, heights = c(1.11, 1)
)
dev.off()

```
```{r calires, fig.cap = "Statewide application of landscape models showing (a) the calibration data stratified by ecoregion and imperviousness (top left), median predicted CSCI scores for each stream reach (top center), stream reach classifications (top right), and (b) relative site scores based on observed CSCI (Figure \\@ref(fig:calimap)) and reach class.  Relative scores are over-scoring, as expected, or under-scoring based on the observed score for the reach classification. Colors in (b) correspond to the stream reach classifications on the top right."}
knitr::include_graphics('figs/calires.png')
```

### Case study

* Extent, classification, prioritization

* Relationships with environmental variables for constrained/unconstrained locations. Maybe apply to hardened/non-hardened reaches in constrained locations. 

*Figure* Summary of extent of reach classification, site performance, selected examples

```{r pritem, fig.height = 4.75, fig.width = 7, fig.cap = 'Template provided to stakeholders for priorization of recommended actions for each stream type.  The reach types (Table \\@ref(tab:typetab)) relate to the stream class for the biological expectation (likely unconstrained, possibly unconstrained, possibly constrained, likely constrained), relative site score for the observed CSCI (over scoring, expected, under scoring), and location of the score relative to a hypothetical biological threshold (dashed line, above or below).  Horizontal lines are the range of expected CSCI score for a site with tick marks for the median. Priority actions defined by stakeholders are shown on the right for each stream type. Actions are generalized as investigate, protect, or monitor as high (H), medium (M), or low (L) priority.  Blank cells indicate that no additional measures are recommended beyond the baseline monitoring and maintenance practiced at all sites.'}
sts <- paste('Site', seq(1:16))

# example data, csci scores
scrs_ex <- data.frame(
  Site = factor(sts, levels = sts),
  csci = c(1.25, 0.98, 0.81, 0.68, 1.14, 0.87, 0.73, 0.58, 0.98, 0.83, 0.68, 0.5, 0.88, 0.76, 0.57, 0.39)
)

# example data, stream predictions
exps_ex <- data.frame(
  Site = factor(sts, levels = sts),
  minv = rep(c(0.84, 0.68, 0.58, 0.43), each = 4),
  maxv = rep(c(1.14, 0.98, 0.88, 0.73), each = 4),
  stringsAsFactors = F
) %>% 
  mutate(medv = ((maxv - minv) / 2) + minv)

# calculate class, performance, type, 
plot_ex <- proc_all(exps_ex, scrs_ex, thrsh = 0.79, tails = 0.05) %>% 
  rename(
    `Stream\nclass` = `Stream class`
  ) 

# priorities
pritab <- tibble(
  Type = seq(1:length(sts)),
  Investigate = c(rep(c('H', '', 'H', 'H'), 2), rep(c('M', 'M', '', 'M'), 2)),
  Protect = c(rep(c('H', 'M', 'M', ''), 2), rep(c('H', '', '', ''), 2)),
  Restore = c(rep(c('', '', 'M', 'H'), 2), rep(c('', 'L', 'L', 'L'), 2))
  ) %>% 
  gather('action', 'priority', -Type)

mythm <- theme_minimal(base_family = 'serif', base_size = 12) +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.line.x = element_line(), 
    axis.line.y = element_line(), 
    axis.ticks.y = element_line(), 
    axis.text.x = element_blank(),
    legend.position = 'top',
    plot.margin = grid::unit(c(5.5, 0, 5.5, 5.5), units = 'pt')
  )

p1 <- ggplot(plot_ex, aes(x = typelv)) + 
  geom_errorbar(aes(ymin = minv, ymax = maxv, colour = `Stream\nclass`), width = 0, size = 2, alpha = 0.2) + 
  geom_errorbar(aes(ymin = minv_qt, ymax = maxv_qt, colour = `Stream\nclass`), width = 0, size = 2, alpha = 0.7) + 
  geom_point(aes(y = medv), colour = 'white', size = 0.75, alpha = 0.6, shape = 15) +
  geom_point(aes(y  = `CSCI score`, fill = `Stream\nclass`, shape = perf), size = 4, alpha = 0.8) +
  geom_hline(yintercept = 0.79, linetype = 'dashed') +
  scale_colour_manual('Stream class', values = pal_exp(levels(plot_ex$`Stream\nclass`)), 
                    guide = guide_legend(direction = 'vertical', title.position = 'left', ncol = 2)) +
  scale_fill_manual(values = pal_exp(levels(plot_ex$`Stream\nclass`)), 
                    guide = F) +
  scale_shape_manual('Relative site score', values = c(25, 21, 24)) +
  scale_x_discrete('Reach type', limits = rev(levels(plot_ex$typelv)), labels = rev(c(1:nrow(plot_ex)))) +
  scale_y_continuous('CSCI score') +
  guides(colour = guide_legend(title.position = 'top', ncol = 2), shape = guide_legend(title.position = 'top')) + 
  mythm +
  coord_flip() + 
  ggtitle('')
p1leg <- g_legend(p1)
p1 <- p1 + mythm %+replace% theme(legend.position = 'none')

p2 <- ggplot(pritab, aes(x = Type, y = 1)) +
  geom_text(aes(label = priority), family = 'serif') + 
  facet_wrap(~action) + 
  coord_flip() + 
  scale_x_reverse(breaks = c(1:length(sts)), labels = c(1:length(sts))) + 
  theme(
    panel.background = element_rect(fill = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(family = 'serif', size = 11),
    axis.ticks.x = element_line(color = 'white'),
    axis.text.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(), 
    # axis.text.y = element_text(family = 'serif', size = 12),
    axis.title = element_text(colour = 'white'), 
    plot.margin = grid::unit(c(4, 5.5, 5.5, -3), units = 'pt')
  )

grid.arrange(
  p1leg, 
  arrangeGrob(p1, p2, ncol = 2, widths = c(1, 0.8)), 
  heights = c(0.25, 1)
)
```

### Sensitivity analysis

* Statewide results - reach classification, site performance

* SGR application - where do priorities change related to which variables the model is most sensitive to? Do overall patterns remain? Maybe not do this.

*Table* Sensitivity results

### Unclassified reaches

* Extent of typical ag, typical urban statewide

* Framework for assigning unclassified reach to a class

* Statewide patterns, SGR patterns

*Table* Summary by location

# Discussion

* What is the value of identifying constrained channels?
     * Identification of constrained channels allows us to determine how best to spend limited resources and to focus on reaches where we have a decent chance of improving the biological condition.
     * Use of more data to develop context of assessment
     * Targeted management for desired outcomes
     * Informing decisions about future monitoring (i.e., prioritize future monitoring locations)
     * Listing implications, perhaps with a subheader, "Implications for determining biological impairments". We should enlist Chad to help with this—after presenting him with LACSD’s proposal.

* What is useful about our approach compared to alternatives?
     * Field-based methods to identify constrained channels vs. landscape modelling
     * Related directly to biological condition and regulatory standards
     * Results are widely corraborated by other landscape studies - land use is big determinant of macroinvert assemblage

* What contributed to our success in defining priorities? 
     * Stakeholder involvement guided process, contributed to achieving goals
     * An interactive/iterative approach was used - we provided tools to facilitate (web apps) and we did not assume priorities

* Caveats of our aproach
     * This analysis doesn’t truly tell us if a site can be fixed or if the conditions are truly constrained (key message, need to mention in intro)
     * What do priorities really mean? Depends on your interests, needs, values, etc.
     * Constrained may not always mean constrained - CSCI vs other biological indicators
     * Site-specific approaches are warranted in certain cases
     * Changing certainty or CSCI treshold - mechanistic effects and implications. Don't cook the books. 

* Future work
     * Ability to link with other assessment tools besides CSCI
     * Link with engineered channels study
     * Priorities statewide
     * Application to larger regions possible (national-scale), or how it can be applied in other areas
     
# Supplement

Online application.

# References


