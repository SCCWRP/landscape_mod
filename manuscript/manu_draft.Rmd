---
title: "Prioritizing management goals for stream biological integrity within the developed landscape context"
output: 
  bookdown::word_document2:
    reference_docx: my_styles.docx
bibliography: refs.bib
author: 'Marcus W. Beck (marcusb@sccwrp.org), Raphael D. Mazor (raphaelm@sccwrp.org), Scott Johnson (scott@aquaticbioassay.com), Karin Wisenbaker (karin@aquaticbioassay.com), Joshua Westfall (jwestfall@lacsd.org), Peter R. Ode (peter.ode@wildlife.ca.gov), Ryan Hill (hill.ryan@epa.gov), Chad Loflen (Chad.Loflen@waterboards.ca.gov), Martha Sutula (marthas@sccwrp.org), Eric D. Stein (erics@sccwrp.org)'
urlcolor: blue
link-citations: true
---

```{r setup, echo = F, warning = F, message = F, results = 'hide'}
# figure path, chunk options
knitr::opts_chunk$set(fig.path = 'figs/', warning = F, message = F, echo = F, cache = T, dev.args = list(family = 'serif'), dpi = 300, warning = F, out.width = '100%', cache.path = 'manu_draft_cache/',
  fig.process = function(x) {
  x2 = sub('-\\d+([.][a-z]+)$', '\\1', x)
  if (file.rename(x, x2)) x2 else x
  })

# libraries
library(tidyverse)
library(Hmisc)
library(Jabbrev)
library(gridExtra)
library(sf)
library(maptools)
library(maps)
library(grid)
library(ggrepel)
library(RColorBrewer)
library(ggridges)
library(scales)
library(quantregForest)
library(leaflet)
library(raster)
library(flextable)
library(officer)

# functions (incl. color palettes)
source('../R/funcs.R')

# extract bib entries from online
bib_scrp('manu_draft.Rmd', 'refs.bib')

 # data
load(file = '../data/typetab.RData')
load(file = '../data/csci_raw.RData')
load(file = '../data/ludat.RData')
load(file = '../data/calipsa.RData')
load(file = '../data/psalab.RData')
load(file = '../data/rf_core.RData')
load(file = '../data/sgrlu.RData')
load(file = '../data/shed.RData')
load(file = '../data/spat.RData')
load(file = '../data/scrs.RData')
load(file = '../data/csci_comid.RData')
load(file = '../data/nhdplo.RData')
load(file = '../data/caliclsplo.RData')
load(file = '../data/calicls.RData')
load(file = '../data/caliexp.RData')
load(file = '../data/comid_prd.RData')
load(file = '../data/strclslen.RData')
load(file = '../data/cnstrfrst.RData')
load(file = '../data/sensres.RData')
load(file = '../data/typscrs.RData')
load(file = '../data/sgrclslen.RData')
```

```{r echo = F, cache = F}
raw <- system('git log -1', intern = TRUE)
raw <- raw[grep('^Date', raw)]
raw <- paste('Version', raw)
```
`r raw`

# Abstract 

Stream management goals may be difficult or impossible to achieve where large-scale, historic alteration of the landscape (e.g., urbanization) presents challenges to attaining biological integrity.  We developed a statewide landscape model that provides context for a macroinvertebrate-based bioassessment index by predicting ranges of likely scores that are typical at a site for the observed level of landscape alteration.  With this approach, a relative site score can be identified to evaluate if a site is scoring above, below, or within the range of scores that are expected given the level of unmitigated landscape alteration.  We applied the model at a local scale to classify sites and prioritize different management actions using guidance from a local stakeholder group from the San Gabriel River Regional Monitoring Program (Los Angeles County, California). Stakeholder decisions were facilitated with the Stream Classification and Priority Explorer (SCAPE) tool that compares observed bioassessment scores with expectations from the landscape model to rapidly identify stream segments that are scoring better or worse than expected. Of the 71 sites in the watershed where bioassessment occurred, over half (58%) had biological conditions that were constrained by landscape alteration, of which nine were assigned a medium priority for further investigation by the stakeholder group.  Similarly, 30% of sites were unconstrained and assigned medium or high priorities for enhanced protection or restoration depending on whether a site was scoring better or worse than expected.  We observed model predictions that were consistent with the clear land use gradient from the upper to lower watershed, where limits to achieving biological integrity were more common in the heavily urbanized lower watershed.  Interaction with the local stakeholder group was critical in connecting the landscape model with observed data to help set management goals appropriate for the region.  The availability of geospatial and bioassessment data at the national level suggests that these tools can easily be applied to inform management decisions at other locations where biological indices are used to assess environmental condition.

# Introduction

The widespread use of bioassessment data to assess ecological condition of aquatic environments is a significant advance over chemical or physical methods of assessment, yet managers and stakeholders require contextual information for synthesizing and interpreting biological information.  The reference condition concept that is built into many biological indices is an explicit means of evaluating observed condition relative to unaltered habitats for a particular region [@Reynoldson97;@Stoddard06].  However, in many cases the reference benchmark may not completely describe or account for additional factors that influence biological integrity at spatial and temporal scales that can be effectively managed [@Chessman04;@Chessman14]. A bioassessment index may be difficult to incorporate into management if thresholds for biological objectives are impractical within site-specific conditions.  Use of bioassessment information to guide decisions that affect aquatic resources may also be challenging if the data are not explicable relative to the needs of local stakeholder groups. Explicit information is required to not only synthesize site level bioassessment data at the watershed scale, but also provide an assessment context that is sufficiently interpretable for prioritization. 

The application of bioassessment data to inform management requires understanding the effects of multiple stressors acting at local, catchment, or watershed scales [@Novotny05;@Townsend08;@Leps15]. Nearly half of all stream miles in the USA are estimated to be in poor biotic condition based on macroinvertebrate bioassesssment and the observed condition can be strongly associated with commonly observed in-stream stressors, such as excess phosphorus, nitrogen, or altered physical habitat [@USEPA16]. These immediate and proximate causes of poor biological condition are often linked to landscape-level alterations that occur in the watershed.  Consistent and empirical links between land use thresholds and poor biotic integrity have been identified in many cases [@Allan97;@Wang97;@Clapcott11]. Mechanistic linkages between land use and degraded biological condition have been described (e.g., @Allan04, @Riseng11), but the precise link between land use and instream condition is not clear for other causal pathways (e.g., @Cormier13).  Regardless, land use has long been used as a proxy for environmental condition and an associative link can be sufficient to predict condition as a function of watershed activities. 

In developed urban and agricultural landscapes, the majority of stream miles are in poor biotic condition and in need of some level of management [@USGS99;@Finkenbine00;@Morgan05].  Conventional approaches to protect and restore biological integrity have commonly focused on direct improvements at the site-level to mitigate instream stressors [@Carline07;@Lester08;@Roni12;@Loflen16], whereas upstream preventative measures have been incentivized or enforced through regulation.  Although these approaches can lead to improvements in ecological condition, there is no universal remedy for achieving biological integrity in streams. Restoring streams in urban or agricultural settings can be costly and it may be unreasonable to set regional reference conditions as a restoration target [@Kenney12;@Shoredits13]. A confounding factor for managing streams in developed landscapes is the extensive modification to streams for flood control or water conveyance.  Channel modification has been used as a basis for redefining water quality criteria that is site specific or for re-evaluating use attainability goals.  For example, the Los Angeles River (California, USA) is heavily modified as a concrete-lined channel and recreational uses that apply nationally are suspended under high flow conditions [@CRWQCB14].  Other states have recommended a tiered aquatic life use or alternative use designations to account for baseline shifts in ecosystem condition from environmental modification  [@FLDEP11;@USEPA13;@MBI16].  

Developing an expectation of biological condition as a function of historic and unmitigated alteration of the landscape could help prioritize where management actions are most likely to achieve intended outcomes, or conversely, where landscape alteration could limit management success in achieving biological integrity.  Understanding limits to biological potential is a fundamental concept in bioassessment that has recieved some attention.  Methods for factor-ceiling analysis have been explored in a bioassessment context to characterize environmental factors that limit assemblage composition [@Chessman08;@Chessman14]. This approach is based on the limiting factor theory that proposes the most limiting biotic or abiotic factor as the primary regulator of species abundance and distribution. Similar concepts have been applied in a landscape context to understand both variation in bioassessment data at different spatial scales and limits of bioassessment tools with land use gradients [@Waite13;@Waite14].  Applying these concepts in a predictive framework could facilitate an expectation of bioassessment and management potential relative to a site-specific context. 

The development of modelling tools for understanding biological condition across landscape gradients could provide a powerful approach to informing the use of limited resources to manage stream integrity. Previous modelling efforts for bioassessment have used geospatial data to predict biological condition at regional or national scales [@Volstad04;@Carlisle09;@Brown12;@Hill17], with the general purpose of characterizing condition at unsampled locations. Macroinvertebrate communities can respond predictably to landscape alteration [@Sponseller01;@Waite13] and association of biological condition with landscape metrics that describe these changes could be used to predict a range of expectations for biotic integrity as related to observed watershed development.  This approach could build on previous applications of landscape models by predicting a lower and upper estimate of what bioassessment index scores are likely relative to the landscape, in addition to estimating biological condition at unsampled locations. Once the predicted response of macroinvertebrate communities to landscape changes at large spatial scales are understood, expectations can be compared to field samples and sites can be prioritized by local managers based on deviation from the expectation.
     
The goal of this study is to present the development of a landscape model to classify and prioritize stream monitoring sites and demonstrate its application to estimate the potential of achieving biological integrity in California streams relative to unmitigated landscape alteration. This model is presented as a screening tool for exploring different priorities and is not intended for developing regulatory designations nor determining if a site can attain designated uses. The specific objectives were to 1) demonstrate development of a landscape model to predict expected ranges of biotic condition, 2) classify stream segments into biological constraint categories using modelling expectations, 3) assess the extent of stream classes and explore the sensitivity of the classifications to decision points in the model output, and 4) prioritize potential management decisions by comparing expectations to observed bioassessment scores. The model was developed and applied to all streams and rivers in California, specifically focusing on the potential of urban and agricultural land use to impact biological condition. We include a case study that demonstrates how the statewide model can be used to classify and prioritize in a regional context using guidance from a local stakeholder group from a heavily urbanized watershed. An interactive software tool is also described that was developed to help choose management priorities from the landscape model.

# Methods

## Study area and data sources

The landscape model was developed for California using land use data, stream hydrography, and biological assessments.  California covers 424,000 km$^2$ of land with extreme variation in altitude, geology, and climate (Figure \@ref(fig:calimap)).  Temperate rainforests occur in the north, deserts in the northeast and southeast, and Mediterranean climates in coastal regions.  California's stream network is approximately 280,000 km in length and covers all of the major climate zones in the state. A high degree of endemism and biodiversity occurs in these streams including nearly 4000 species of vascular plants, macroinvertebrates, and vertebrates that depend on fresh water during their life history [@Howard09;@Howard15].  Approximately 30% of streams in California are perennial with the remaining as intermittent or ephemeral.  A large portion of the central region of the state is agricultural (i.e., Central Valley), whereas dense areas of urban development are in the southwest (i.e., Los Angeles and San Diego) and central (San Francisco Bay area) coast areas.  Landscape alteration has been relatively recent, with one estimate showing that developed lands have increased in California by 38% from 1973 to 2000 [@Sleeter11]. Development prior to the late-1990s occurred before requirements in stormwater controls were implemented in California. 

Stream data from the National Hydrography Dataset Plus (NHD-plus) [@McKay12] were used to identify stream segments in California for modelling biological integrity. The NHD-plus is a surface water framework that maps drainage networks and associated features (e.g., streams, lakes, canals, etc.) in the United States. Stream segments designated in the NHD-plus were used as the discrete spatial unit for modelling biological integrity. Here and throughout, "segment" is defined in the context of NHD-Plus flowlines and is not necessarily a strictly defined hydro-geomorphological feature.  Hydrography data were combined with landscape metrics available from the StreamCat Dataset [@Hill16] to estimate land use at the catchment (i.e., nearby landscape flowing directly into a stream segment) and the entire upstream watershed for each segment.  Many of the metrics in StreamCat were derived from the 2006 National Land Cover Database [@Fry11]. 

The California Stream Condition Index (CSCI) [@Mazor16] was used as a measure of biological condition in California streams.  The CSCI is a predictive index of stream condition that compares the observed taxa and metrics at a site to those expected under reference conditions.  Expected values at a site are based on models that estimate the likely macroinvertebrate community in relation to factors that naturally influence biology, e.g., watershed size, elevation, climate, etc. [@Moss87;@Cao07].  The index score at a site can vary from 0 to ~ 1.4, with higher values indicating less deviation from reference state.  Because the index was developed to minimize the influence of natural gradients, the index scores have consistent meaning across the state [@Mazor16]. A CSCI threshold of 0.79 based on the tenth percentile of scores at all reference calibration sites is used to categorize low or high scoring sites and has been used to identify stream degradation by regulatory agencies [@SDWB16].  Benthic macroinvertebrate data were used to calculate 6270 individual CSCI scores at nearly 3400 unique sites between 2000 and 2016.  Field data were collected during base flow conditions typically between May and July following methods in @Ode16.  

## Building and validating the landscape model

A prediction model was developed to estimate likely ranges of CSCI scores associated with urban and agricultural land use gradients, collectively defined as developed landscapes.  Measures of land use development were quantified for riparian, catchment, and watershed areas of each stream segment in California using the StreamCat dataset [@Hill16]. CSCI scores were modelled using estimates of canal/ditch density, imperviousness, road density/crossings, and urban and agricultural land use for each stream segment (Table S1). These variables were chosen specifically to model scores only in relation to potential impacts on biological condition that are typically beyond the scope of management intervention or where costs to mitigate are likely prohibitive.  Potential effects on biological condition that may vary through time or from stressors not associated with urban or agricultural land use were not captured by the model.  Similarly, potential differences in the magnitude of potential effects for the chosen variables were also not explicitly evaluated.  Within these limits, we considered deviation of observed scores from model predictions to be diagnostic of human activity not related to human-related stressors that can be measured on the landscape, in addition to potential model error.  The predictive performance of the models is described below.

Models were developed using quantile regression forests to estimate ranges of likely CSCI scores in different landscapes [@Meinshausen06;@Meinshausen17]. Random forests are an ensemble learning approach to predictive modelling that aggregates information from a large number of regression trees and have been used extensively in bioassessment applications [@Carlisle09;@Chen14;@Mazor16;@Fox17].  Random forest models provide robust predictions by evaluating complex, non-linear relationships and interactions between variables relative to more commonly-used modelling approaches [@Breiman01;@Hastie09].  Quantile models, such as quantile regression forests, evaluate the conditional response across the range of values that are expected, in contrast to conventional models that provide only an estimate of the mean response [@Cade03]. This modelling approach allows use of predictions to describe where bioassessment targets are unlikely to be met or conversely where streams are unlikely to be impacted by placing bounds on the range of expectations relative to unmitigated landscape alteration.  Quantile regression forests were used to predict CSCI scores in each stream segment at five percent intervals (i.e., 5th, 10th, etc.) from the 5th to 95th percentile of expectations. 

We stratified sample data to ensure sufficient representation of landscape gradients in each ecoregion and across percentiles of catchment imperviousness (Figure \@ref(fig:calimap)). Calibration data for the landscape model were obtained from a random selection of 75% of segments with observed CSCI scores across this stratification and where sufficient data were available in StreamCat (n = 1965 segments). The remaining sites were used for model validation (n = 655). Where multiple samples were available at a single site, one was selected at random for both calibration and validation purposes. Model performance was assessed for the statewide dataset and within each major region by comparing differences between observed CSCI scores and median predictions at the same locations.  Differences were evaluated using Pearson correlations and root mean squared errors (RMSE).  Regression analysis between predicted and observed scores was used to assess potential bias based on intercept and slope values differing from 0 and 1, respectively.  Collectively, the performance metrics were chosen to evaluate both predictive ability of the landscape model and potential for bias which may vary depending on different land use gradients across the state.

## Statewide application of the landscape model

We applied the landscape model statewide and in major regions of California to estimate the extent of streams in different constraint classes. Here and throughout, constrained is defined as a biological community that is impacted by large-scale, historic, and unmitigated alteration of the landscape.  Consequently, achieving biological integrity for constrained communities may present management challenges relative to unconstrained communities.  Using the model results, each stream segment was assigned to one of four classes (Table \@ref(tab:clsdef)): 

* Likely unconstrained
* Possibly unconstrained
* Possibly constrained 
* Likely constrained

Classifications were based solely on the intersection of the modelled CSCI expectations at a segment with a chosen CSCI threshold, where expectations could be below, above, or overlapping the threshold.  Two decision points were considered for their importance in defining segment classifications:

1) The selected range of CSCI expectations at a segment from the model(Figure \@ref(fig:ridges)a,b), chosen as the 10th to 90th percentile of model predictions.
2) The CSCI threshold used for comparison with the modelled expectations (Figure \@ref(fig:ridges)), chosen as 0.79 following previous examples [@Mazor16].  

Stream segments with the range of CSCI score expectations entirely below the threshold were considered likely constrained, whereas those with expectations entirely above were considered likely unconstrained.  Segments with score expectations that overlapped the CSCI threshold were considered possibly constrained or possibly unconstrained, where distinction between the two was based on location of the median expectation of a segment relative to the threshold (Table \@ref(tab:clsdef)).  

CSCI scores from biomonitoring data were then compared to the stream segment classification to identify a "relative site score" (Figure \@ref(fig:ridges)d).  This comparison is a fundamental product of the landscape model that can be used to evaluate if a site is scoring above, below, or within the range of scores that are expected given the level of landscape alteration. For each of the four segment classifications (likely constrained, possibly constrained, possibly unconstrained, and likely unconstrained), relative site scores were defined based on location to the range of expected CSCI scores. Sites with observed scores above the upper limit of the segment expectation (e.g., above the 90th percentile of expected scores) were considered "over-scoring" and sites below the lower limit (e.g., 10th percentile) were considered "under-scoring".  If neither "over-scoring" nor "under-scoring", the relative site score was considered as "expected" within the context of the landscape model.   

## Landscape factors associated with constraints

Factors explaining variation between constrained and unconstrained stream segments were evaluated for the major regions in California (Figure \@ref(fig:calimap)). Only a select subset of variables in StreamCat were used to develop the landscape model, with the purpose of describing long-term and broad scale constraints on biointegrity.  Additional landscape measures in StreamCat were evaluated to provide additional insight into alternative factors within each region that were associated with constraints on stream integrity.  Landscape and geological data in StreamCat at the riparian and watershed scale were used to model variation among segment classes using random forest models [@Breiman01]. For each region, 1000 regression trees were created and the mean reduction in accuracy was estimated for the exclusion of each variable across all models. This created an estimate of importance of each variable for describing differences between constrained and unconstrained stream classes. Mean reduction in accuracy was estimated for all variables in each model to identify the top five important variables in each region.  The possibly and likely constrained classes were evaluated together, as were the possibly and likely unconstrained classes. However, it was recognized that retaining the possibly or likely classes could be useful to refine the priorities described below. 

## Sensitivity analysis of segment classifications

A sensitivity analysis was conducted to evaluate the influence of key decision points on the extent of segment classifications created by the landscape model.  Stream segment classifications depend on the chosen range of score expectations (or certainty) from the landscape model (Figure  \@ref(fig:ridges)b) and the CSCI threshold for defining low or high scores (Figure \@ref(fig:ridges)c).  The combined effects of changing both the certainty in the model and the CSCI threshold were evaluated to estimate the changes in stream extent in each classification.  Eight different ranges of values for the score expectations from wide to narrow were evaluated at five percent intervals from the 5th-95th to the 45th-55th range of predications (i.e., 5th-95th, 20th-90th, ..., 45th-55th).  Different CSCI thresholds were also evaluated using values of 0.63, 0.79, and 0.92, corresponding to the 1st, 10th, and 30th percentile of scores at reference calibration sites used to develop the CSCI index [@Mazor16].  The percentage of stream segements in each class statewide and by major regions were estimated for each of twenty-four scenarios (width by threshold combinations) to evaluate sensitivity to changes in the decision points.

## Defining management priorities in the San Gabriel River watershed 

A framework for identifying site priorities for management actions using results from the landscape model was developed through engagement with a local stakeholder group. The San Gabriel River (SGR) Regional Monitoring Program (Los Angeles County, California) includes stakeholders from water quality regulatory agencies, municipalities, and non-govermental organizations that cooperatively work to manage aquatic resources in the watershed and improve coordination of compliance and ambient monitoring efforts. The workgroup met monthly over a six-month period to discuss model application and to refine the interpretation of results.

A strong land-use gradient occurs in the SGR watershed that creates challenges for managing stream condition (Figure \@ref(fig:sgrshd)a). Headwaters begin in the San Gabriel mountains where the land is primarily undeveloped or protected for recreational use, whereas the lower watershed is in a heavily urbanized region of Los Angeles County.  The SGR is dammed at four locations for flood control in the upper watershed. Spreading grounds are present in the middle of the watershed for groundwater recharge during high flow. As a result, the upper and lower watersheds are hydrologically disconnected when annual rainfall is normal. Nearly all of the stream segments in the lower half of the watershed are channelized with concrete or other reinforcements. The majority of flow in the lower watershed is provided to San Jose Creek, Coyote Creek, and the mainstem of the SGR by wastewater treatment plants releasing tertiary treated effluent. Approximately half of the monitored sites in the watershed are in poor biological condition, all of which are in the lower watershed.  

Pioritizing among the many sites that require some management intervention was a critical objective of the stakeholder group in applying the landscape model. The stakeholder group identified priorities in the watershed by first describing the types of management actions that were desired. Stakeholders identified their relevant priorities by evaluating the different site types that were possible from the landscape model relative to the stream class (under-scoring, expected, over-scoring for each of four segment classes).  The priorities were also defined by considering if an observed CSCI score at a site was above or below a potential biological threshold (e.g., CSCI of 0.79), in addition to the scoring expectation for the stream class (Table \@ref(tab:typetab)).  To facilitate the process, a template was used that showed the site scores relative to the segment classifications (Figure S3, left side).  The priorities defined by the group were generalized into three categories:

* Investigate:  Suggest additional monitoring or review of supplementary data (e.g., field visits, review aerial imagery) to characterize why a site is scoring above or below an expectation, or above or below a biological objective given the expectation;
* Protect: Require additional scrutiny of any proposed development and/or projects for sites that score above the expectation; 
* Restore: Pursue targeted action for causal assessment and/or restoration activity for sites that score below the expectation.  

One to many priorities were assigned as low, medium, or high priorities for the scoring possibilities that could occur at a site.  The assignments were also made with the explicit recognition that any priority recommendations were in addition to baseline monitoring and maintenance that is currently provided by existing management programs [@SWAMP17].

The interactive and online Stream Classification and Priority Explorer (SCAPE) tool was created for the stakeholder group to facilitate the recommendation of management actions for each site type (Figure S1, [http://shiny.sccwrp.org/scape/](http://shiny.sccwrp.org/scape/))[@Beck18c].  This application provided maps of the extent and type of classification for segments in the watershed, deviation of observed CSCI scores from the expectation, and maps of recommended priority actions that were assigned to each of the scoring possibilities.  The SCAPE tool also allowed the stakeholders to modify key decision points in the model (i.e., range of expectations that were used from the model, selected biological threshold) to evaluate how these changes propogated to changes in recommended priorities for each site.

# Results

## Model performance

The landscape model was used to predict an expected range of CSCI scores for `r nrow(comid_prd)` stream segments in California.  The bioassessment dataset used to develop the model included `r sum(csci_comid$SelectedSample %in% 'Selected')` unique field observations assigned to stream segments in the NHD-plus dataset. Model performance statewide indicated generally good agreement between observed CSCI scores and the median prediction for the associated stream segment (Table S2).  Agreement between observed and predicted values for the entire calibration dataset was r = 0.75 (Pearson) and RMSE = 0.17.  The intercept and slope for a regression between observed and predicted values were 0.34 and 0.60, suggesting a slight negative bias of predictions at lower scores and slight positive bias at higher scores.  The statewide validation data showed similar results, with slightly smaller correlation (r = 0.72) and larger RMSE (0.18) estimates.  

The landscape model performed well in regions with a mix of urban, agricultural, and open land, such as the South Coast, where strong gradients occur in many watersheds. Conversely, the model did not perform well in regions where developed landscapes were less common, such as the Sierra Nevada region. Model performance was best in regions wih extensive urban development. Performance for the Chaparral and South Coast regions were comparable or slightly improved compared to the statewide dataset for both the calibration and validation datasets. Model predictions for the Central Valley, Desert Modoc, and North Coast regions had slightly lower performance compared to the statewide results, with correlations of approximately 0.57 with observed values in the calibration dataset and 0.53 in the validation dataset.  Model performance was weakest for the Sierra Nevada region, where timber harvesting, rather than urban or agricultural development, is the most widespread stressor. Overall, model performance was strongly associated with land use gradients in each region (Figure S2).  

## Statewide patterns 

Statewide patterns in stream constraints were apparent from the results of the landscape model that were consistent with land use (Figure \@ref(fig:calires)).  A majority of stream segments statewide were classified as possibly constrained (11% of all stream length) or possibly unconstrained (46%), whereas a minority were likely constrained (4%) or likely unconstrained (39%) (Table \@ref(tab:clstot)). Large rivers across the state were more commonly classified as possibly constrained (e.g., Klamath, Sacramento, Colorado rivers).  By region, the most segments classified as likely unconstrained were in the Sierra Nevada (50%), North Coast (46%), and Desert Modoc (46%) regions, whereas the most segments as likely constrained were observed in the Central Valley (22%) and South Coast (15%) regions.  Overall, stream segments were more often constrained for biotic integrity in regions with more development, either as urban or agricultural land.  For example, likely constrained segments were apparent from the statewide map in coastal areas of the South Coast where heavy urbanization occurs and in the Central Valley where agriculture is the dominant land use.  Stream segments were more likely to be unconstrained in regions with less development, with areas in the North Coast and the Sierra Nevada region visible on the map (right, Figure \@ref(fig:calires)). Relative CSCI scores compared to segment expectations were as expected for 80% of the sampled locations statewide, whereas a much smaller percentage of sites were equally under or over scoring (Table \@ref(tab:reltot)).  Similar patterns were observed within regions, although a slightly larger percentage of sites in the Central Valley were under scoring compared to the other regions.  

## Associated drivers of biological constraints and sensitivity analysis

Importance measures from random forest models identified key variables that were associated with differences between constrained and unconstrained segments between each region (Figure S4, see Figure S5 for importance measures of the selected measures in the statewide landscape model).  Relative magnitudes of the importance measures between regions confirmed the estimates of model performance, such that regions where the model performed well (e.g., South Coast, Central Valley) had higher importance measures than those where the model did not perform well (e.g., North Coast, Sierra Nevada).  The top five most important variables were similar between regions although some specific differences were observed.  The amount of biological nitrogen fixation in watershed soils was ranked the most important variable for the Central Valley, Desert Modoc, and Chaparral region, second most important for the North Coast, and third most important for the Sierra Nevada region.  This variable was not in the top five for the South Coast region, which was exclusively described by imperviousness and urbanization. Soil erodibility was the most important variable in the Sierra Nevada region.  Other important variables that were shared between regions (excluding the South Coast) were fertilizer applications and the amount of crops and hay at the riparian and watershed scale.

Sensitivity analyses underscored the potential impact of key decision points of the landscape model on estimates of the extent of streams in each class (Figure \@ref(fig:sensplo)). Decreasing the certainty of predictions from the landscape model by choosing a narrower range of scores (5th/95th to 45th/55th at 5% intervals) increased the number of streams from the possible to likely category in both constrained and unconstrained segments.  Similarly, changing the CSCI threshold from relaxed to more conservative (0.63, 0.79, 0.92) increased the number of streams classified as possibly or likely constrained and decreased the number of streams as possibly or likely unconstrained.  Changes by region with the different scenarios were also observed.  For example, over 80% of segments in the Central Valley were classified as likely constrained using a conservative CSCI threshold with low certainty of predictions, whereas less than 1% of segments were in this category using a relaxed CSCI threshold with the highest level of certainty.  Opposite trends were observed in regions with reduced land use pressures.  For example, almost all stream segments in the North Coast and Sierra Nevada regions were classified as likely unconstrained using a relaxed CSCI threshold and low certainty of predictions.

## San Gabriel River Case study

```{r}
##
# ggplot of sgr site expecations, relative scores

# requires spat, scrs

thrsh <- 0.79; tails <- 0.1

##
# get biological condition expectations
cls <- getcls2(spat, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  mutate(COMID = as.character(COMID)) 

# get csci difference
sgrscrs <- spat %>% 
  dplyr::select(COMID, core0.50) %>% 
  mutate(COMID = as.character(COMID)) %>% 
  left_join(scrs, ., by = 'COMID') %>% 
  group_by(COMID, StationCode, lat, long) %>% 
  summarise(
    csci = mean(csci, na.rm = TRUE)
  ) %>% 
  ungroup %>%
  left_join(cls, by = 'COMID')

clslen <- sgrclslen %>% 
  dplyr::select(-lens) %>% 
  spread(strcls, lenper)

```

Engagement of stakeholders from the SGR Regional Monitoring Program demonstrated how management actions can be prioritized through application of the landscape model.  About 750 segments in the SGR watershed were identified and classified from NHD-plus, of which 10% were visited over a ten-year period for bioassessment sampling.  CSCI scores ranged from `r round(min(sgrscrs$csci), 2)` to `r round(max(sgrscrs$csci), 2)` consistent with heavy urban development in the lower watershed and open land use at higher elevation in the upper watershed (Figure \@ref(fig:sgrshd)a).  Application of the landscape model results to the CSCI scores provided a context of expectations consistent with the strong land use gradient in the watershed (Figure \@ref(fig:sgrresplo)).  Stream segments in the upper watershed were a mix of likely and possibly unconstrained (`r clslen[['likely unconstrained']]`% and `r clslen[['possibly unconstrained']]`%), whereas stream segments in the lower watershed were classified as likely and possibly constrained (`r clslen[['likely constrained']]`% and `r clslen[['possibly constrained']]`%).  Several segments in the lower watershed had ranges that were right-skewed toward very low CSCI scores consistent with extreme landscape pressures (bottom left, Figure \@ref(fig:sgrresplo)b).

Using a CSCI threshold based on the 10th percentile of reference calibration sites (i.e., 0.79, @Mazor16) and a relatively wide range of expected scores from the 10th to the 90th percentile of the model predictions, only six sites were under-scoring (two likely unconstrained and four likely constrained) and eight sites were over-scoring (five likely constrained, one possibly unconstrained, and two likely unconstrained) (top, Figure \@ref(fig:sgrresmap)).  One of the under-scoring sites in the likely unconstrained class was below the hypothetical CSCI threshold. One site scoring as expected in the possibly unconstrained class was below the chosen CSCI threshold, whereas none of the constrained (possibly or likely) sites were above the threshold. 

In general, the stakeholder group assigned high priority recommendations to over- and under-scoring sites in likely unconstrained segments or those below the biological threshold with possibly unconstrained classification (Figure S3).  Continuing current practices were generally recommended at constrained sites or restoration actions were recommended as a lower priority despite low CSCI scores. Recommended actions to investigate were more common for both over-scoring and under-scoring sites, protect was given a high priority exclusively at over-scoring sites, and restore was more common at under-scoring sites.  A clear distinction between low and high priority actions was observed on the watershed map (bottom, Figure \@ref(fig:sgrresmap)). Sites in the lower watershed were lower priority if an action was recommended, whereas the five high priority sites were in the upper watershed (multiple recommendations were assigned to the sites).  The distinction between lower and higher priorities between the lower and upper watershed was driven exclusively by the segment classifications, where constrained segments were in the lower watershed and unconstrained segments were in the upper watershed. Several sites that were scoring as expected for likely and possibly unconstrained segments in the upper watershed were recommended as medium priority for protection.

# Discussion

The prevalence of degraded stream sites in California requires the use of 1) assessment tools that can accurately evaluate condition, and 2) tools that can provide a context for evaluating assessment tools.  The landscape model was developed to better inform application of the CSCI to inform decision-making in the context of landscape constraints on biological condition.  Statewide development of the tool demonstrated where streams are likely constrained on a regional basis, whereas application to the SGR watershed demonstrated how the tool can be used by local stakeholders to prioritize management actions that are informed by landscape context. Most importantly, this tool does not provide a diagnosis of causes of impairment, nor does it provide an exemption from management intervention if constraints are high.  The landscape model can inform the interpretation of biotic condition and is an exploratory tool that can help identify where management goals are more likely to be achieved. 

Results from our analysis may also be used for managing the biological integrity of streams under state or federal water quality mandates (e.g. "biological objectives" under the Clean Water Act).  Regulatory management involves the protection of those sites meeting biological objectives and the restoration of those sites that do not meet biological objectives.  The selection of appropriate regulatory management actions for streams requires the consideration of the physical and chemical condition of streams concurrent with biological monitoring results.  The landscape model could be used to evaluate sites that are or are not meeting biological objectives relative to their modeled condition.  This could be used to guide and provide flexibility in the selection of regulatory actions at specific sites or watershed scales (e.g., hydrologic subareas), and to further prioritize where and when actions should take place based on the time and spatial scale needed for protection or restoration actions.  For example, for sites that meet biological objectives but where the models predict they can or should not (e.g., Figure S3, segment types 5, 9, 10, or 13), regulatory actions may be associated with protecting that condition and should be implemented in the short-term to prevent degradation.  This flexibility is not to exclude sites from consideration that are less likely to achieve biological objectives, but rather to facilitate the decision-making process through a more transparent application of the model in a regulatory context.

## The landscape model is a tool for exploring options

The primary objective of developing the landscape model was to provide a screening tool for exploring biological constraints to facilitate a discussion of management options relative to site contexts.  These models are not intended for developing regulatory designations for individual sites, nor are they sufficient by themselves to assess whether a site can attain a particular use. Instead, they can help identify patterns among monitoring sites where more intensive analyses may be appropriate. This application was effectively demonstrated through engagement of our local stakeholder group.  Rather than identifying individual sites in need of specific management actions, the group used the landscape model to characterize patterns on the landscape that were consistent with the recommended managagment priorities.  In doing so, the group was able to synthesize a large volume of bioassessment data to explore potential management actions relative to the landscape contexts of the watershed.

The ability of the landscape model to predict the range of expected biological condition at a given site reflects an associative link between present land use and stream biology.  A relatively low expected range of CSCI scores is an indication that stressors originating from the landscape may have imposed habitat limits that constrain biology.  From a regulatory perspective, many states, including California, have explicit biological assessment requirements which are often interpreted in the context of land use.  The use of biological endpoints in the landscape model will likely facilitate the implementation of biological standards as noted above.  Landscape models could also be used to support conservation planning, particularly at the watershed scale where land use can be a critical factor for decision-making.  Ongoing work in California has focused on setting priorities for managing biodiversity that focus on watersheds within a conservation network [@Howard18].  Results from the landscape model could be used to enhance this network by providing supporting information on constraints in an assessment framework. 

Our approach to predict biological condition using landscape constraints also has advantages over other methods that define constraints based only on channel modification.  Several states have recommended alternative use designations for applying bioassessment criteria in modified channels [@FLDEP11;@USEPA13;@MBI16].  Our results generally support this approach, although defining constraints based only on channel modification may be insufficient. Physical habitat quality can be limited in engineered channels and our models identified many of these locations in our case study.  However, these channels were identified as biologically constrained based on landscape characteristics. Constrained channels in rural landscapes (e.g., the mainstem of the Klamath and Russian rivers in the North Coast region) were also identified by the model, as well as many streams in agricultural areas (e.g., Salinas River).  The ability of the model to identify these locations was not accidental given the landscape variables that were used to develop the bioassessment predictions.  In the context of the model, a constrained channel may or may not be engineered, but an engineered channel will typically be classified as constrained given the surrounding land use.  Modified channels may also be present in undeveloped landscapes and high bioassessment scores have been observed in armoured streams within national forest lands [@Stein13]. A classification framework for biological constraints using only channel modification would provide incomplete information relative to an approach using landscape information. These results are well supported by other landscape studies, particularly for macroinvertebrates [@May15].

The utility of landscape models in supporting watershed management has applications outside of California. Our use of national geospatial datasets (i.e., NHDPlus, @McKay12; StreamCat, @Hill16) means that these methods could be applied elsewhere in diverse bioassessment contexts. The CSCI was developed for macroinvertebrate assessment in California, but this approach could be applied with other methods, such as a multi-metric index (the most common bioassessment approach within the US; @Buss14), O/E assessments [@Moss87], biological condition gradients [@Davies06], or with other biological endpoints (e.g., fish or diatoms). In addition, extension of the landscape model could be explored to develop a national scale product of constraints on biological condition to complement recent work that predicted probable biological conditions with the National Rivers and Streams Assessment [@Hill17].  

Extension of the landscape models beyond California should also consider landscape stressors that are predictive of biotic condition in other regions. For example, urban and agricultural gradients were sufficient to characterize constraints in many regions of California, whereas @Hill17 found that the volume of water stored by dams was an important predictor of biological condition in the Northern Appalachian and Northern Plains regions of the US. In their paper, @Hill17 provided an example of how predictive models could be used to identify potential sites for restoration or conservation, however, their illustration did not explicitly identify sites that were over- or under-scoring relative to a biological endpoint. Doing so in California provided stakeholders with important context that helped establish management priorities, demonstrating the potential utility of this approach in other states.

# Model assumptions and limitations

There are several characteristics of the landscape model that could affect its performance when applied outside of urban and agricultural settings.  First, the model was developed with a focus on the needs of managers that apply bioassessment tools in developed landscapes.  As such, landscape variables were chosen to capture the effects of development on CSCI scores in these areas (Table S1). This could lead to erroneous conclusions in regions where different stressors have strong impacts on stream condition.  For example, our results suggest that streams in the North Coast and Sierra Nevada regions are largely unconstrained, but model performance was poor in these areas.  The dominant stressors likely to affect stream condition in these regions originate from sources that are less common in developed landscapes, e.g., silviculture, cannabis cultivation, water extraction, and hydrologic alteration.  The current landscape model does not adequately capture these impacts outside of urban and agricultural environments. Moreover, poor model performance is compounded by relatively poor performance of the CSCI to capture relevant stressor gradients in these regions [@Mazor16]. Accurate data for quantifying these potential stressors are much less readily available, but this is an area where investments in improving spatial data could yield significant improvements in both the CSCI and the landscape model.  
 
An additional assumption is that the landscape model and the CSCI can adequately discriminate between intractable constraints on biology that are spatially and temporally pervasive relative to more tractable constraints.  This assumption applies to any stressor gradient that could be used to develop the model.  For example, our model adequately described urban constraints but there was no context for temporal or spatial scales that have management relevance.  Pervasive and profound alteration to groundwater and hydrology is common in highly developed areas and stream communities may not ever be able to be restored to reference conditions even in the most extreme management interventions.  Similar conditions likely exist for other land use gradients.  For example, a landscape model developed to describe constraints from timber harvesting practices may not provide adequate information on the long-term impacts of siltation on stream integrity if the input data does not describe these impacts at spatial and temporal scales that are relevant for management.  The potential legacy impacts of large-scale alterations of the natural environment are not well-captured by the current model, neither from a spatial nor temporal perspective.  Our analysis of landscape factors associated with constraints using additional StreamCat variables provided a preliminary means of addressing this concern (Figure S4), although a more refined application of the landscape model would be necessary to evaluate different scales of impact.  This could include developing separate models for each region, as well as more careful selection of model inputs to capture scales of interest for potential impacts on stream condition.

The landscape model is associative by design and does not identify mechanistic links between biological constraints and proximal causes.  The model describes constraints at scales larger than instream characteristics as a necessary approach to accurately predict bioassessment scores.  More comprehensive assessments at individual sites are needed to diagnose the immediate causes of degraded condition.  Further, a distinction between constraints on biological condition and channel modification is implicit such that indication of the former by the model does not explicitly indicate presence of the latter.  As noted above, our results consistently indicated that engineered channels are biologically constrained, but the model is based on an a priori selection of land use variables to predict biotic integrity.  A correspondence between habitat limitations and channel modification is likely in many cases but data are insufficient to evaluate biological effects statewide relative to land use constraints.  Moreover, bioassessment scores can be similar in modified channels compared to natural streams independent of watershed land use, i.e., concordance between degraded stream condition and channel modification may not always be observed [@Stein13].       

An additional consideration in using the landscape model is the meaning of biologically constrained in the context of macroinvertebrate communities.  Biologically constrained sites were considered those where present landscapes were likely to limit the bioassessment index and a constrained site is relative to the CSCI. In many cases, poor biotic condition of the macroinvertebrate community translates to poor stream condition.  However, a constrained macroinvertebrate community does not always mean other biological attributes of stream condition (e.g., fish assemblages) are also constrained.  Many urban streams can support diverse algal assemblages such that algal-based measures of biotic condition may alternatively suggest good biotic condition relative to macroinvertebrate-based indices. The focus of the landscape model on a specific taxa is not unique to other bioassessment tools and application to other taxa as alternative lines of evidence is needed for a more complete condition assessment.

## Engagement of local stakeholders is critical for regional application

Application of the landscape model to define potential management actions was effectively tested with stakeholders from the SGR Regional Monitoring Program.  The final decision by the group to prioritize management actions for the different sites in broad categories of protect, restore, and investigate was based on an iterative process where ideas were discussed and shared freely among stakeholders. This approach ensured that stakeholders were generally in agreement with the final product and, therefore, more likely to adopt the recommendations provided by these tools in formal decision-making. The recommended actions have relevance only in the context of interests of the SGR Regional Monitoring Program. Localized applications of the statewide model must engage stakeholders in a similar process to develop recommendations that are specific to regional needs.  

The development of the SCAPE tool was also critical for engaging the stakeholder group.  The tool was developed to achieve the dual purposes of demonstrating concepts applied by the model and allowing stakeholders to iteratively evaluate scenarios for defining stream classifications and priorities. The tool provided a means of demonstrating core concepts of the landscape model and allowed stakeholders to explore the key decision points that affect the model output, specifically related to changing certainties in the CSCI score predictions and the ability to explore alternative thresholds for biological objectives.  This functionality allowed the stakeholders to develop recommendations that were completely independent of the model, i.e., decisions were not hard-wired into the model nor SCAPE. Because of this tool, this stakeholder group has a better understanding of the potential impacts of biointegrity policies currently under review in California.  Additionally, the SCAPE tool provided assurance to the prioritization process by correctly identifying sites where dicrepancies between CSCI scores and other measures of stream condition had been observed. The SCAPE tool prioritized a site for restoration in the upper watershed that was unconstrained and under-performing. This confirmed a discrepancy identified by the stakeholders where good physical habitat conditions were observed from field visits, but the observed CSCI score was below the chosen threshold.  As such, application of the landscape modelling approach to other regions will benefit from similar tools that actively engage managers with bioassessment data.

## Summary

The landscape model can be used to characterize the extent of biologically constrained channels in urban and agricultural landscapes.  Our application to the SGR watershed demonstrated how the results of the model can be used at a spatial scale where many management decisions are implemented through close interaction with a regional stakeholder group with direct interests in the local resources.  Overall, the model provides a tool to determine how managers can best prioritize limited resources for stream management by focusing on segments where recommended actions are most likely to have the intended outcome of improving or protecting biological condition.  The approach also leverages information from multiple sources to develop a context for biological assessment that provides an expectation of what is likely to be achieved based on current land use development. This can facilitate more targeted management actions that vary depending on the identified context and can also inform decisions on extent and effort for future monitoring locations.   

# Supplement

The SCAPE model application website: [http://shiny.sccwrp.org/scape/](http://shiny.sccwrp.org/scape/), full source code accessible at @Beck18c.

# Figures

```{r calimap, fig.height = 5, fig.width = 7, fig.cap = 'Urban and agricultural land use (left) and distribution of observed stream CSCI scores (right) in California. Cover of urban and agricultural land use in stream watersheds was used to develop a landscape model for stream segment expectations of bioassessment scores.  Breakpoints for CSCI scores in the right plot are the 1st, 10th, and 30th percentile of scores at least-disturbed, reference sites throughout the state.  Altered and intact refers to biological condition [@Mazor16]. Grey lines are major environmental regions in California defined by ecoregional and watershed boundaries, CV: Central Valley, CH: Chaparral, DM: Deserts and Modoc Plateau, NC: North Coast, SN: Sierra Nevada, SC: South Coast.'}

lucol <- c('grey80', 'grey45')

# country base
country <- map_data('state')

# state base
calista <- map_data('state', region = 'california')

# csci seq for color pal
palseq <- range(csci_raw$CSCI, na.rm = T) 
palseq <- seq(palseq[1], palseq[2], length = 5)

# psa data fortified
psadat <- calipsa %>% 
  as('Spatial') %>%
  as.data.frame %>% 
  rownames_to_column('id') %>% 
  dplyr::select(id, PSA6) %>% 
  dplyr::rename(PSA = PSA6) %>% 
  mutate(Region = factor(PSA, 
                         levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
                         labels = c('CV', 'Ch', 'DM', 'NC', 'SN', 'SC')
  ))
psafrt <- calipsa %>% 
  dplyr::select(-PSA_REGION, -AREA, -PERIMETER, -PSA8) %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(psadat, by = 'id')

# psalab
psalab <- psalab %>% 
  mutate(
    lat = ifelse(Region == 'CV', 37.26575, lat), # fiddle with locs
    long = ifelse(Region == 'CV', -120.6, long),
    lat = ifelse(Region == 'CH', 36, lat),
    long = ifelse(Region == 'CH', -121, long),
    Region = as.character(Region),
    Region = paste0('bold(', Region, ')')
  )

# land use data fortified  
toplo <- ludat %>% 
  as('Spatial') %>% 
  fortify %>% 
  filter(id %in% c(2, 3)) %>% 
  mutate(id = factor(id, levels = c(2, 3), labels = c('Agriculture', 'Urban'))) %>% 
  dplyr::rename(`Land use` = id)

# csci_raw with percentile ref categories
csci_raw <- csci_raw %>% 
  mutate(
    CSCI = cut(CSCI, 
                   breaks = c(-Inf, 0.63, 0.79, 0.92, Inf), 
                   labels = c('< 0.63', '0.63 - 0.79', '0.79 - 0.92', '> 30^{th}')
                   )
  ) %>% 
  filter(!is.na(CSCI))
  
# legend labels for csci categories in p2
leglab <- list(
  expression(paste('<1' ^ 'st', ': Very likely altered')),
  expression(paste('1'^'st', ' to 10'^'th',': Likely altered')),
  expression(paste('10'^'th', ' to 30'^'th',': Possibly altered')),
  expression(paste('>30'^'th',': Likely intact'))
)

p1 <- ggplot() + 
  geom_polygon(data = toplo, aes(x = long, y = lat, fill = `Land use`, group = group)) + 
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.7), size = 0.1) +
  geom_polygon(data = calista, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.7))

# text with outline magic
theta <- seq(pi/8, 2*pi, length.out=16)
xo <- diff(range(psalab$long))/200
yo <- diff(range(psalab$lat))/200
for(i in theta) {
  p1 <- p1 + geom_text_repel(data = psalab, 
                             aes_q(x = bquote(long +.(cos(i)*xo)),
                                   y = bquote(lat +.(sin(i)*yo)),
                                   label = ~Region), point.padding = NA, parse = T, family = 'serif', size = 6.5, colour = 'black')
  
}
p1 <- p1 +
  geom_text_repel(data = psalab, aes(x = long, y = lat, label = Region), point.padding = NA, parse = T, family = 'serif', size = 6.5, colour = 'white') + 
  coord_map() + 
  scale_fill_manual(values = lucol) +
  theme_void(base_family = 'serif') + 
  theme(
    legend.position = 'top'
  ) + 
  guides(fill = guide_legend(ncol = 1)) +
  ggsn::scalebar(location = 'bottomleft', y.min = 33, y.max = 35, x.min = -124, x.max = -120, 
                 dist = 150, st.dist=.15, st.size = 3, height = 0.1, dd2km = T, model = 'WGS84')

p2 <- ggplot(csci_raw, aes(x = Longitude, y = Latitude, colour = CSCI)) +
  scale_colour_manual(
    values = pal(seq(0, 1.4, length = 4)), 
    labels = leglab
    ) +
  geom_point(size = 1.25, alpha = 0.7) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.1, colour = scales::alpha('black', 0.5)) +
  geom_polygon(data = calista, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.5)) +
  coord_map() + 
  theme_void(base_family = 'serif') + 
  theme(legend.position = 'top') +
  guides(colour = guide_legend(ncol = 2))

pinset <- ggplot(country, aes(x = long, y = lat, group = group)) +
  geom_polygon( fill = NA, color = "black", size = 0.3) +
  geom_polygon(data = calista, fill = 'black', color = "black", size = 0.3)+
  coord_map() +
  theme_void() 

grid.newpage()
v1 <- viewport(width = 1, height = 1, x = 0.3, y = 0.5) 
v2 <- viewport(width = 1, height = 1, x = 0.7, y = 0.5) 
v3 <- viewport(width = 0.25, height = 0.25, x = 0.85, y = 0.65)

# png('figs/calimap.png', height = 5, width = 7, units = 'in', res = 300, family = 'serif')
print(p1, vp = v1) 
print(p2, vp = v2)
print(pinset, vp = v3)
# dev.off()
```

```{r sgrshd, fig.height = 8, fig.width = 6, fig.cap = 'San Gabriel River watershed in southern California. Land cover is shown in plot (a) and the predicted median CSCI scores at each stream segment and observed CSCI scores are shown in (b). The upper watershed is largely undeveloped, whereas the lower watershed is heavily urbanized.'}

# land use raster data
luplo <- sgrlu %>% 
  rasterToPoints %>% 
  data.frame %>% 
  dplyr::rename(`Land cover` = layer) %>% 
  mutate(`Land cover` = factor(`Land cover`, levels = c(5, 4, 3, 2, 1), labels = c('Urban: hi', 'Urban: md', 'Urban: lo', 'Open: forest', 'Open: chaparral'))) 

# hydrolines
spatdat <- spat %>% 
  dplyr::select(COMID, core0.50) %>% 
  mutate(id = as.character(1:nrow(.)))
st_geometry(spatdat) <- NULL
spatfrt <- spat %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(spatdat, by = 'id') %>% 
  mutate(COMID = as.character(COMID)) %>% 
  left_join(scrs, by = 'COMID') %>% 
  mutate(csci_diff = csci - core0.50) %>% 
  filter(!is.na(core0.50))

# wshed boundary fortified
shedfrt <- shed %>% 
  as('Spatial') %>% 
  fortify 

# land use colors
lucol <- c('grey20', 'grey40', 'grey60', 'khaki3', 'khaki2')

# psa data fortified
psadat <- calipsa %>% 
  as('Spatial') %>% 
  as.data.frame %>% 
  rownames_to_column('id') %>% 
  dplyr::select(id, PSA6) %>% 
  dplyr::rename(PSA = PSA6) %>% 
  mutate(Region = factor(PSA, 
    levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
    labels = c('CV', 'Ch', 'DM', 'NC', 'SN', 'SC')
    ))
psafrt <- calipsa %>% 
  dplyr::select(-PSA_REGION, -AREA, -PERIMETER, -PSA8) %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(psadat, by = 'id')

palseq <- seq(palseq[1], palseq[2], length = 5)

# pinset
pinset <- ggplot() + 
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.5), size = 0.2) +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'tomato1') +
  theme_minimal() + 
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(), 
    axis.text = element_blank(), 
    axis.title = element_blank()
    ) + 
  coord_map()

# csci seq for color pal
seqcsc <- range(spatfrt$csci, na.rm = T) 
seqcsc <- seq(seqcsc[1], seqcsc[2], length = 5)

# color legend
colleg <- ggplot() +
  geom_point(data = spatfrt, aes(x = long.y, y = lat.y, colour = csci)) +
  theme_bw(base_family = 'serif') +
  theme(
    legend.position = 'top',
    legend.justification = 'left',
    legend.box.just = 'left',
    legend.box = 'vertical'
  ) +
  scale_colour_gradientn('CSCI', colours = pal(seqcsc)) +
  guides(colour = guide_colourbar('CSCI', barheight = 0.55, barwidth = 8, title.position = 'top'))
colleg <- g_legend(colleg)

# separate lu legend
luleg <- ggplot(luplo) + 
  geom_tile(aes(x, y, fill = `Land cover`), alpha=0.8) +
  theme_bw(base_family = 'serif') +
  theme(
    legend.position = 'top', 
    legend.justification = 'left',
    legend.box.just = 'left',
    legend.box = 'vertical'
  ) +  
  scale_fill_manual('Land cover', values = lucol) +
  guides(fill = guide_legend(ncol = 2, title.position = 'top'))
luleg <- g_legend(luleg)
  
# land use plot
p1 <- ggplot(luplo) + 
  geom_tile(aes(x, y, fill = `Land cover`), alpha=0.8) +
  theme_void(base_family = 'serif') +
  scale_fill_manual('Land cover', values = lucol) +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = NA, colour = 'black', alpha = 0.7) +
  coord_equal() +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = 'none', 
    axis.title = element_blank()
    ) +
  ggtitle('(a) Land cover in the San Gabriel watershed')

# hydrolines plot with CSCI pts
p2 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long.x, y = lat.x, group = id, colour = core0.50, linetype = 'Segment predicted\nmedian CSCI')) +
  scale_colour_gradientn(colours = pal(seqcsc)) +
  geom_point(data = spatfrt, aes(x = long.y, y = lat.y, fill = csci, shape = 'Observed CSCI'), size = 3, alpha = 0.9) +
  scale_fill_gradientn('', colours = pal(seqcsc)) +
  scale_linetype_manual('', values = 'solid') +
  scale_shape_manual('', values = 21) +
  ggsn::scalebar(location = 'bottomright', y.min = 33.77, y.max = 33.8, x.min = -118, x.max = -117.7, dist = 10, st.dist=.5, st.size = 3, height = 0.3, dd2km = T, model = 'WGS84') +
  guides(fill = F, colour = F) +
  coord_equal() +
  theme_void(base_family = 'serif') +
  theme(
    # legend.position = 'top',
    legend.justification = 'left',
    # legend.box.just = 'left'#,
    axis.title = element_blank()
    ) + 
  ggtitle('(b) Segment median predictions and observed scores for the CSCI')
p2leg <- g_legend(p2) 
p2 <- p2 + theme(legend.position = 'none')

# png('figs/sgrshd.png', height = 8, width = 5.5, units = 'in', res = 300, family = 'serif')
grid.arrange(
  arrangeGrob(p1, 
              arrangeGrob(pinset, luleg, ncol = 1, heights = c(1, 1)), ncol = 2, widths = c(1, 0.5)),
  arrangeGrob(p2, 
              arrangeGrob(colleg, p2leg, ncol = 1, heights = c(1,1)), ncol = 2, widths = c(1, 0.5)), 
  ncol = 1
)
# dev.off()
```

```{r ridges, fig.height = 8, fig.width = 10, fig.cap = 'Application of the landscape model to identify site expectations and bioassessment performance for sixteen example stream segments.  A range of CSCI scores is predicted from the model (a) and the lower and upper limits of the expectations are cut to define a certainty range for the predictions (b).  Overlap of the certainty range at each segment with a chosen CSCI threshold (c) defines the stream segment classification as likely unconstrained, possibly unconstrained, possibly constrained, and likely constrained.  The observed bioassessment scores are described relative to the classification as over scoring (above the certainty threshold), expected (within), and under scoring (below) for each of four stream classes (d).'}
##
# plot data

# plot data globals
sel <- 16
bnd <- 0.1
pts <- 2000
qts <- 0.1
thrsh <- 0.79

catcds <- data.frame(
  int = c('111', '011', '001', '000'),
  cls = c('likely unconstrained', 'possibly unconstrained', 'possibly constrained', 'likely constrained'),
  clsabv = c('lu', 'pu', 'pc', 'lc')
)

prfcds <- data.frame(
  int = c('00', '01', '11'), 
  cls = c('over scoring', 'expected', 'under scoring')
)

prflev <- c('over scoring', 'expected', 'under scoring')

scrshyp <- c(1.35, 1.15, 0.84, 0.6, 1.25, 0.95, 0.75, 0.53, 1.1, 0.83, 0.60, 0.35, 1, 0.75, 0.45, 0.15)

# plot data
set.seed(433)
rnd <- data.frame(
  id = factor(rev(1:sel), levels = rev(1:sel)),
  ave = rep(seq(0.5, 1.1, length = 4), each = 4),
  sds = sample(c(0.13), sel, replace = T), 
  scrshyp = rev(scrshyp)
  ) %>%
  group_by(id, scrshyp) %>% 
  nest %>%
  mutate(
    rnd = purrr::map(data, ~ rnorm(pts, .x$ave, .x$sds)), 
    estall = purrr::map(rnd, function(x){
      
      est <- density(x, n = pts, bw = bnd)
      out <- data.frame(
        xout = est$x, 
        hght = est$y
      )
      
      return(out)
      
    }), 
    estcut = purrr::pmap(list(rnd, estall), function(rnd, estall){
      
      qts <- quantile(rnd, c(qts, 1 - qts))
      out <- estall %>% 
        filter(xout >= qts[1] & xout <= qts[2])
      
      return(out)
      
    }), 
    estcat = purrr::map(estcut, function(x){
      
      out <- c(range(x$xout), median(x$xout)) %>% 
        sort %>% 
        findInterval(., thrsh) %>% 
        paste(collapse = '') %>% 
        factor(levels = catcds$int, labels = catcds$clsabv) %>% 
        as.character
      
      return(out)
      
      
    }), 
    prfcat = purrr::pmap(list(estcut, scrshyp), function(estcut, scrshyp){
      
      out <- range(estcut$xout) %>% 
        findInterval(., scrshyp) %>% 
        paste(collapse = '') %>% 
        factor(levels = prfcds$int, labels = prfcds$cls) %>% 
        as.character
      
      return(out)
      
    })
  )

toplo1 <- rnd %>% 
  dplyr::select(id, estall) %>% 
  unnest

toplo2 <- rnd %>% 
  dplyr::select(id, estcut) %>% 
  unnest

toplo3 <- rnd %>% 
  dplyr::select(id, estcut, estcat, prfcat) %>% 
  unnest(estcat, prfcat) %>% 
  unnest %>% 
  mutate(
    prfcat = paste0(prfcat, ' (', estcat, ')'), 
    estcat = factor(estcat, levels = catcds$clsabv, labels = catcds$cls)
  ) %>% 
  dplyr::rename(`Stream class` = estcat)

toplo4 <- rnd %>% 
  dplyr::select(id, scrshyp, estcat, prfcat) %>% 
  unnest %>% 
  mutate(
    prfcat = factor(prfcat, levels = prflev),
    estcat = factor(estcat, levels = catcds$clsabv, labels = catcds$cls),
    hght = scrshyp
  ) %>% 
  dplyr::rename(
    `Relative site score` = prfcat,
    `Stream class` = estcat
    )

##
# plots

# stream class colors
exp_col <- RColorBrewer::brewer.pal(9, 'Paired')[c(2, 1, 5, 6)] %>% 
  alpha(., 0.8)  

# plot globals
ht <- 0.99

# base 
pbase<- ggplot(toplo1, aes(x = xout, y = id, height = hght)) + 
  geom_density_ridges(stat = 'identity', alpha = 0.5, colour = NA, fill = 'grey', scale = ht) +
  scale_x_continuous(limits = c(0, 1.4)) + 
  theme_minimal(base_family = 'serif') + 
  theme(
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    legend.position = 'top'
  )

p1 <- pbase +
  geom_density_ridges(stat = 'identity', rel_min_height = 0.001, colour = 'black', fill = 'darkgrey', scale = ht) +
  scale_fill_gradient2(low = '#d7191c', mid = '#abd9e9', high = '#2c7bb6', midpoint = 1) +
  guides(fill = guide_colourbar('CSCI', barheight = 0.5, barwidth = 5, title.position = 'top')) +
  ggtitle('(a) Range of expected CSCI\nscores for stream segments')

p2 <- pbase +
  geom_density_ridges(data = toplo2, stat = 'identity', rel_min_height = 0.001, colour = 'black', fill = 'darkgrey', scale = ht) +
  scale_fill_gradient2(low = '#d7191c', mid = '#abd9e9', high = '#2c7bb6', midpoint = 1) +
  ggtitle('(b) Expected CSCI scores\nwithin certainty range') +
  theme(legend.position = 'none')

p3 <- pbase +
  geom_density_ridges(data = toplo3, aes(fill = `Stream class`), stat = 'identity', colour = 'black', scale = ht) +
  geom_vline(xintercept = thrsh, linetype = 'dashed') +
  scale_fill_manual(values = exp_col) +
  guides(fill = guide_legend(title.position = 'top', nrow = 2)) +
  ggtitle('(c) Stream segment classification\nby CSCI threshold')

p4 <- pbase +
  geom_density_ridges(data = toplo3, aes(fill = `Stream class`), stat = 'identity', colour = 'black', scale = ht) +
  geom_vline(xintercept = thrsh, linetype = 'dashed') +
  geom_point(data = toplo4, aes(x = scrshyp, group = id, shape = `Relative site score`, fill = `Stream class`), size = 3) + 
  scale_fill_manual(values = exp_col, guide = F) +
  scale_colour_manual('Site performance', values = pal_prf2(levels(toplo4$`Site performance`)), na.value = 'yellow') + 
  scale_shape_manual(values = c(24, 21, 25)) +  
  guides(colour = guide_legend(title.position = 'top'), shape = guide_legend(title.position = 'top')) +
  ggtitle('(d) Relative site scores by\nstream classification')

p3leg <- g_legend(p3)
p3 <- p3 + theme(legend.position = 'none')

p4leg <- g_legend(p4)
p4 <- p4 + theme(legend.position = 'none')

grid.arrange(
  arrangeGrob(p3leg, p4leg, ncol = 2, widths = c(0.75, 1)),
  arrangeGrob(p1, p2, p3, p4, ncol = 4),
  left = 'Segment type', bottom = 'CSCI scores', ncol = 1, heights = c(0.2, 1)
)
```

```{r eval = F}
# state base
calista <- map_data('state', region = 'california')

# psa data fortified
psadat <- calipsa %>%
  as('Spatial') %>%
  as.data.frame %>%
  rownames_to_column('id') %>%
  dplyr::select(id, PSA6) %>%
  dplyr::rename(PSA = PSA6) %>%
  mutate(Region = factor(PSA,
                         levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
                         labels = c('CV', 'Ch', 'DM', 'NC', 'SN', 'SC')
  ))
psafrt <- calipsa %>%
  dplyr::select(-PSA_REGION, -AREA, -PERIMETER, -PSA8) %>%
  as('Spatial') %>%
  fortify %>%
  left_join(psadat, by = 'id')

# all comid preds
calmed <- nhdplo %>%
  na.omit

# all comid class
toplo2 <- caliclsplo %>% 
  na.omit

# median csci predictions
p1 <- ggplot(calmed) +
  geom_path(aes(x = long, y = lat, group = id, colour = core0.50), size = 0.30) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() +
  scale_colour_gradientn(colours = pal(range(calmed$core0.50, na.rm = T))) +
  guides(colour = guide_colourbar('Segment predicted median CSCI\n', barheight = 0.5, barwidth = 8, title.position = 'top')) +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = c(0.5, 1.06),
    legend.direction = 'horizontal',
    plot.margin = grid::unit(c(15, 0, 0, 0), units = 'pt')
  )

# comid class
p2<- ggplot(toplo2) +
  geom_path(aes(x = long, y = lat, group = id, colour = strcls), size = 0.30) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() +
  scale_colour_manual(values = pal_exp(levels(toplo2$strcls))) +
  guides(colour = guide_legend('Segment classification', title.position = 'top', ncol = 2)) +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = c(0.5, 1.06),
    legend.direction = 'horizontal',
    plot.margin = grid::unit(c(15, 0, 0, 0), units = 'pt')
  )

png('figs/calires.png', height = 6, width = 8, units = 'in', res = 400, family = 'serif')
grid.arrange(p1, p2, ncol = 2)
dev.off()

```
```{r calires, fig.cap = "Statewide application of the landscape model showing the median predicted CSCI scores for each stream segment (left) and corresponding stream segment classifications (right). Major regional boundaries are also shown (see Figure \\@ref(fig:calimap))."}
knitr::include_graphics('figs/calires.png')
```

```{r sgrresplo, fig.height = 7, fig.width = 9, fig.cap = "Application of the landscape model to stream segments in the San Gabriel River watershed, Los Angeles County, California.  CSCI scores with (a) no context from the model are on the left and (b) scores with context from the model are on the right. Relative site scores as under-scoring, expected, or over-scoring are based on observed scores given the segment class as likely constrained, possibly constrained, possibly unconstrained, and likely unconstrained.  Segment classes are based on overlap of the expectations with a biological threshold for the CSCI (0.79, dashed lined) and location of the median expectation (white ticks)."}
##
# ggplot of sgr site expecations, relative scores

# requires spat, scrs

thrsh <- 0.79; tails <- 0.1

## get sgr expectation for ggplot
# process
incl <- site_exp(spat, sgrscrs, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  dplyr::select(-lat, -long) %>% 
  group_by(StationCode) %>% 
  nest

# average scors by station
out <- sgrscrs %>% 
  dplyr::select(StationCode, lat, long) %>% 
  group_by(StationCode) %>% 
  nest %>% 
  mutate(StationCode = factor(StationCode, levels = levels(incl$StationCode))) %>% 
  left_join(incl, ., by = 'StationCode') %>% 
  unnest

# add additional perf column for multicolor by strcls (pal_prf)
# remove NA csci
ggsgrexp <- get_perf_mlt(out) %>% 
  filter(!is.na(strcls))

# CSCI scores and expectations
toplo1 <- ggsgrexp %>%
  dplyr::select(COMID, StationCode, datcut, strcls, csci, perf, typelv, perf_mlt) %>%
  unnest %>%
  mutate(
    strcls = factor(strcls, levels = levels(strcls)),
    perf = factor(perf, levels = levels(perf))
    ) %>%
  dplyr::rename(
    `Stream Class` = strcls,
    `Relative\nscore` = perf_mlt,
    Type = typelv
    )

# total expected range
toplo2 <- ggsgrexp %>%
  dplyr::select(COMID, StationCode, data, strcls) %>%
  unnest %>%
  mutate(strcls = factor(strcls, levels = levels(strcls))) %>%
  dplyr::rename(`Stream Class` = strcls)

# median expectation
toplo3 <- ggsgrexp %>%
  dplyr::select(COMID, StationCode, datcut) %>%
  unnest %>%
  filter(grepl('0\\.50$', var)) 

# plot, no context
p1 <- ggplot(toplo1, aes(y = StationCode, x = val)) +
  theme_bw(base_family = 'serif', base_size = 12) +
  theme(
    axis.text.y = element_text(size = 6.5), 
    axis.title.y = element_text(size = 13),
    axis.title.x = element_blank(), 
    title = element_text(size = 10)
  ) +
  scale_x_continuous('CSCI') +
  scale_y_discrete('Stream segment') +
  geom_point(aes(x = csci), shape = 16, size = 1.5, alpha = 0.8) +
  geom_vline(xintercept = thrsh, linetype = 'dashed', size = 1) + 
  ggtitle('(a) CSCI scores with no context')

# plot, context
p2 <- ggplot(toplo1, aes(y = StationCode, x = val)) +
  geom_line(data = toplo1, aes(x = val, colour = `Stream Class`), alpha = 0.1, size = 2) +
  geom_line(aes(colour = `Stream Class`), alpha = 0.6, size = 2) +
  geom_point(data = toplo3, colour = 'white', size = 1, alpha = 1, shape = 15) +
  theme_bw(base_family = 'serif', base_size = 12) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(), 
    axis.ticks.y = element_blank(), 
    legend.position = 'top', 
    title = element_text(size = 10)
  ) +
  scale_x_continuous('CSCI') +
  scale_y_discrete('Site') +
  scale_colour_manual('Stream segment class', values = pal_exp(levels(toplo1$`Stream Class`))) +
  geom_point(aes(x = csci, fill = `Stream Class`, shape = perf), size = 2.5, alpha = 0.8) +
  geom_vline(xintercept = thrsh, linetype = 'dashed', size = 1) +
  scale_shape_manual('Relative site score', values = c(25, 21, 24)) +
  scale_fill_manual(values = pal_exp(levels(toplo1$`Stream Class`)), na.value = 'yellow', guide = F) +
  guides(shape = guide_legend(title.position = 'top'), colour = guide_legend(title.position = 'top', ncol = 2)) +
  ggtitle('(b) CSCI scores with context from the landscape model')
p2leg <- g_legend(p2)
p2 <- p2 + theme(legend.position = 'none')

# png('figs/sgrresplo.png', height = 7, width = 9, units = 'in', res = 300, family = 'serif')
grid.arrange(
  arrangeGrob(p2leg),
  arrangeGrob(p1, p2, ncol = 2, bottom = 'CSCI', widths = c(1, 0.9)),
  ncol = 1, heights = c(0.15, 1)
)
# dev.off()
```

```{r sgrresmap, fig.height = 7.5, fig.width = 8, fig.cap = "Relative site scores and recommended management actions for locations with CSCI scores in the San Gabriel River watershed. Relative site scores as under scoring, expected, or over scoring are based on observed scores given the segment class as likely constrained, possibly constrained, possibly unconstrained, and likely unconstrained. Recommended management actions are ranked by priority for actions to investigate, protect, and restore a site.  No recommended actions assume baseline maintenance and monitoring is sufficient for a site. Recommended actions were defined by a local stakeholder group (see Figure S3)."}
# requires spat, scrs

thrsh <- 0.79; tails <- 0.1

##
# nhd sgr str class
sgrcls <- getcls2(spat, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  left_join(spat, ., by = 'COMID') %>% 
  dplyr::select(COMID, strcls)

##
# get biological condition expectations
cls <- getcls2(spat, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  mutate(COMID = as.character(COMID)) 

# get csci difference
sgrscrs <- spat %>% 
  dplyr::select(COMID, core0.50) %>% 
  mutate(COMID = as.character(COMID)) %>% 
  left_join(scrs, ., by = 'COMID') %>% 
  group_by(COMID, StationCode, lat, long) %>% 
  summarise(
    csci = mean(csci, na.rm = TRUE)
  ) %>% 
  ungroup %>%
  left_join(cls, by = 'COMID')

# priorities
pritab <- tibble(
  typelv = paste0('Type', stringr::str_pad(seq(1:16), pad = '0', width = 2)),
  I = c(rep(c('H', '', 'H', 'H'), 2), rep(c('M', 'M', '', 'M'), 2)),
  P = c(rep(c('H', 'M', 'M', ''), 2), rep(c('H', '', '', ''), 2)),
  R = c(rep(c('', '', 'M', 'H'), 2), rep(c('', 'L', 'L', 'L'), 2))
) %>% 
  gather('action', 'priority', I, P, R) %>% 
  mutate(priority = ifelse(priority == '', 'baseline', priority)) %>% 
  spread(action, priority) %>% 
  mutate(
    I = factor(I, levels = c('H', 'M', 'L', 'baseline'), labels = c('High', 'Medium', 'Low', 'baseline')),
    P = factor(P, levels = c('H', 'M', 'L', 'baseline'), labels = c('High', 'Medium', 'Low', 'baseline')),
    R = factor(R, levels = c('H', 'M', 'L', 'baseline'), labels = c('High', 'Medium', 'Low', 'baseline'))
  )

##
# stuff to plot

# relative site scores
sgrexp <- site_exp(spat, sgrscrs, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  dplyr::select(-data, -datcut) %>% 
  mutate(
    strcls = factor(strcls, levels = levels(strcls)),
    perf = factor(perf, levels = rev(levels(perf))),
    typelv = as.character(typelv)
    ) %>% 
  filter(!is.na(perf))

# priorities for sgr
sgrpri <- sgrexp %>% 
  left_join(pritab, by = 'typelv') %>% 
  dplyr::select(StationCode, lat, long, typelv, I, P, R)

# hydrolines
spatdat <- spat %>% 
  dplyr::select(COMID) %>% 
  mutate(id = as.character(1:nrow(.)))
st_geometry(spatdat) <- NULL
spatfrt <- spat %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(spatdat, by = 'id') %>% 
  mutate(COMID = as.character(COMID)) %>% 
  left_join(cls, by = 'COMID') %>% 
  mutate(
    strcls = factor(strcls, levels = levels(strcls))
  ) %>% 
  filter(!is.na(strcls))
  
# wshed boundary fortified
shedfrt <- shed %>% 
  as('Spatial') %>% 
  fortify 


thm <- theme_void(base_family = 'serif') +
  theme(
    legend.position = 'top',
    # legend.justification = 'left',
    # legend.box.just = 'left',
    axis.title = element_blank(), 
    strip.background = element_blank()
  )

##
# relative site scores

# sgr all leg
pleg <- ggplot(sgrexp) +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls)) +
  geom_point(data = sgrexp, aes(x = long, y = lat, shape = perf, fill = strcls), size = 3, alpha = 0.7) +
  ggsn::scalebar(location = 'bottomright', y.min = 33.77, y.max = 33.8, x.min = -118, x.max = -117.7, dist = 10, st.dist=.5, st.size = 3, height = 0.3, dd2km = T, model = 'WGS84') +
  scale_colour_manual('Stream segment class', values = pal_exp(levels(spatfrt$strcls))) +
  scale_fill_manual(values = pal_exp(levels(sgrexp$strcls)), na.value = 'yellow', guide = F) +
  scale_shape_manual('Relative site score', values = c(24, 21, 25), guide = F) +
  guides(colour = guide_legend(title.position = 'left', ncol = 2)) +
  coord_equal() +
  thm
clsleg <- g_legend(pleg)

# under
sgrexpund <- sgrexp %>% 
  filter(perf == 'under scoring') %>% 
  mutate(strcls = forcats::fct_drop(strcls))
p1 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrexpund, aes(x = long, y = lat, fill = strcls, shape = perf), size = 3, alpha = 0.9) +
  ggsn::scalebar(location = 'bottomright', y.min = 33.77, y.max = 33.8, x.min = -118, x.max = -117.7, dist = 10, st.dist=.5, st.size = 3, height = 0.3, dd2km = T, model = 'WGS84') +
  scale_colour_manual('Stream segment class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual(values = pal_exp(levels(sgrexpund$strcls)), na.value = 'yellow', guide = F) +
  scale_shape_manual('', values = c(25)) +
  coord_equal() +
  thm + 
  theme(legend.position = c(0.5, 1.05))

# expected
sgrexpexp <- sgrexp %>% 
  filter(perf == 'expected') %>% 
  mutate(strcls = forcats::fct_drop(strcls))
p2 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrexpexp, aes(x = long, y = lat, fill = strcls, shape = perf), size = 3, alpha = 0.9) +
  scale_colour_manual('Stream segment class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual(values = pal_exp(levels(sgrexpexp$strcls)), na.value = 'yellow', guide = F) +
  scale_shape_manual('', values = c(21)) +
  coord_equal() +
  thm + 
  theme(legend.position = c(0.5, 1.05))

# over
sgrexpovr <- sgrexp %>% 
  filter(perf == 'over scoring') %>% 
  mutate(strcls = forcats::fct_drop(strcls))
p3 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrexpovr, aes(x = long, y = lat, fill = strcls, shape = perf), size = 3, alpha = 0.9) +
  scale_colour_manual('Stream segment class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual(values = pal_exp(levels(sgrexpovr$strcls)), na.value = 'yellow', guide = F) +
  scale_shape_manual('', values = c(24)) +
  coord_equal() +
  thm + 
  theme(legend.position = c(0.5, 1.05))

##
# site priorities

# investigate
p4 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrpri, aes(x = long, y = lat, fill = I, size = I), shape = 21, alpha = 1) +
  scale_colour_manual('Stream segment class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual('Investigate', values = pal_pri(levels(forcats::fct_drop(sgrpri$I)))) +
  scale_size_manual('Investigate', values = pal_siz(levels(forcats::fct_drop(sgrpri$I)))) +
  coord_equal() +
  thm + 
  theme(
    legend.position = c('none'), 
    plot.title = element_text(hjust = 0.5, size = 9)
    ) + 
  ggtitle('Investigate')

# protect
p5 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrpri, aes(x = long, y = lat, fill = P, size = P), shape = 21, alpha = 1) +
  scale_colour_manual('Stream segment class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual('Protect', values = pal_pri(levels(forcats::fct_drop(sgrpri$P)))) +
  scale_size_manual('Protect', values = pal_siz(levels(forcats::fct_drop(sgrpri$P)))) +
  coord_equal() +
  thm + 
  theme(
    legend.position = c('none'), 
    plot.title = element_text(hjust = 0.5, size = 9)
  ) + 
  ggtitle('Protect')

# restore
p6 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrpri, aes(x = long, y = lat, fill = R, size = R), shape = 21, alpha = 1) +
  scale_colour_manual('Stream segment class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual('Priority', values = pal_pri(levels(forcats::fct_drop(sgrpri$R)))) +
  scale_size_manual('Priority', values = pal_siz(levels(forcats::fct_drop(sgrpri$R)))) +
  coord_equal() +
  thm + 
  theme(
    legend.position = c('top'), 
    plot.title = element_text(hjust = 0.5, size = 9)
  ) + 
  ggtitle('Restore') +
  guides(fill = guide_legend(title.position = 'left'), size = guide_legend(title.position = 'left'))
prileg <- g_legend(p6)
p6 <- p6 + theme(legend.position = 'none')

# png('figs/sgrresmap.png', height = 7.5, width = 8, units = 'in', res = 400, family = 'serif')
grid.arrange(
  arrangeGrob(clsleg),
  arrangeGrob(p1, p2, p3, ncol = 3),
  arrangeGrob(prileg),
  arrangeGrob(p4, p5, p6, ncol = 3),
  ncol = 1, heights = c(0.2, 1, 0.1, 1)
)
# dev.off()
```

```{r sensplo, fig.height = 5, fig.width = 5.5, fig.cap = 'Changes in stream segment classes by region and statewide for different scenarios used to define biological constraints.  The percentage of total stream length for likely unconstrained and likely constrained is shown for each scenario.  Stream classifications as possibly unconstrained or possibly constrained are not shown but can be inferred form the area of white space above or below each bar. The solid black line indicates the percentage division between unconstrained and constrained classifications.  Twenty-seven scenarios were tested that evaluated different combinations of certainty in the CSCI predictions (nine scenarios from wide to narrow prediction intervals as identified by the tail cutoff for the expected range) and potential CSCI threshold (three scenarios from low to high).  CV: Central Valley, CH: Chaparral, DM: Deserts and Modoc Plateau, NC: North Coast, SN: Sierra Nevada, SC: South Coast.'}

# search grid
grd_chk <- list(
  thrsh = c(0.63, 0.79, 0.92), 
  tails = seq(0.05, 0.45, by = 0.05)
) %>% 
  cross_df

# stream class sensitivity
senscls <- sensres %>% 
  purrr::map(~ .x[[1]]) %>% 
  enframe %>% 
  bind_cols(grd_chk, .) %>% 
  dplyr::select(-name) %>% 
  unnest %>% 
  mutate(
    thrsh = factor(thrsh, levels = c(0.63, 0.79, 0.92), labels = c('low CSCI treshold (0.63)', 'medium (0.79)', 'high CSCI threshold (0.92)')), 
    tails = as.character(tails), 
    Region = gsub('^statewide$', 'Statewide', Region),
    strcls = factor(strcls, levels = c('possibly unconstrained', 'likely unconstrained', 'likely constrained', 'possibly constrained'))
  ) %>% 
  group_by(Region, thrsh, tails) %>% 
  mutate(hlin = sum(perc[strcls %in% c('likely constrained', 'possibly constrained')]))

# fill colors
fills <- pal_exp(levels(senscls$strcls))
fills[c(1, 4)] <- NA

# results plot
pres <- ggplot(senscls, aes(x = tails, y = perc, fill = strcls, group = strcls)) + 
  geom_bar(stat = 'identity', width = 0.9, alpha = 0.7) +
  facet_grid(Region ~ thrsh) +
  scale_fill_manual('Stream segment class', breaks = c('likely unconstrained', 'likely constrained'), values = fills) +
  theme_bw(base_family = 'serif') +     
  scale_y_continuous('% stream length', expand = c(0, 0)) + 
  scale_x_discrete('Width of CSCI prediction interval (wide to narrow)', expand = c(0, 0), breaks = c('0.05', '0.15', '0.25', '0.35', '0.45')) +
  geom_hline(data = senscls, aes(yintercept = hlin)) +
  theme(
    strip.background = element_blank(), 
    axis.text.x = element_text(size = 7),
    axis.text.y = element_text(size = 7),
    panel.grid = element_blank(), 
    panel.border = element_blank(),
    plot.title = element_text(size = 11, hjust = 0.5), 
    legend.position = 'top'
  )

pres
```

# Tables 

```{r clsdef, tidy = F}
# table content format
totab <- tibble(
  Class = c('Likely unconstrained', 'Possibly unconstrained', 'Possibly constrained', 'Likely constrained'),
  Definition = c('Lower bound of prediction interval is above threshold', 'Median prediction is above threshold', 'Median prediction is below threshold', 'Upper bound of prediction interval is below threshold'), 
  Example = c('10th percentile > 0.79', '50th percentile > 0.79', '50th percentile < 0.79', '90th percentile < 0.79')
  )

# table stuff
cap.val <- 'Stream class definitions describing potential biological constraints.  Classes are based on the overlap of the range of likely bioassessment scores with a potential threshold for a biological objective.  Identifying stream classes requires selecting the cutoff range of likely scores from the landscape model and a chosen threshold for the objective.'

# table
knitr::kable(totab, booktabs = T, caption = cap.val)
```

```{r typetab, tidy = F}
# table content format
totab <- typetab %>% 
  mutate(
    `Observed score` = gsub('>=', '$\\\\geq$', `Observed score`),
    `Segment expectation` = ifelse(duplicated(`Segment expectation`), '', paste0('**', `Segment expectation`, '**')), 
    Type = as.character(Type)
  ) %>% 
  dplyr::rename(`Relative site score` = `Site performance`) %>% 
  dplyr::select(-Sites)

# table stuff
cap.val <- 'Possible site types based on stream segment classification, relative site score, and observed CSCI score. The observed score column describes where a CSCI score is observed relative to the lower and upper percentiles (e.g., 10th and 90th) of expected scores for a segment and the chosen CSCI threshold (e.g., 10th percentile of scores at reference sites or 0.79) for defining low or high values.'

# table
knitr::kable(totab, booktabs = T, caption = cap.val)
```

*Table \@ref(tab:clstot): (\#tab:clstot) Summary of stream length for each stream class statewide and major regions of California (Figures \@ref(fig:calimap), \@ref(fig:calires)).  Lengths are in kilometers with the percentage of the total length in a region in parentheses. All lengths are based on a CSCI threshold of 0.79 and the 10th to 90th percentile of expected scores from the landscape model. CV: Central Valley, CH: Chaparral, DM: Deserts and Modoc Plateau, NC: North Coast, SN: Sierra Nevada, SC: South Coast.*
```{r clstot}
st_geometry(strclslen) <- NULL

# by region
lentot <- strclslen %>% 
  filter(!is.na(strcls)) %>% 
  mutate(
    Region = factor(PSA6, 
                  levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
                  labels = c('CV', 'CH', 'DM', 'NC', 'SN', 'SC')
    )
  ) %>% 
  group_by(Region, strcls) %>% 
  summarise(len = sum(lens)) %>% 
  spread(strcls, len, fill = 0) %>% 
  gather('strcls', 'len', -Region) %>% 
  group_by(Region) %>% 
  mutate(
    perc = 100 * len / sum(len), 
    perc = round(perc, 0),
    perc = paste0('(', perc, ')'),
    len = round(len, 0), 
    strcls = factor(strcls, levels = c('likely constrained', 'possibly constrained', 'possibly unconstrained', 'likely unconstrained'))
  ) %>% 
  unite(`Stream km (%)`, len, perc, sep = ' ') %>% 
  arrange(Region, strcls) %>% 
  spread(strcls, `Stream km (%)`)

# statewide
lentotall <- strclslen %>% 
  filter(!is.na(strcls)) %>% 
  group_by(strcls) %>% 
  summarise(len = sum(lens)) %>%
  ungroup %>% 
  mutate(
    perc = 100 * len / sum(len), 
    perc = round(perc, 0),
    perc = paste0('(', perc, ')'),
    len = round(len, 0), 
    strcls = factor(strcls, levels = c('likely constrained', 'possibly constrained', 'possibly unconstrained', 'likely unconstrained'))
  ) %>% 
  unite(`Stream km (%)`, len, perc, sep = ' ') %>% 
  arrange(strcls) %>% 
  mutate(Region = 'Statewide') %>% 
  spread(strcls, `Stream km (%)`)

totab <- bind_rows(lentotall, lentot)

# use flextable
brd <- fp_border(color="black")

tab <- regulartable(totab) %>% 
  font(fontname = 'Times', part = 'all') %>% 
  fontsize(size = 12, part = 'all') %>% 
  border_remove %>%
  set_header_labels(Region = 'Region', `likely constrained` = 'likely', `possibly constrained` = 'possibly', `possibly unconstrained` = 'possibly', `likely unconstrained` = 'likely') %>% 
  add_header(Region = '', `likely constrained` = 'constrained', `possibly constrained` = 'constrained', `possibly unconstrained` = 'unconstrained', `likely unconstrained` = 'unconstrained') %>% 
  merge_h(part = 'header', i = 1) %>% 
  hline(part = 'header', border = brd) %>% 
  align(align = 'left', part = 'all') %>% 
  autofit 
tab
```

*Table \@ref(tab:reltot): \(\#tab:reltot) Summary of CSCI scores by relative expectations for each stream class statewide and in each major region of California (Figures \@ref(fig:calimap), \@ref(fig:calires)). Average (standard deviation) scores and counts (percent) of the number of monitoring stations in each relative expectation and region are shown.  Sites are over scoring if the observed scores are above the range of expectations at a segment, expected if within the range, or under scoring if below the range. CV: Central Valley, CH: Chaparral, DM: Deserts and Modoc Plateau, NC: North Coast, SN: Sierra Nevada, SC: South Coast.*
```{r reltot, eval = T}
cscipsa <- csci_comid %>% 
  dplyr::select(COMID, PSA6c) %>% 
  unique %>% 
  mutate(COMID = as.character(COMID))

# format table of site counts by region
reltot <- caliexp %>% 
  dplyr::select(COMID, csci, StationCode, strcls, perf) %>% 
  filter(!is.na(strcls)) %>% 
  left_join(cscipsa, by = 'COMID') %>% 
  dplyr::rename(Region = PSA6c) %>% 
  group_by(Region, perf) %>% 
  summarise(
    n = n(), 
    csciave = mean(csci, na.rm = T), 
    csciave = round(csciave, 2),
    cscisd = sd(csci, na.rm = T), 
    cscisd = round(cscisd, 2), 
    cscisd = paste0('(', cscisd, ')')
  ) %>% 
  group_by(Region) %>% 
  mutate(
    perc = n / sum(n), 
    perc = round(100 * perc, 0), 
    perc = paste0('(', perc, ')')
  ) %>% 
  unite('csci', csciave, cscisd, sep = ' ') %>% 
  unite('n_perc', n, perc, sep = ' ') %>% 
  complete(Region, perf, fill = list('n_perc' = '0 (0)', csci = '-')) %>% 
  gather('var', 'val', -Region, -perf) %>%
  arrange(Region, perf) %>%
  unite('colnm', perf, var, sep = '-') %>%
  spread(colnm, val) %>%
  .[, c(1, 6, 7, 2, 3, 4, 5)]

# whole state
reltotall <- caliexp %>% 
  dplyr::select(COMID, csci, StationCode, strcls, perf) %>% 
  filter(!is.na(strcls)) %>% 
  left_join(cscipsa, by = 'COMID') %>% 
  dplyr::rename(Region = PSA6c) %>% 
  group_by(perf) %>% 
  summarise(
    n = n(), 
    csciave = mean(csci, na.rm = T), 
    csciave = round(csciave, 2),
    cscisd = sd(csci, na.rm = T), 
    cscisd = round(cscisd, 2), 
    cscisd = paste0('(', cscisd, ')')
  ) %>% 
  ungroup %>% 
  mutate(
    perc = n / sum(n), 
    perc = round(100 * perc, 0), 
    perc = paste0('(', perc, ')')
  ) %>% 
  unite('csci', csciave, cscisd, sep = ' ') %>% 
  unite('n_perc', n, perc, sep = ' ') %>% 
  gather('var', 'val', -perf) %>%
  arrange(perf) %>%
  unite('colnm', perf, var, sep = '-') %>%
  mutate(Region = 'Statewide') %>% 
  spread(colnm, val) %>%
  .[, c(1, 6, 7, 2, 3, 4, 5)]

totab <- bind_rows(reltotall, reltot)

# use flextable
brd <- fp_border(color="black")

tab <- regulartable(totab) %>% 
  font(fontname = 'Times', part = 'all') %>% 
  fontsize(size = 12, part = 'all') %>% 
  border_remove %>%
  set_header_labels(Region = 'Region', `expected-csci` = 'CSCI', `expected-n_perc` = 'n (%)', `over scoring-csci` = 'CSCI', `over scoring-n_perc` = 'n (%)', `under scoring-csci` = 'CSCI', `under scoring-n_perc` = 'n (%)') %>% 
  add_header(Region = '', `expected-csci` = 'expected', `expected-n_perc` = 'expected', `over scoring-csci` = 'over scoring', `over scoring-n_perc` = 'over scoring', `under scoring-csci` = 'under scoring', `under scoring-n_perc` = 'under scoring') %>% 
  merge_h(part = 'header') %>% 
  hline(part = 'header', border = brd) %>% 
  align(align = 'left', part = 'all') %>% 
  autofit 
tab
```

# References


