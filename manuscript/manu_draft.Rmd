---
title: "Prioritizing management goals for stream biological integrity within the context of landscape constraints"
output: 
  bookdown::word_document2:
    reference_docx: my_styles.docx
bibliography: refs.bib
author: 'Marcus W. Beck (marcusb@sccwrp.org), Raphael D. Mazor (raphaelm@sccwrp.org), Scott Johnson (scott@aquaticbioassay.com), Karin Wisenbaker (karin@aquaticbioassay.com), Joshua Westfall (jwestfall@lacsd.org), Peter D. Ode (peter.ode@wildlife.ca.gov), Ryan Hill (hill.ryan@epa.gov), Chad Loflen (Chad.Loflen@waterboards.ca.gov), Martha Sutula (marthas@sccwrp.org), Eric D. Stein (erics@sccwrp.org)'
urlcolor: blue
link-citations: true
---

```{r setup, echo = F, warning = F, message = F, results = 'hide'}
# figure path, chunk options
knitr::opts_chunk$set(fig.path = 'figs/', warning = F, message = F, echo = F, cache = T, dev.args = list(family = 'serif'), dpi = 300, warning = F, out.width = '100%', cache.path = 'manu_draft_cache/',
  fig.process = function(x) {
  x2 = sub('-\\d+([.][a-z]+)$', '\\1', x)
  if (file.rename(x, x2)) x2 else x
  })

# libraries
library(tidyverse)
library(Hmisc)
library(Jabbrev)
library(gridExtra)
library(sf)
library(maptools)
library(maps)
library(grid)
library(ggrepel)
library(RColorBrewer)
library(ggridges)
library(scales)
library(quantregForest)
library(leaflet)
library(raster)
library(flextable)
library(officer)

# functions (incl. color palettes)
source('../R/funcs.R')

# extract bib entries from online
bib_scrp('manu_draft.Rmd', 'refs.bib')

 # data
load(file = '../data/typetab.RData')
load(file = '../data/csci_raw.RData')
load(file = '../data/ludat.RData')
load(file = '../data/calipsa.RData')
load(file = '../data/psalab.RData')
load(file = '../data/rf_core.RData')
load(file = '../data/sgrlu.RData')
load(file = '../data/shed.RData')
load(file = '../data/spat.RData')
load(file = '../data/scrs.RData')
load(file = '../data/csci_comid.RData')
load(file = '../data/nhdplo.RData')
load(file = '../data/caliclsplo.RData')
load(file = '../data/calicls.RData')
load(file = '../data/caliexp.RData')
load(file = '../data/comid_prd.RData')
load(file = '../data/strclslen.RData')
load(file = '../data/cnstrfrst.RData')
load(file = '../data/sensres.RData')
load(file = '../data/typscrs.RData')
```

```{r echo = F, cache = F}
raw <- system('git log -1', intern = TRUE)
raw <- raw[grep('^Date', raw)]
raw <- paste('Version', raw)
```
`r raw`

# Abstract 

Some management goals may be impractical with limited resources, particularly in streams where large-scale changes on the landscape (e.g., urbanization) impose constraints on the upper limit of biological integrity.  A statewide landscape model was developed that provides context for a macroinvertebrate-based bioasssessment index by predicting a range of expectations that are typical at a site for the observed level of landscape alteration.  With this approach, sites can be described as over- or under-scoring relative to an expectatation that is determined by landscape constraints on biological condition. A regional application of the landscape model was used to classify sites and prioritize different management actions by a local stakeholder group of regulators, dischargers, stormwater agencies, and environmental advocates from the San Gabriel River watershed (Los Angeles County, California). Stakeholder decisions were facilitated with the Stream Classification and Priority Explorer (SCAPE) tool that compares observed bioassessment scores with expectations from the landscape model to rapidly identify reaches that are scoring better or worse than expected. Of the 71 sites in the watershed where bioassessment occurred, over half (58%) were found to be constrained by landscape, of which nine were assigned a medium priority for further investigation by the stakeholder group.  Similarly, 30% of sites were unconstrained and assigned medium or high priorities for enhanced protection or restoration depending on whether a site was scoring better or worse than expected.  A clear gradient from the upper to lower watershed was observed in land use that was consistent with the model predictions, where landscape constraints were more common in the heavily urbanized lower watershed.  Interaction with the local stakeholder group was critical in connecting the landscape model with observed data to help set management goals appropriate for the region.  The availability of geospatial and bioassessment data at the national level suggests that these tools can easily be applied to inform management decisions at other locations where biological indices are used to assess environmental condition.

# Introduction

The widespread use of bioassessment data to assess ecological condition of aquatic environments is a significant advance over chemical or physical methods of assessment, yet managers require contextual information for synthesizing and interpreting biological information.  The reference condition concept that is built into many biological indices is an explicit means of evaluating observed condition relative to unaltered habitats for a particular region [@Reynoldson97;@Stoddard06].  However, in many cases the reference benchmark may not completely describe actual limits on biotic condition at spatial scales that can be effectively managed for biological health [@Chessman04;@Chessman14]. A bioassessment index may be difficult to incorporate into management through regulatory statutes if thresholds for biological objectives are impractical within site-specific conditions.  Managers require explicit information that not only synthesize site level bioassessment data at the watershed scale, but also provide an assessment context that is sufficiently interpretable for prioritization. 

The application of bioassessment data to inform management requires understanding the effects of multiple stressors acting at local, catchment, or watershed scales [@Novotny05;@Townsend08;@Leps15]. Nearly half of all streams and rivers in the USA are estimated to be in poor condition as related to the most commonly observed in-stream stressors, such as excess phosphorus, nitrogen, or altered physical habitat [@USEPA16]. These proximal and immediate causes of poor biological condition are often linked to landscape-level factors that occur in the watershed.  Consistent and empirical links between land use thresholds and poor biotic integrity have been identified in many cases [@Allan97;@Wang97;@Clapcott11]. Mechanistic linkages between land use and degraded biological condition have been described (e.g., @Allan04, @Riseng11), whereas the precise link between land use and instream condition may not be clear for other causal pathways (e.g., @Cormier13).  Regardless, land use has long been used as a proxy for environmental condition and an associative link can be sufficient to predict condition as a function of watershed activities. 

In many urban and agricultural areas the majority of stream miles are not healthy and in need of some level of management [@USGS99;@Finkenbine00;@Morgan05].  Conventional approaches to restore or protect aquatic resources have commonly focused on direct improvements at the site-level to mitigate instream stressors [@Carline07;@Lester08;@Roni12], whereas upstream preventative measures have been incentivized or enforced through regulation.  Although these approaches can lead to improvements in stream health, there is no universal remedy that applies to all stream types and conditions. For example, the required resources to restore a highly degraded stream in an urban or agricultural setting can be costly and it may be unreasonable to set regional reference conditions as a restoration target [@Kenney12;@Shoredits13]. A confounding factor for managing stream health in developed landscapes is the extensive modification to streams for flood control or water conveyance.  Channel modification has been used as a basis for redefining water quality criteria that is site specific or for re-evaluating use attainability goals.  For example, the Los Angeles River (California, USA) is heavily engineered as a concrete-lined channel and recreational uses that apply nationally are suspended under high flow conditions [@CRWQCB14].  Other states have recommended a tiered aquatic life use or other alternative use designations to account for baseline shifts in ecosystem health from environmental modification  [@FLDEP11;@USEPA13;@MBI16].  

Developing an expectation of biological potential as a function of land use constraints could help prioritize where management actions are most likely to achieve intended outcomes, or conversely, where landscape alteration might impose constraints on biological integrity that limits potential for management success.  Understanding limits to biological potential is a fundamental concept in bioassessment that has recieved some attention.  Methods for factor-ceiling analysis have been explored in a bioassessment context to characterize environmental factors that limit assemblage composition [@Chessman08;@Chessman14]. This approach is based on the limiting factor theory that proposes the most limiting biotic or abiotic factor as the primary regulator of species abundance and distribution. Similar concepts have been applied in a landscape context to understand both variation in bioassessment data at different spatial scales and limits of bioassessment tools with land use gradients [@Waite13;@Waite14].  Applying these concepts in a predictive framework could facilitate an expectation of bioassessment and management potential relative to a site-specific context. 

Previous modelling efforts for bioassessment have used geospatial data to predict biological condition at regional or national scales [@Volstad04;@Carlisle09;@Brown12;@Hill17], with the general purpose of characterizing condition at unsampled reaches. Landscape-level constraints are particularly relevant for stream macroinvertebrate communities [@Sponseller01;@Waite13] and associations of constraints with conditions could be used to predict a range of expectations for biotic integrity.  This approach could build on previous applications of landscape models by predicting a lower and upper estimate of what bioassessment index scores are likely relative to the landscape, in addition to estimating biological condition at unsampled reaches. Once the predicted response of macroinvertebrate communities to landscape changes at large spatial scales are understood, expectations can be compared to field samples and sites can be prioritized by local managers based on deviation from the expectation. As such, the development of contextual tools for understanding biological condition across landscape gradients could provide a powerful approach to informing the use of limited resources to manage stream integrity.
     
The goal of this study is to present the development of a landscape model to classify and prioritize stream monitoring sites and demonstrate its application to estimate constraints on biological integrity in California streams. This work builds on the knowledge and relationships developed through existing monitoring programs and applies that in a predictive manner across entire landscapes to inform management decisions.  The specific objectives were to 1) demonstrate development of a landscape model to predict expected ranges of biotic condition, 2) classify stream reaches using modelling expectations, 3) assess the extent of stream classes and explore the sensitivity of the classifications to decision points in the model output, and 4) prioritize potential management decisions by comparing predicted ranges to observed bioassessment scores. The model was developed and applied to all stream reaches in California. A case study demonstrated how the statewide model can be used to classify and prioritize in a regional context using guidance from a local stakeholder group. An interactive software tool that was used by the stakeholder group to develop priority recommendations from the landscape model is also described.

# Methods

## Study area and data sources

The landscape model was developed for California using land use data, stream hydrography, and biological assessments.  California covers 424,000 km$^2$ of land from latitudes 33 to 42$^\circ$N that includes extreme variation in altitude and climate (Figure \@ref(fig:calimap)).  Temperate rainforests occur in the north, deserts in the northeast and southeast, and Mediterranean climates in coastal regions.  California's stream network is approximately 280,000 km in length and covers all of the major climate zones in the state. A high degree of endemism and biodiversity occurs in these streams including nearly 4000 species of vascular plants, macroinvertebrates, and vertebrates that depend on fresh water during their life history [@Howard09;@Howard15].  Approximately 30% of streams in California are perennial with the remaining as intermittent or ephemeral for portions of the year.  A large portion of the central region of the state is agricultural (i.e., Central Valley), whereas dense areas of urban development are in the southwest (i.e., Los Angeles and San Diego) and central (San Francisco Bay area) coast areas.  Developed lands increased in California by 38% from 1973 to 2000 [@Sleeter11].

Stream data from the National Hydrography Dataset Plus (NHD-plus) [@McKay12] were used to identify reaches in California for modelling biological integrity. The NHD-plus is a surface water framework that maps drainage networks and associated features (e.g., streams, lakes, canals, etc.) in the United States.  Stream flow lines in the NHD-plus are developed from flow accumulation models that estimate location of a stream given slope and elevation changes from existing elevation datasets.  As such, flow lines in California represent both perennial, intermittent, and ephemeral streams that have wide variation in observed flow throughout the year. Stream reaches designated in the NHD-plus were used as the discrete spatial unit for modelling biological integrity.  Hydrography data were combined with landscape metrics available from the StreamCat Dataset [@Hill16] to estimate land use at the catchment (i.e., nearby landscape flowing directly into a stream segment) and the entire upstream watershed for each reach.  The StreamCat Dataset was developed specifically for the NHD-plus to leverage the topology of stream connections to estimate cumulative landscape metrics of all reaches.

The California Stream Condition Index (CSCI) [@Mazor16] was used as a measure of biological condition in California streams.  Benthic macroinvertebrate data used to calculate CSCI scores were collected at nearly 3400 sites (6270 with repeat visits) between 2000 and 2016.  Field data were collected during baseflow conditions typically between May and July following methods in @Ode07.  The CSCI is a predictive index of stream health that compares the observed taxa and metrics at a site to those expected under reference conditions.  Expected conditions at a site are based on models that estimate the likely macroinvertebrate community in relation to factors that naturally influence biology, e.g., watershed size, elevation, climate, etc.  The CSCI score at a site is based on an observed-to-expected ratio of taxa and a predictive multimetric index composed of six metrics that describe the structure and function of the macroinvertebrate community.  The index score at a site can vary from 0 to ~ 1.4, with values near 1 indicating an observed community similar to reference conditions.  Because the index was developed to minimize the influence of natural gradients, the index scores have consistent meaning across the state [@Reynoldson97].  A threshold score based on a selected lower percentile of scores (e.g., 10%) at all reference sites is used to define nominally low and high scoring sites.

## Building and validating the landscape model

A prediction model of the CSCI was developed to estimate likely ranges of scores associated with land use gradients.  Measures of land use development were quantified for riparian, catchment, and watershed areas of each stream reach in California using the StreamCat database [@Hill16]. CSCI scores were modelled using estimates of canal/ditch density, imperviousness, road density/crossings, and urban and agricultural land use for each stream reach (Table \@ref(tab:crvr)). These variables were chosen specifically to model scores only in relation to long-term constraints on biological condition that are typically beyond the scope of management intervention or where costs to mitigate are likely to be prohibitive.  The remainder of the variation in scores not related to to these landscape constraints could be attributed to additional, unmeasured environmental variables that influence stream biointegrity.  Deviation of observed scores from the model predictions were considered diagnostic of variation not related to landscape effects, although deviations could also be attributed to model error.  The predictive performance of the models is described below.

Models were developed using quantile regression forests to estimate ranges of likely CSCI scores in different landscapes [@Meinshausen06;@Meinshausen17]. Random forests are an ensemble learning approach to predictive modelling that aggregates information from a large number of regression trees and have been used extensively in bioassessment applications [@Carlisle09;@Chen14;@Mazor16;@Fox17].  Random forest models provide robust predictions by evaluating complex, non-linear relationships and interactions between variables relative to more commonly-used modelling approaches [@Breiman01;@Hastie09].  Quantile models, such as quantile regression forests, evaluate the conditional response across the range of values that are expected, in contrast to conventional models that provide only an estimate of the mean response [@Cade03]. This modelling approach allows use of predictions to describe where bioassessment targets are unlikely to be met or where streams are unlikely to be impacted by placing bounds on the range of expectations relative to landscape constraints. Quantile regression forests were used to predict CSCI scores in each stream reach from the 5th to the 95th percentiles of expectations at five percent intervals (i.e., 5th, 10th, etc.) up to the 45th and 55th percentiles. 

Calibration data for the landscape model was based on a random selection of 75% of reaches with observed CSCI scores and where sufficient data were available in StreamCat (n = 1965 reaches).  The random selection was stratified by major regions in California (Figure \@ref(fig:calimap)), with each further divided into quartiles based on watershed imperviousness.  The stratification method was chosen to adequately represent landscape gradients in each ecoreg. For example, the 1st quartile of watershed imperviousness of all reaches in the South Coast was greater than the 3rd quartile of imperviousness of all reaches in the North Coast region. The remaining sites were used for model validation (n = 655). Where multiple samples were available at a single site, one was selected at random for both calibration and validation purposes. Model performance was assessed for the statewide dataset and within each major region.  Differences between observed CSCI scores and median predictions were evaluated using Pearson correlations and root mean squared errors (RMSE).  Regression analysis between predicted and observed scores was used to assess potential bias based on intercept and slope values differing from 0 and 1, respectively.

## Statewide application of the landscape model

We applied the landscape model statewide and in major regions of California to estimate the extent of streams in different constraint classes. Using the model results, each stream reach was assigned to one of four classes (Table \@ref(tab:clsdef)): 

* Likely unconstrained
* Possibly unconstrained
* Possibly constrained 
* Likely constrained

Classifications were based solely on the intersection of the modelled CSCI expectations at a reach with a chosen CSCI threshold, where expectations could be below, above, or overlapping the threshold.  Two decision points were considered for their importance in defining reach classification:

1) The selected range of CSCI expectations at a reach from the model(Figure \@ref(fig:ridges)a,b), chosen as the 10th to 90th percentile of model predictions.
2) The CSCI threshold to define nominally low or high scores (Figure \@ref(fig:ridges)), chosen as 0.79 following previous examples [@Mazor16].  

Stream reaches with the range of CSCI score expectations entirely below the threshold were considered likely constrained, whereas those with expectations entirely above were considered likely unconstrained.  Reaches with score expectations that overlapped the CSCI threshold were considered possibly constrained or possibly unconstrained, where distinction between the two was based on location of the median expectation of a reach relative to the threshold (Table \@ref(tab:clsdef)).  

CSCI scores from biomonitoring data were then used to define relative sites scores at a sample site given the stream reach classification (Figure \@ref(fig:ridges)d). This provided a definition to understand the observed score relative to the biological context (i.e., expectation) of a reach. For each of the four reach classifications (likely constrained, possibly constrained, possibly unconstrained, and likely unconstrained), relative site scores were defined based on location to the range of expected CSCI scores. Sites with observed scores above the upper limit of the reach expectation (e.g., above the 90th percentile of expected scores) were considered "over scoring" and sites below the lower limit (e.g., 10th percentile) were "under scoring".  Sites with CSCI scores within the range of expectations were scoring as "expected" within the context of the landscape model.   

## Landscape factors associated with constraints

Factors explaining variation between constrained and unconstrained stream reaches were evaluated for the major regions in California (Figure \@ref(fig:calimap)). Only a select subset of variables in StreamCat were used to develop the landscape model, with the purpose of describing long-term and broad scale constraints on biointegrity.  Additional landscape measures in StreamCat were evaluated to provide additional insight into alternative factors within each region that were associated with constraints on stream integrity.  Landscape and geological data in StreamCat at the riparian and watershed scale were used to model variation between reach classes using random forest models [@Breiman01]. For each region, 1000 regression trees were created and the mean reduction in accuracy was estimated for the exclusion of each variable across all models. This created an estimate of importance of each variable for describing differences between constrained and unconstrained stream classes. Mean reduction in accuracy was estimated for all variables in each model to identify the top five important variables in each region.  Reach classes as possibly or likely constrained (or unconstrained) were combined to evaluate the complete dataset.    

## Sensitivity analysis of reach classifications

A sensitivity analysis was conducted to evaluate the influence of key decision points on the extent of reach classifications statewide and by major regions in California.  Stream reach classifications depend on the chosen range of score expectations (or certainty) from the landscape model (Figure  \@ref(fig:ridges)b) and the CSCI threshold for defining nominally low or high scores (Figure \@ref(fig:ridges)c).  The 10th and 90th percentile of expected scores at a reach were used as a default range in which a high degree of certainty in the model output is assumed.  The effect of reducing this range (e.g., 25th to 75th percentile) to assume less certainty in the model was evaluated.  Similary, the CSCI threshold was also changed to assess effects of relaxing or increasing flexibility in defining low or high scores. A threshold of 0.79 was used by default as a measure of the 10th percentile of scores at all reference (non-impacted) sites that were used to calibrate the CSCI index [@Mazor16]. This value was increased to examine effects of a more conservative threshold and decreased for a more relaxed threshold.  The combined effects of changing both the certainty in the model and the CSCI threshold were evaluated to estimate the changes in stream extent in each classification.     

## Unclassifiable reaches

Some stream reaches were not classified following application of the landscape model to the statewide hydrography dataset.  Unclassifiable reaches occurred if StreamCat data were unavailable to predict bioassessment expectations using the landscape model or if a reach was excluded from the NHD-plus dataset (typically, small headwater streams).  The former was more common, particularly in developed areas where canals and ditches were sometimes excluded from the natural stream network.  Overall, unclassified reaches were not common in the statewide dataset but they may have regional importance depending on needs of local management groups.  As described below, approximately 15\% of the reaches in the San Gabriel River watershed were unclassifiable and a method for assigning a classification to these reaches was desired by the stakeholder group. 

An approach for assigning biological expectations to unclassified reaches was developed for "typically" urban or agricultural reaches that was based on the range of expectations for reaches with similar land use.  This analysis was conducted statewide and stratified by major regions to account for statewide variation in land use. The approximate range of CSCI scores in unclassifiable reaches were defined for three different gruops: reaches dominated by either 1) urban, 2) agricultural, or 3) open (i.e., lack of urban or agricultural land use).  The three groups were identified using kmeans clustering of percentage land use estimates that were available across reaches [@MacQueen67].  This created groups of reaches with similar land use types, where membership of a reach within a particular group was based on the minimum difference in land use estimates for a reach from the group average for each land use type (within-group centroid).  The two groups that were dominated by agricultural or urban land use were identified based on the largest centroid average of the clusters for each land use type.  The third "open" group that was defined by a lack of urban and agricultural land use was identified by the minimum sum of the centroid values for the two land use types.  The expected range of CSCI scores for the three groups were based on averages from the landscape model for reaches with available predictions. 

## Defining management priorities in the San Gabriel River watershed 

A framework for identifying site priorities for management actions using the landscape model was developed through engagement with a local stakeholder group. The San Gabriel River Regional Monitoring Program (SGRRMP) includes stakeholders from local municipalities, water districts, water quality regulatory agencies, consulting groups, and non-government organizations that cooperatively work to increase awareness of issues in the SGR watershed and improve coordination of compliance and ambient monitoring efforts. The stakeholder workgroup met monthly over a six-month period to discuss model application and to refine the interpretation of results.

A strong land-use gradient occurs in the SGR watershed that creates challenges for managing stream health (Figure \@ref(fig:sgrshd)). Headwaters begin in the San Gabriel mountains where the land is primarily undeveloped or protected for recreational use, whereas the lower watershed is in a heavily urbanized region of Los Angeles County.  The San Gabriel river is dammed at four locations for flood control in the upper watershed and is hydrologically connected to the Los Angeles river to the west through the Whittier Reservoir in the lower watershed. Spreading grounds are present in the middle of the watershed for groundwater recharge during high flow.  Nearly all of the stream reaches in the lower half of the watershed are channelized with concrete or other reinforcements. Approximately half of the monitored sites in the watershed are in poor biological condition, all of which are in the lower watershed.  Pioritizing among the many sites that require some management intervention was a critical objective of the stakeholder group in applying the landscape model.

The stakeholder group identified priorities in the watershed by first describing the types of management actions that were desired. Stakeholders identified their relevant priorities by evaluating the different site types that were possible from the landscape model relative to the stream class (under-scoring, expected, over-scoring for each of four reach classes).  The priorities were also defined by considering if an observed CSCI score at a site was above or below a potential biological threshold, in addition to the scoring expectation for the stream class (Table \@ref(tab:typetab)).  To facilitate the process, a template was used that showed the site scores relative to the reach classifications (Figure \@ref(fig:pritem), left side).  The priorities defined by the group were generalized into three categories:

* Investigate:  Suggest additional monitoring or review of supplementary data (e.g., field visits, review aerial imagery) to characterize why a site is scoring above or below an expectation, or above or below a biological objective given the expectation;
* Protect: Require additional scrutiny of any proposed development and/or projects for sites that score above the expectation; 
* Restore: Pursue targeted action for causal assessment and/or restoration activity for sites that score below the expectation.  

One to many priorities were assigned as low, medium, or high priorities for the scoring possibilities that could occur at a site.  The priority assignments were also made with the explicit recognition that any recommendations are in addition to baseline monitoring and maintenance that is currently provided by existing management programs [@SWAMP17]. The priorities also assumed that existing information available for each site was "true" following established practices to account for uncertainty or variation between assessments.

The interactive and online Stream Classification and Priority Explorer (SCAPE) tool was created for the stakeholder group to facilitate the recommendation of management actions for each site type (Figure \@ref(fig:app)).  This application provided maps of the extent and type of classification for reaches in the watershed, deviation of observed CSCI scores from the expectation, and maps of recommended priority actions that were assigned to each of the scoring possibilities.  The SCAPE tool also allowed the stakeholders to modify key decision points in the model (i.e., range of expectations that were used from the model, selected biological threshold) to evaluate how these changes propogated to changes in recommended priorities for each site.

# Results

## Model performance

The landscape model was used to predict an expected range of CSCI scores for `r nrow(comid_prd)` stream reaches in California.  The bioassessment dataset used to develop the model included `r sum(csci_comid$SelectedSample %in% 'Selected')` unique field observations assigned to stream reaches in the NHD-plus dataset. Model performance statewide indicated generally good agreement between observed CSCI scores and the median prediction for the associated stream reach (Table \@ref(tab:perftab)).  Agreement between observed and predicted values for the entire calibration dataset was r = 0.84 (Pearson) and RMSE = 0.14.  The intercept and slope for a regression between observed and predicted values were 0.24 and 0.72, suggesting a slight negative bias of predictions at lower scores and slight positive bias at higher scores.  The statewide calibration data showed similar results, with slightly smaller correlation (r = 0.72) and larger RMSE (0.18) estimates.  

The landscape model performed well in regions with a mix of urban, agricultural, and open land, such as the South Coast, where strong gradients occur in many watersheds.  Conversely, the model did not perform well in regions where developed landscapes were less common, such as the Sierra Nevada region.   Model performance was best in regions wih extensive urban development. Performance for the Chapparal and South Coast regions were comparable or slightly improved compared to the statewide dataset for both the calibration and validation datasets.  Model predictions for the Central Valley, Desert Modoc, and North Coast regions had slightly lower performance compared to the statewide results, with correlations of approximately 0.75 with observed values in the calibration dataset and 0.55 in the validation dataset.  Model performance was weakest for the Sierra Nevada region, where timber harvesting, rather than urban or agricultural development, is the most widespread stressor. Overall, model performance was strongly associated with land use gradients in each region (Figure \@ref(fig:perflu)).  

## Statewide patterns 

Statewide patterns in stream constraints were apparent from the results of the landscape model consistent with land use (Figure \@ref(fig:calires)).  A majority of reaches statewide were classified as possibly constrained (11% of all stream length) or possibly unconstrained (46%), whereas a minority were likely constrained (4%) or likely unconstrained (39%) (Table \@ref(tab:reltot)). Large rivers across the state were more commonly classified as possibly constrained (e.g., Klamath, Sacramento, Colorado rivers).  By region, the most reaches classified as likely unconstrained reaches were in the Sierra Nevada (50%), North Coast (46%), and Desert Modoc (46%) regions, whereas the most reaches as likely constrained were observed in the Central Valley (22%) and South Coast (15%) regions.  Overall, stream reaches were more often constrained for biotic integrity in regions with more development, either as urban or agricultural land.  For example, likely constrained reaches were apparent from the statewide map in coastal reaches of the South Coast where heavy urbanization occurs and in the Central Valley where agriculture is the dominant land use.  Stream reaches were more likely to be unconstrained in regions with less development, with areas in the North Coast and the Sierra Nevada region visible on the map (right, Figure \@ref(fig:calires)). Relative CSCI scores compared to reach expectations were as expected for 80% of the sampled locations statewide, whereas a much smaller percentage of sites were equally under or over scoring (Table \@ref(tab:reltot)).  Similar patterns were observed within regions, although a slightly larger percentage of sites in the Central Valley were under scoring compared to the other regions.  

## Associated drivers of biological constraints and sensitivity analysis

Importance measures from random forest models identified key variables that were associated with differences between constrained and unconstrained reaches between each region (Figure \@ref(fig:calicnstr), see Figure for importance measures of the selected measures in the statewide landscape model).  Relative magnitudes of the importance measures between regions confirmed the estimates of model performance, such that regions where the model performed well (e.g., South Coast, Central Valley) had higher importance measures than those where the model did not perform well (e.g., North Coast, Sierra Nevada).  The top five most important variables were similar between regions although some specific differences were observed.  The amount of biological nitrogen fixation in watershed soils was ranked the most important variable for the Central Valley, Desert Modoc, and North Coast region and second most important for the Chapparal and Sierra Nevada regions.  This variable was not in the top five for the South Coast region, which was exclusively described by imperviousness and urbanization. Soil erodibility was the most important variable in the Chaparral and Sierra Nevada regions.  Other important variables that were shared between regions (excluding the South Coast) were fertilizer applications and the amount of crops and hay at the riparian and watershed scale.

Sensitivity analyses underscored the potential impact of key decision points of the landscape model on estimates of the extent of streams in each class (Figure \@ref(fig:sensplo)). Decreasing the certainty of predictions from the landscape model by choosing a narrower range of scores (5th/95th to 45th/55th at 5% intervals) increased the number of streams from the possible to likely category in both constrained and unconstrained reaches.  Similarly, changing the CSCI threshold from relaxed to more conservative (0.63, 0.79, 0.92) increased the number of streams classified as possibly or likely constrained and decreased the number of streams as possibly or likely unconstrained.  Changes by region with the different scenarios were also observed.  For example, over 80% of reaches in the Central Valley were classified as likely constrained using a conservative CSCI threshold with low certainty of predictions, whereas less than 1% of reaches were in this category using a relaxed CSCI threshold with the highest level of certainty.  Opposite trends were observed in regions with reduced land use  pressures.  For example, almost all stream reaches in the North Coast and Sierra Nevada regions were classified as likely unconstrained using a relaxed CSCI threshold and low certainty of predictions.

## Unclassified reaches

Ranges of expected CSCI scores for typical reaches in urban, agricultural, and open (neither urban, nor agriculture) are shown in table \@ref(tab:typscrs). These typical values are shown for more to less certainty in the range of predictions.  Unclassified reaches can be defined by the dominant watershed land use as urban, agricultural, or open, and then matched to the appropriate values in the table.  Between regions, the variation in expected scores also provides context for landscape pressures that differ by location.  For example, the expected range of scores in regions with heavy urban development (e.g., South Coast) are much lower than streams that are neither urban nor agricultural.  The North Coast region in contrast has an expected range of scores in urban streams that is similar to streams that are open. The range of scores in urban and agricultural streams were similar in the Central Valley where agriculture is the dominant land use.  

## San Gabriel River Case study

```{r}
##
# ggplot of sgr site expecations, relative scores

# requires spat, scrs

thrsh <- 0.79; tails <- 0.1

##
# get biological condition expectations
cls <- getcls2(spat, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  mutate(COMID = as.character(COMID)) 

# get csci difference
sgrscrs <- spat %>% 
  dplyr::select(COMID, core0.50) %>% 
  mutate(COMID = as.character(COMID)) %>% 
  left_join(scrs, ., by = 'COMID') %>% 
  group_by(COMID, StationCode, lat, long) %>% 
  summarise(
    csci = mean(csci, na.rm = TRUE)
  ) %>% 
  ungroup %>%
  left_join(cls, by = 'COMID')

# get percentage of stream lengths in SGR in each class
lens <- cls %>% 
  mutate(COMID = as.numeric(COMID)) %>% 
  left_join(spat, ., by = 'COMID') %>% 
  dplyr::select(COMID, strcls) %>% 
  as('Spatial') %>% 
  sp::SpatialLinesLengths(longlat = T)
clslen <- cls %>% 
  mutate(lens = lens) %>% 
  group_by(strcls) %>% 
  summarise(lens = sum(lens)) %>% 
  filter(!is.na(strcls)) %>% 
  mutate(
    lenper = 100 *  lens / sum(lens), 
    lenper = round(lenper, 0)
    ) %>% 
  dplyr::select(-lens) %>% 
  spread(strcls, lenper)

```

Engagement of the stakeholder group demonstrated how management actions can be prioritized through application of the landscape model using the SCAPE tool.  About 750 reaches in the SGR were identified and classified from NHD-plus, of which 10% were visited for bioassessment sampling.  CSCI scores ranged from `r round(min(sgrscrs$csci), 2)` to `r round(max(sgrscrs$csci), 2)` consistent with heavy urban development in the lower watershed and open land use at higher elevation in the upper watershed (Figure \@ref(fig:sgrshd)a).  Application of the landscape model results to the CSCI scores provided a context of expectations consistent with the strong land use gradient in the watershed (Figure \@ref(fig:sgrresplo)).  Stream reaches in the upper watershed were a mix of likely and possibly unconstrained (`r clslen[['likely unconstrained']]`% and `r clslen[['possibly unconstrained']]`%), whereas stream reaches in the lower watershed were classified as likely and possibly constrained (`r clslen[['likely constrained']]`% and `r clslen[['possibly constrained']]`%).  Several reaches in the lower watershed had ranges that were right-skewed toward very low CSCI scores consistent with extreme landscape pressures (bottom left, Figure \@ref(fig:sgrresplo)b).

Using a CSCI threshold based on the 10th percentile of reference calibration sites (i.e., 0.79, @Mazor16) and a relatively wide range of expected scores from the 10th to the 90th percentile of the model predictions, only six sites were under-scoring (two likely unconstrained and four likely constrained) and eight sites were over-scoring (five likely constrained, one possibly unconstrained, and two likely unconstrained) (top, Figure \@ref(fig:sgrresmap)).  One of the under-scoring sites in the likely unconstrained class was below the hypothetical CSCI threshold. One site scoring as expected in the possibly unconstrained class was below the chosen CSCI threshold, whereas none of the constrained (possibly or likely) sites were above the threshold. 

In general, the stakeholder group assigned high priority recommendations to over- and under-scoring sites in likely unconstrained reaches or those below the biological threshold with possibly unconstrained classification (Figure \@ref(fig:pritem)).  Continuing current practices were generally recommended at constrained sites or restoration actions were recommended as a low priority despite low CSCI scores. Recommended actions to investigate were more common for both over scoring and under scoring sites, protect was more common at over scoring sites, and restore was more common at under scoring sites.  A clear distinction between low and high priority actions was observed on the watershed map (bottom, Figure \@ref(fig:sgrresmap)). Sites in the lower watershed were lower priority if an action was recommended, whereas the four high priority sites were in the upper watershed.  Several sites that were scoring as expected for likely and possibly unconstrained reaches in the upper watershed were recommended as medium priority for protection.

# Discussion

The landscape model was able to identify the location and extent of biologically constrained channels at the state level and major regions in California.  Our application to the SGR watershed demonstrated how the results of the model can be used at a spatial scale where many management decisions are implemented through close interaction with a regional stakeholder group with direct interests in the local resources.  Overall, the models provide tools that allow managers to determine how best to use limited resources for stream management by focusing on reaches where recommended actions are most likely to have the intended outcome of improving or protecting biological condition.  The approach also leverages all available information to develop a context for biological assessment that provides an unambiguous expectation of what is likely to be achieved at any sampling location. This can facilitate more targeted management actions that vary depending on the identified context and can also inform decisions on extent and effort for future monitoring locations.   

Results from our analyses also have implications for managing biological impairments under state or federal water quality mandates.  The landscape model could be used to evaluate the list of sites that are not meeting biological objectives by identifying locations where constraints may limit options for restoration.  This can provide flexibility by focusing efforts in locations that can be most effectively targeted for actions such as TMDL limits or review of permitting.  Further, the ability to evaluate the effects of changing proposed biological thresholds (e.g., tenth percentile of scores at reference sites) and certainty in the model conclusions (i.e., range of biological expectations) on the location and extent of constrained channels provides a means of choosing alternative scenarios for rule-making. A critical objective in allowing this flexibility is not to enable a discounts against sites that are less likely to achieve potential criteria, but rather to facilitate the decision-making process through a more transparent application of the model. Our results showing the change in stream length statewide and by region as related to potential thresholds and model certainty is a direct demonstration of this concept.  This exercise could also be downscaled to an individual watershed to aid in rule-making.  

The above paragraph also has implications for identifying high ocon
What does the model mean vis a vis Pete's comments - what variables did we include and how can we improve on this for more resolution depending on the region.  Bias toward urban streams?  What about time scale of impacts?  What about possibility of model error?  In regards to weak performance in the north coast, Rafi says: In the discussion, we should state explicitly that our model leads us to the conclusion that this region is generally unconstrained, and then we should evaluate if this is true. Cite a few studies about whether a stream can ever recover from a clearcut.  Andy has a yet-to-be-published study showing that modern forestry practices are generally good for CSCI scores, although historic impacts might really be constrained by massive sediment pulses that will take decades/centuries to work their way through the systems.


## Landscape constraints can be described using biological endpoints

Our approach has the advantage of relating strictly to biological condition, as compared to physical or chemical endpoints to assess constraints.  This approach has relevance from the perspective of ecological interpretation as well as potential implications for regulatory standards.  The ability of the landscape model to predict the range of expected biological condition at a given site reflects an associative link between land use and stream biology.  However, similar arguments that have been made for the use of biological indicators over chemical and physical indicators for assessment can be applied to identifying constraints with the landscape model. A limited range of expectations at the lower end of the distribution of CSCI scores is an indication that stressors originating from the landscape have imposed habitat limits that constrain biology.  A landscape model that is calibrated for physical or chemical endpoints may not sufficiently describe condition given that a constraint on either may not adequately characterize a constraint on biology.  From a regulatory perspective, many states, including California, have explicit assessment requirements that relate to biology and the landscape modelling approach is well aligned with existing bioassessment tools.  The use of biological endpoints in the landscape model will likely facilitate the development of biological standards as noted above.  Landscape models could also be used to support conservation planning, particularly at the watershed scale.  Ongoing work in California has focused on setting priorities for managing biodiversity that focus on watersheds within a conservation network [@Howard18].  Results from the landscape model could be used to enhance this network by providing supporting information on constraints in an assessment framework. 

Our approach to predict biological condition using landscape constraints also has advantages over other methods that define constraints based only on channel modification.  Several states have recommended alternative use designations for applying bioassessment criteria in modified channels [@FLDEP11;@USEPA13;@MBI16].  Our results generally support this approach, although defining constraints based only on channel modification may be insufficient. Physical habitat quality can be limited in engineered channels and our models identified many of these locations in our case study.  However, these channels were identified as constrained based on land use only. Constrained channels in rural landscapes (e.g., the mainstem of the Klamath and Russian rivers in the North Coast region) were also identified by the model, as well as many streams in agricultural areas (e.g., Salinas River).  The ability of the model to identify these locations was not accidental given the landscape variables that were used to develop the bioassessment predictions.  In the context of the model, a constrained channel may or may not be engineered, but an engineered channel will typically be classified as constrained given the surrounding land use.  Modified channels may also be present in undeveloped landscapes and high bioassessment scores have been observed in armoured streams within national forest lands [@Stein13]. A classification framework for biological constraints using only channel modification would provide incomplete information relative to an approach using landscape information. These results are well supported by other landscape studies, particularly for macroinvertebrates [@May15].


## Engagement of local stakeholders is critical for regional application

Application of the landscape model to define potential management actions was effectively enabled through close interaction with our regional stakeholder group.  The group was convened specifically to explore how the statewide model could be applied to inform decision-making at the watershed-level. The identified actions for monitoring sites in the San Gabriel watershed was chosen by discussion among the stakeholders that represented different interests (i.e., regulators, dischargers, consultants, and environmental advocates).  The final decision by the group to prioritize management actions for the different sites in broad categories of protect, restore, and monitor was based on an iterative process where ideas were discussed and shared freely among stakeholders.  Priorities were never assumed such that the recommended actions were defined through iterative discussion by the group.  This approach ensured that stakeholders were generally in agreement with the final product and, therefore, more likely to adopt the recommendations provided by these tools in formal decision-making. The recommended actions have relevance only in the context of interests of the San Gabriel River Regional Monitoring Program. Application of the statewide model to other watersheds must engage local stakeholders in a similar process to develop recommendations that are adequate to meet regional needs.  

The development of the SCAPE tool (see supplement) was also critical for engaging the stakeholder group.  The tool was developed to achieve the dual purposes of demonstrating concepts applied by the model and allowing stakeholders to iteratively evaluate scenarios for defining stream classifications and priorities. Initial challenges in engaging stakeholders were encountered wherein a complete understanding of concepts, as well as limitations, of the model was insufficient for discussing regional application to the SGR watershed.  The tool provided a means of demonstrating these concepts that was not possible through more conventional methods, such as static presentations or simple text vignettes. SCAPE also allowed stakeholders to explore the key decision points that affect the model output, specifically related to changing certainties in the CSCI score predictions and the ability to explore alternative thresholds for biological objectives.  This functionality is key in our approach to allow the stakeholders to develop recommendations that are completely independent of the model, i.e., decisions are not hard-wired into the model nor SCAPE. Because of this tool, this stakeholder group has a better understanding of the potential impacts of biointegrity policies currently under review in California, and will therefore have more meaningful engagement in the development and implementation of these policies.  Application of the landscape modelling approach to other regions will benefit from similar tools that can easily be developed.

## The landscape model is a tool for exploring options

The primary objective of developing the landscape model was to provide a screening tool for exploring biological constraints to facilitate a discussion of management options relative to site contexts.  These models are not intended for developing regulatory designations for individual sites, nor are they sufficient by themselves as a use attainability assessment at constrained sites. Instead, they can help identify a small set of sites where more intensive analyses may be appropriate. The landscape model is associative by design and does not identify mechanistic links between biological constraints and proximal causes.  Further, a distinction between constraints on biological condition and channel modification is implicit such that indication of the former by the model does not explicitly indicate presence of the latter.  As noted above, our results consistently indicated that engineered channels are biologically constrained, but the model is based on an a priori selection of land use variables to predict biotic integrity.  A correspondence between habitat limitations and channel modification is likely in many cases but data are insufficient to evaluate biological effects statewide relative to land use constraints.  Moreover, bioassessment scores can be similar in modified channels compared to natural streams independent of watershed land use [@Stein13].  The landscape model describes constraints at scales larger than instream characteristics as a necessary approach to accurately predict bioassessment scores.  More comprehensive assessments at individual sites are needed to diagnose the immediate causes of degraded condition.       

An additional consideration in applying the model to inform management decisions is the meaning of biologically constrained in the context of macroinvertebrate communities.  Biologically constrained sites were considered those where landscapes were likely to limit the bioassessment index.  The CSCI provides an indication of stream health by estimating the macroinvertebrate community that is likely to be present under factors that naturally influence biology for the region and comparing the observed community to the estimate.  A constrained site as estimated by the landscape model is only constrained relative to the macroinvertebrate community.  In many cases, poor biotic condition of the macroinvertebrate community translates to poor stream condition.  However, a constrained macroinvertebrate community does not always mean other biological attributes of stream health (e.g., fish assemblages) are also constrained.  Many urban streams can support diverse algal assemblages such that algal-based measures of biotic condition may alternatively suggest good biotic condition relative to macroinvertebrate-based indices. The focus of the landscape model on a specific taxa is not unique to other bioassessment tools and application to other taxa as alternatives lines of evidence is needed for a more complete condition assessment.

## Additional applications of the landscape model

The utility of landscape models in supporting watershed management has applications outside of California. Our use of national geospatial datasets (i.e., NHDPlus, @McKay12; StreamCat, @Hill16) means that these methods could be applied elsewhere in diverse bioassessment contexts. The CSCI was developed for macroinvertebrate assessment in California, but this approach could be applied with other methods, such as a multi-metric index (the most common bioassessment approach within the US; @Buss14), O/E assessments [@Moss87], biological condition gradients [@Davies06], or with other biological endpoints (e.g., fish or diatoms). In addition, extension of the landscape model could be explored to develop a national scale product of constraints on biological condition to complement recent work that predicted probable biological conditions with the National Rivers and Streams Assessment [@Hill17].  

Extension of the landscape models to prioritize conservation or restoration beyond California should consider landscape stressors that are predictive of biotic condition in other regions. For example, urban and agricultural gradients were sufficient to characterize constraints in many regions of California, whereas @Hill17 found that the volume of water stored by dams was an important predictor of biological condition in the Northern Appalachian and Northern Plains regions of the US. In their paper, @Hill17 provided an example of how predictive models could be used to identify potential sites for restoration or conservation, however, their illustration did not explicitly identify sites that were over- or under-performing relative to a biological endpoint. Doing so in California provided stakeholders with important context that helped establish management priorities, demonstrating the potential utility of this approach in other states.

## Summary

The prevalence of degraded stream sites in California requires the use of 1) assessment tools that can accurately evaluate condition, and 2) tools that can provide a context for evaluating assessment tools.  The landscape model was developed to better inform application of the CSCI to inform decision-making in the context of landscape constraints on biological condition.  Statewide development of the tool demonstrated where streams are likely constrained on a regional basis, whereas application to the SGR watershed demonstrated how the tool can be used by local stakeholders to prioritize management actions that are informed by landscape context. Most importantly, this tool does not provide a prescription for causes of impairment, nor does it discount sites from management intervention if constraints are high.  The landscape model can inform the interpretation of biotic condition and is an exploratory tool that can help identify where management goals are most likely to be achieved. 
     
# Supplement

The SCAPE model application website: [http://shiny.sccwrp.org/scape/](http://shiny.sccwrp.org/scape/)

# Figures

```{r calimap, fig.height = 4.5, fig.width = 7, fig.cap = 'Urban and agricultural land use (left) and distribution of observed stream CSCI scores (right) in California. Cover of urban and agricultural land use in stream watersheds was used to develop a landscape model for stream reach expectations of bioassessment scores.  Grey lines are ecoregions in California, CV: Central Valley, CH: Chaparral, DM: Deserts and Modoc Plateau, NC: North Coast, SN: Sierra Nevada, SC: South Coast.'}

lucol <- c('grey80', 'grey45')

# country base
country <- map_data('state')

# state base
calista <- map_data('state', region = 'california')

# psa data fortified
psadat <- calipsa %>% 
  as('Spatial') %>%
  as.data.frame %>% 
  rownames_to_column('id') %>% 
  dplyr::select(id, PSA6) %>% 
  dplyr::rename(PSA = PSA6) %>% 
  mutate(Region = factor(PSA, 
    levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
    labels = c('CV', 'Ch', 'DM', 'NC', 'SN', 'SC')
    ))
psafrt <- calipsa %>% 
  dplyr::select(-PSA_REGION, -AREA, -PERIMETER, -PSA8) %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(psadat, by = 'id')

# psalab
psalab <- psalab %>% 
  mutate(
    lat = ifelse(Region == 'CV', 37.26575, lat), # fiddle with locs
    long = ifelse(Region == 'CV', -120.6, long),
    lat = ifelse(Region == 'CH', 36, lat),
    long = ifelse(Region == 'CH', -121, long),
    Region = as.character(Region),
    Region = paste0('bold(', Region, ')')
  )
    
# land use data fortified  
toplo <- ludat %>% 
  as('Spatial') %>% 
  fortify %>% 
  filter(id %in% c(2, 3)) %>% 
  mutate(id = factor(id, levels = c(2, 3), labels = c('Agriculture', 'Urban'))) %>% 
  dplyr::rename(`Land use` = id)

# csci seq for color pal
palseq <- range(csci_raw$CSCI, na.rm = T) 
palseq <- seq(palseq[1], palseq[2], length = 5)

p1 <- ggplot() + 
  geom_polygon(data = toplo, aes(x = long, y = lat, fill = `Land use`, group = group)) + 
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.7), size = 0.1) +
  geom_polygon(data = calista, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.7))

# text with outline magic
theta <- seq(pi/8, 2*pi, length.out=16)
xo <- diff(range(psalab$long))/200
yo <- diff(range(psalab$lat))/200
for(i in theta) {
  p1 <- p1 + geom_text_repel(data = psalab, 
    aes_q(x = bquote(long +.(cos(i)*xo)),
          y = bquote(lat +.(sin(i)*yo)),
          label = ~Region), point.padding = NA, parse = T, family = 'serif', size = 6.5, colour = 'black')
    
}
p1 <- p1 + 
  geom_text_repel(data = psalab, aes(x = long, y = lat, label = Region), point.padding = NA, parse = T, family = 'serif', size = 6.5, colour = 'white') + 
  coord_map() + 
  scale_fill_manual(values = lucol) +
  theme_void(base_family = 'serif') + 
  theme(
    legend.position = 'top'
    ) + 
  guides(fill = guide_legend(ncol = 3)) +
  ggsn::scalebar(location = 'bottomleft', y.min = 33, y.max = 35, x.min = -124, x.max = -120, 
           dist = 150, st.dist=.15, st.size = 3, height = 0.1, dd2km = T, model = 'WGS84')

p2 <- ggplot(csci_raw, aes(x = Longitude, y = Latitude, colour = CSCI)) +
  scale_colour_gradientn(colours = pal(palseq)) +
  geom_point(size = 1.25) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.1, colour = scales::alpha('black', 0.5)) +
  geom_polygon(data = calista, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.5)) +
  coord_map() + 
  theme_void(base_family = 'serif') + 
  theme(legend.position = 'top') + 
  guides(colour = guide_colourbar(barheight = 0.5, barwidth = 8))

pinset <- ggplot(country, aes(x = long, y = lat, group = group)) +
  geom_polygon( fill = NA, color = "black", size = 0.3) +
  geom_polygon(data = calista, fill = 'black', color = "black", size = 0.3)+
  coord_map() +
  theme_void() 

grid.newpage()
v1 <- viewport(width = 1, height = 1, x = 0.3, y = 0.5) 
v2 <- viewport(width = 1, height = 1, x = 0.7, y = 0.5) 
v3 <- viewport(width = 0.25, height = 0.25, x = 0.85, y = 0.65)

# png('figs/calimap.png', height = 4.5, width = 7, units = 'in', res = 300, family = 'serif')
print(p1, vp = v1) 
print(p2, vp = v2)
print(pinset, vp = v3)
# dev.off()
```

```{r sgrshd, fig.height = 8, fig.width = 6, fig.cap = 'San Gabriel River watershed in southern California. Land cover is shown in plot (a) and the predicted median CSCI scores at each stream reach and observed CSCI scores are shown in (b). The watershed is largely undeveloped in the north and heavily urbanized in the south.'}

# land use raster data
luplo <- sgrlu %>% 
  rasterToPoints %>% 
  data.frame %>% 
  dplyr::rename(`Land cover` = layer) %>% 
  mutate(`Land cover` = factor(`Land cover`, levels = c(5, 4, 3, 2, 1), labels = c('Urban: hi', 'Urban: md', 'Urban: lo', 'Open: forest', 'Open: chaparral'))) 

# hydrolines
spatdat <- spat %>% 
  dplyr::select(COMID, core0.50) %>% 
  mutate(id = as.character(1:nrow(.)))
st_geometry(spatdat) <- NULL
spatfrt <- spat %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(spatdat, by = 'id') %>% 
  mutate(COMID = as.character(COMID)) %>% 
  left_join(scrs, by = 'COMID') %>% 
  mutate(csci_diff = csci - core0.50) %>% 
  filter(!is.na(core0.50))

# wshed boundary fortified
shedfrt <- shed %>% 
  as('Spatial') %>% 
  fortify 

# land use colors
lucol <- c('grey20', 'grey40', 'grey60', 'khaki3', 'khaki2')

# psa data fortified
psadat <- calipsa %>% 
  as('Spatial') %>% 
  as.data.frame %>% 
  rownames_to_column('id') %>% 
  dplyr::select(id, PSA6) %>% 
  dplyr::rename(PSA = PSA6) %>% 
  mutate(Region = factor(PSA, 
    levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
    labels = c('CV', 'Ch', 'DM', 'NC', 'SN', 'SC')
    ))
psafrt <- calipsa %>% 
  dplyr::select(-PSA_REGION, -AREA, -PERIMETER, -PSA8) %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(psadat, by = 'id')

palseq <- seq(palseq[1], palseq[2], length = 5)

# pinset
pinset <- ggplot() + 
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, colour = scales::alpha('black', 0.5), size = 0.2) +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'tomato1') +
  theme_minimal() + 
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(), 
    axis.text = element_blank(), 
    axis.title = element_blank()
    ) + 
  coord_map()

# csci seq for color pal
seqcsc <- range(spatfrt$csci, na.rm = T) 
seqcsc <- seq(seqcsc[1], seqcsc[2], length = 5)

# color legend
colleg <- ggplot() +
  geom_point(data = spatfrt, aes(x = long.y, y = lat.y, colour = csci)) +
  theme_bw(base_family = 'serif') +
  theme(
    legend.position = 'top',
    legend.justification = 'left',
    legend.box.just = 'left',
    legend.box = 'vertical'
  ) +
  scale_colour_gradientn('CSCI', colours = pal(seqcsc)) +
  guides(colour = guide_colourbar('CSCI', barheight = 0.55, barwidth = 8, title.position = 'top'))
colleg <- g_legend(colleg)

# separate lu legend
luleg <- ggplot(luplo) + 
  geom_tile(aes(x, y, fill = `Land cover`), alpha=0.8) +
  theme_bw(base_family = 'serif') +
  theme(
    legend.position = 'top', 
    legend.justification = 'left',
    legend.box.just = 'left',
    legend.box = 'vertical'
  ) +  
  scale_fill_manual('Land cover', values = lucol) +
  guides(fill = guide_legend(ncol = 2, title.position = 'top'))
luleg <- g_legend(luleg)
  
# land use plot
p1 <- ggplot(luplo) + 
  geom_tile(aes(x, y, fill = `Land cover`), alpha=0.8) +
  theme_void(base_family = 'serif') +
  scale_fill_manual('Land cover', values = lucol) +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = NA, colour = 'black', alpha = 0.7) +
  coord_equal() +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = 'none', 
    axis.title = element_blank()
    ) +
  ggtitle('(a) Land cover in the San Gabriel watershed')

# hydrolines plot with CSCI pts
p2 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long.x, y = lat.x, group = id, colour = core0.50, linetype = 'Reach predicted\nmedian CSCI')) +
  scale_colour_gradientn(colours = pal(seqcsc)) +
  geom_point(data = spatfrt, aes(x = long.y, y = lat.y, fill = csci, shape = 'Observed CSCI'), size = 3, alpha = 0.9) +
  scale_fill_gradientn('', colours = pal(seqcsc)) +
  scale_linetype_manual('', values = 'solid') +
  scale_shape_manual('', values = 21) +
  ggsn::scalebar(location = 'bottomright', y.min = 33.77, y.max = 33.8, x.min = -118, x.max = -117.7, dist = 10, st.dist=.5, st.size = 3, height = 0.3, dd2km = T, model = 'WGS84') +
  guides(fill = F, colour = F) +
  coord_equal() +
  theme_void(base_family = 'serif') +
  theme(
    # legend.position = 'top',
    legend.justification = 'left',
    # legend.box.just = 'left'#,
    axis.title = element_blank()
    ) + 
  ggtitle('(b) Reach median predictions and observed scores for the CSCI')
p2leg <- g_legend(p2) 
p2 <- p2 + theme(legend.position = 'none')

# png('figs/sgrshd.png', height = 8, width = 5.5, units = 'in', res = 300, family = 'serif')
grid.arrange(
  arrangeGrob(p1, 
              arrangeGrob(pinset, luleg, ncol = 1, heights = c(1, 1)), ncol = 2, widths = c(1, 0.5)),
  arrangeGrob(p2, 
              arrangeGrob(colleg, p2leg, ncol = 1, heights = c(1,1)), ncol = 2, widths = c(1, 0.5)), 
  ncol = 1
)
# dev.off()
```

```{r ridges, fig.height = 8, fig.width = 10, fig.cap = 'Application of the landscape model to identify site expectations and bioassessment performance for sixteen example stream reaches.  A range of CSCI scores is predicted from the model (a) and the lower and upper limits of the expectations are cut to define a certainty range for the predictions (b).  Overlap of the certainty range at each reach with a chosen CSCI threshold (c) defines the stream reach classification as likely unconstrained, possibly unconstrained, possibly constrained, and likely constrained.  The observed bioassessment scores are described relative to the classification as over scoring (above the certainty threshold), expected (within), and under scoring (below) for each of four stream classes (d).'}
##
# plot data

# plot data globals
sel <- 16
bnd <- 0.1
pts <- 2000
qts <- 0.1
thrsh <- 0.79

catcds <- data.frame(
  int = c('111', '011', '001', '000'),
  cls = c('likely unconstrained', 'possibly unconstrained', 'possibly constrained', 'likely constrained'),
  clsabv = c('lu', 'pu', 'pc', 'lc')
)

prfcds <- data.frame(
  int = c('00', '01', '11'), 
  cls = c('over scoring', 'expected', 'under scoring')
)

prflev <- c('over scoring', 'expected', 'under scoring')

scrshyp <- c(1.35, 1.15, 0.84, 0.6, 1.25, 0.95, 0.75, 0.53, 1.1, 0.83, 0.53, 0.35, 1, 0.75, 0.45, 0.15)

# plot data
set.seed(433)
rnd <- data.frame(
  id = factor(rev(1:sel), levels = rev(1:sel)),
  ave = rep(seq(0.5, 1.1, length = 4), each = 4),
  sds = sample(c(0.13), sel, replace = T), 
  scrshyp = rev(scrshyp)
  ) %>%
  group_by(id, scrshyp) %>% 
  nest %>%
  mutate(
    rnd = purrr::map(data, ~ rnorm(pts, .x$ave, .x$sds)), 
    estall = purrr::map(rnd, function(x){
      
      est <- density(x, n = pts, bw = bnd)
      out <- data.frame(
        xout = est$x, 
        hght = est$y
      )
      
      return(out)
      
    }), 
    estcut = purrr::pmap(list(rnd, estall), function(rnd, estall){
      
      qts <- quantile(rnd, c(qts, 1 - qts))
      out <- estall %>% 
        filter(xout >= qts[1] & xout <= qts[2])
      
      return(out)
      
    }), 
    estcat = purrr::map(estcut, function(x){
      
      out <- c(range(x$xout), median(x$xout)) %>% 
        sort %>% 
        findInterval(., thrsh) %>% 
        paste(collapse = '') %>% 
        factor(levels = catcds$int, labels = catcds$clsabv) %>% 
        as.character
      
      return(out)
      
      
    }), 
    prfcat = purrr::pmap(list(estcut, scrshyp), function(estcut, scrshyp){
      
      out <- range(estcut$xout) %>% 
        findInterval(., scrshyp) %>% 
        paste(collapse = '') %>% 
        factor(levels = prfcds$int, labels = prfcds$cls) %>% 
        as.character
      
      return(out)
      
    })
  )

toplo1 <- rnd %>% 
  dplyr::select(id, estall) %>% 
  unnest

toplo2 <- rnd %>% 
  dplyr::select(id, estcut) %>% 
  unnest

toplo3 <- rnd %>% 
  dplyr::select(id, estcut, estcat, prfcat) %>% 
  unnest(estcat, prfcat) %>% 
  unnest %>% 
  mutate(
    prfcat = paste0(prfcat, ' (', estcat, ')'), 
    estcat = factor(estcat, levels = catcds$clsabv, labels = catcds$cls)
  ) %>% 
  dplyr::rename(`Stream class` = estcat)

toplo4 <- rnd %>% 
  dplyr::select(id, scrshyp, estcat, prfcat) %>% 
  unnest %>% 
  mutate(
    prfcat = factor(prfcat, levels = prflev),
    estcat = factor(estcat, levels = catcds$clsabv, labels = catcds$cls),
    hght = scrshyp
  ) %>% 
  dplyr::rename(
    `Relative site score` = prfcat,
    `Stream class` = estcat
    )

##
# plots

# stream class colors
exp_col <- RColorBrewer::brewer.pal(9, 'Paired')[c(2, 1, 5, 6)] %>% 
  alpha(., 0.8)  

# plot globals
ht <- 0.99

# base 
pbase<- ggplot(toplo1, aes(x = xout, y = id, height = hght)) + 
  geom_density_ridges(stat = 'identity', alpha = 0.5, colour = NA, fill = 'grey', scale = ht) +
  scale_x_continuous(limits = c(0, 1.4)) + 
  theme_minimal(base_family = 'serif') + 
  theme(
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    legend.position = 'top'
  )

p1 <- pbase +
  geom_density_ridges(stat = 'identity', rel_min_height = 0.001, colour = 'black', fill = 'darkgrey', scale = ht) +
  scale_fill_gradient2(low = '#d7191c', mid = '#abd9e9', high = '#2c7bb6', midpoint = 1) +
  guides(fill = guide_colourbar('CSCI', barheight = 0.5, barwidth = 5, title.position = 'top')) +
  ggtitle('(a) Range of expected CSCI\nscores for stream reaches')

p2 <- pbase +
  geom_density_ridges(data = toplo2, stat = 'identity', rel_min_height = 0.001, colour = 'black', fill = 'darkgrey', scale = ht) +
  scale_fill_gradient2(low = '#d7191c', mid = '#abd9e9', high = '#2c7bb6', midpoint = 1) +
  ggtitle('(b) Expected CSCI scores\nwithin certainty range') +
  theme(legend.position = 'none')

p3 <- pbase +
  geom_density_ridges(data = toplo3, aes(fill = `Stream class`), stat = 'identity', colour = 'black', scale = ht) +
  geom_vline(xintercept = thrsh, linetype = 'dashed') +
  scale_fill_manual(values = exp_col) +
  guides(fill = guide_legend(title.position = 'top', nrow = 2)) +
  ggtitle('(c) Stream reach classification\nby CSCI threshold')

p4 <- pbase +
  geom_density_ridges(data = toplo3, aes(fill = `Stream class`), stat = 'identity', colour = 'black', scale = ht) +
  geom_vline(xintercept = thrsh, linetype = 'dashed') +
  geom_point(data = toplo4, aes(x = scrshyp, group = id, shape = `Relative site score`, fill = `Stream class`), size = 3) + 
  scale_fill_manual(values = exp_col, guide = F) +
  scale_colour_manual('Site performance', values = pal_prf2(levels(toplo4$`Site performance`)), na.value = 'yellow') + 
  scale_shape_manual(values = c(24, 21, 25)) +  
  guides(colour = guide_legend(title.position = 'top'), shape = guide_legend(title.position = 'top')) +
  ggtitle('(d) Relative site scores by\nstream classification')

p3leg <- g_legend(p3)
p3 <- p3 + theme(legend.position = 'none')

p4leg <- g_legend(p4)
p4 <- p4 + theme(legend.position = 'none')

grid.arrange(
  arrangeGrob(p3leg, p4leg, ncol = 2, widths = c(0.75, 1)),
  arrangeGrob(p1, p2, p3, p4, ncol = 4),
  left = 'Reach type', bottom = 'CSCI scores', ncol = 1, heights = c(0.2, 1)
)
```

```{r app, fig.cap='Screenshot of the Stream Classification and Priority Explorer (SCAPE) tool used by the stakeholder group to interact with and use results from the landscape model.  The application allowed users to visualize results of reach classifications, relative site scores for the CSCI based on the expectation, and recommend management actions for each reach type.  The app can be viewed in the supplementary material.'}
knitr::include_graphics('figs/app.png')
```

```{r perflu, fig.height =  6, fig.width = 6, fig.cap = "Model performance in relation to land cover and land cover by major regions in California. Model residuals (CSCI predicted - observed) were smaller in regions with more urban or agricultural land use (e.g., SC, CV) and larger in regions with less anthropogenic land use (e.g., SN, DM). CV: Central Valley, CH: Chaparral, DM: Deserts Modoc, NC: North Coast, SN: Sierra Nevada, SC: South Coast."}

# observed and predicted data
obsdat <- csci_comid %>%
  dplyr::select(COMID, StationCode, SiteSet, SelectedSample, CSCI, PSA6c, PctImp2006Ws, TotUrb2011Ws, TotAg2011Ws) %>% 
  filter(SelectedSample %in% 'Selected')
prddat <- comid_prd %>% 
  dplyr::select(COMID, core0.50)

# combined data to eval for perf
dat <- obsdat %>% 
  inner_join(prddat, by = 'COMID') %>% 
  dplyr::rename(
    observed = CSCI,
    predicted = core0.50, 
    imperv = PctImp2006Ws, 
    ag = TotAg2011Ws,
    urb = TotUrb2011Ws,
    Region = PSA6c
  ) %>% 
  mutate(
    modrsd = predicted - observed
  ) %>%
  gather('var', 'val', urb, ag) %>% 
  mutate(var = factor(var, levels = c('urb', 'ag'), labels = c('Urban', 'Agriculture')))

col <- c('grey', 'lightsalmon')#RColorBrewer::brewer.pal(8, 'Paired')[c(1, 3)]

# residuals by land use
p1 <- ggplot(dat, aes(x = val, y = modrsd, colour = var)) +
  geom_point(size = 1, alpha = 0.7) +
  theme_bw(base_family = 'serif', base_size = 14) +
  facet_wrap(~var, strip.position = 'bottom', ncol = 2) +
  geom_hline(yintercept = 0) + 
  theme(
    strip.background = element_blank(), 
    strip.placement = 'outside', 
    axis.title.x = element_blank(), 
    legend.position = 'none'
  ) + 
  scale_y_continuous('CSCI predicted - observed', limits = c(-0.65, 0.65)) + 
  scale_colour_manual(values = col)

# land use by region
meds <- dat %>% 
  spread(var, val) %>% 
  group_by(Region) %>% 
  summarise(urbmed = median(log10(Urban), na.rm = T)) %>% 
  arrange(urbmed)

toplo <- dat %>% 
  mutate(Region = factor(Region, levels = meds$Region))
p2 <- ggplot(toplo, aes(x = Region, y = val, fill = var)) + 
  geom_boxplot() +
  scale_fill_manual(values = col) +
  scale_y_log10('% land cover, log10',
                breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x))
  ) +
  theme_bw(base_family = 'serif', base_size = 12) +
  theme(
    legend.position = 'top', 
    legend.title = element_blank(),
    axis.title.x = element_blank()
  )

grid.arrange(p1, p2, ncol = 1, heights = c(0.9, 1))
```

```{r eval = F}
# state base
calista <- map_data('state', region = 'california')

# psa data fortified
psadat <- calipsa %>%
  as('Spatial') %>%
  as.data.frame %>%
  rownames_to_column('id') %>%
  dplyr::select(id, PSA6) %>%
  dplyr::rename(PSA = PSA6) %>%
  mutate(Region = factor(PSA,
                         levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
                         labels = c('CV', 'Ch', 'DM', 'NC', 'SN', 'SC')
  ))
psafrt <- calipsa %>%
  dplyr::select(-PSA_REGION, -AREA, -PERIMETER, -PSA8) %>%
  as('Spatial') %>%
  fortify %>%
  left_join(psadat, by = 'id')

# all comid preds
calmed <- nhdplo %>%
  na.omit

# all comid class
toplo2 <- caliclsplo %>% 
  na.omit

# median csci predictions
p1 <- ggplot(calmed) +
  geom_path(aes(x = long, y = lat, group = id, colour = core0.50), size = 0.30) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() +
  scale_colour_gradientn(colours = pal(range(calmed$core0.50, na.rm = T))) +
  guides(colour = guide_colourbar('Reach predicted median CSCI\n', barheight = 0.5, barwidth = 8, title.position = 'top')) +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = c(0.5, 1.06),
    legend.direction = 'horizontal',
    plot.margin = grid::unit(c(15, 0, 0, 0), units = 'pt')
  )

# comid class
p2<- ggplot(toplo2) +
  geom_path(aes(x = long, y = lat, group = id, colour = strcls), size = 0.30) +
  geom_polygon(data = psafrt, aes(x = long, y = lat, group = group), fill = NA, size = 0.5, colour = scales::alpha('black', 0.9)) +
  coord_map() +
  scale_colour_manual(values = pal_exp(levels(toplo2$strcls))) +
  guides(colour = guide_legend('Reach classification', title.position = 'top', ncol = 2)) +
  theme_void(base_family = 'serif') +
  theme(
    legend.position = c(0.5, 1.06),
    legend.direction = 'horizontal',
    plot.margin = grid::unit(c(15, 0, 0, 0), units = 'pt')
  )

png('figs/calires.png', height = 6, width = 8, units = 'in', res = 400, family = 'serif')
grid.arrange(p1, p2, ncol = 2)
dev.off()

```
```{r calires, fig.cap = "Statewide application of the landscape model showing the median predicted CSCI scores for each stream reach (left) and corresponding stream reach classifications (right). Major regional boundaries are also shown (see Figure \\@ref(fig:calimap))."}
knitr::include_graphics('figs/calires.png')
```

```{r sgrresplo, fig.height = 7, fig.width = 9, fig.cap = "Application of the landscape model to stream reaches in the San Gabriel River watershed, Los Angeles, California.  CSCI scores with no context from the model are on the left (a) and scores with context from the model are on the right (b). Relative site scores as under scoring, expected, or over scoring are based on observed scores given the reach class as likely constrained, possibly constrained, possibly unconstrained, and likely unconstrained.  Reach classes are based on overlap of the expectations with a hypothetical biological threshold for the CSCI (dashed lined) and location of the median expectation (white ticks)."}
##
# ggplot of sgr site expecations, relative scores

# requires spat, scrs

thrsh <- 0.79; tails <- 0.1

## get sgr expectation for ggplot
# process
incl <- site_exp(spat, sgrscrs, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  dplyr::select(-lat, -long) %>% 
  group_by(StationCode) %>% 
  nest

# average scors by station
out <- sgrscrs %>% 
  dplyr::select(StationCode, lat, long) %>% 
  group_by(StationCode) %>% 
  nest %>% 
  mutate(StationCode = factor(StationCode, levels = levels(incl$StationCode))) %>% 
  left_join(incl, ., by = 'StationCode') %>% 
  unnest

# add additional perf column for multicolor by strcls (pal_prf)
# remove NA csci
ggsgrexp <- get_perf_mlt(out) %>% 
  filter(!is.na(strcls))

# CSCI scores and expectations
toplo1 <- ggsgrexp %>%
  dplyr::select(COMID, StationCode, datcut, strcls, csci, perf, typelv, perf_mlt) %>%
  unnest %>%
  mutate(
    strcls = factor(strcls, levels = levels(strcls)),
    perf = factor(perf, levels = levels(perf))
    ) %>%
  dplyr::rename(
    `Stream Class` = strcls,
    `Relative\nscore` = perf_mlt,
    Type = typelv
    )

# total expected range
toplo2 <- ggsgrexp %>%
  dplyr::select(COMID, StationCode, data, strcls) %>%
  unnest %>%
  mutate(strcls = factor(strcls, levels = levels(strcls))) %>%
  dplyr::rename(`Stream Class` = strcls)

# median expectation
toplo3 <- ggsgrexp %>%
  dplyr::select(COMID, StationCode, datcut) %>%
  unnest %>%
  filter(grepl('0\\.50$', var)) 

# plot, no context
p1 <- ggplot(toplo1, aes(y = StationCode, x = val)) +
  theme_bw(base_family = 'serif', base_size = 12) +
  theme(
    axis.text.y = element_text(size = 6.5), 
    axis.title.y = element_text(size = 13),
    axis.title.x = element_blank(), 
    title = element_text(size = 10)
  ) +
  scale_x_continuous('CSCI') +
  scale_y_discrete('Stream reach') +
  geom_point(aes(x = csci), shape = 16, size = 1.5, alpha = 0.8) +
  geom_vline(xintercept = thrsh, linetype = 'dashed', size = 1) + 
  ggtitle('(a) CSCI scores with no context')

# plot, context
p2 <- ggplot(toplo1, aes(y = StationCode, x = val)) +
  geom_line(data = toplo1, aes(x = val, colour = `Stream Class`), alpha = 0.1, size = 2) +
  geom_line(aes(colour = `Stream Class`), alpha = 0.6, size = 2) +
  geom_point(data = toplo3, colour = 'white', size = 1, alpha = 1, shape = 15) +
  theme_bw(base_family = 'serif', base_size = 12) +
  theme(
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(), 
    axis.ticks.y = element_blank(), 
    legend.position = 'top', 
    title = element_text(size = 10)
  ) +
  scale_x_continuous('CSCI') +
  scale_y_discrete('Site') +
  scale_colour_manual('Stream reach class', values = pal_exp(levels(toplo1$`Stream Class`))) +
  geom_point(aes(x = csci, fill = `Stream Class`, shape = perf), size = 2.5, alpha = 0.8) +
  geom_vline(xintercept = thrsh, linetype = 'dashed', size = 1) +
  scale_shape_manual('Relative site score', values = c(25, 21, 24)) +
  scale_fill_manual(values = pal_exp(levels(toplo1$`Stream Class`)), na.value = 'yellow', guide = F) +
  guides(shape = guide_legend(title.position = 'top'), colour = guide_legend(title.position = 'top', ncol = 2)) +
  ggtitle('(b) CSCI scores with context from the landscape model')
p2leg <- g_legend(p2)
p2 <- p2 + theme(legend.position = 'none')

# png('figs/sgrresplo.png', height = 7, width = 9, units = 'in', res = 300, family = 'serif')
grid.arrange(
  arrangeGrob(p2leg),
  arrangeGrob(p1, p2, ncol = 2, bottom = 'CSCI', widths = c(1, 0.9)),
  ncol = 1, heights = c(0.15, 1)
)
# dev.off()
```

```{r sgrresmap, fig.height = 7.5, fig.width = 8, fig.cap = "Relative site scores and recommended management actions for locations with CSCI scores in the San Gabriel River watershed. Relative site scores as under scoring, expected, or over scoring are based on observed scores given the reach class as likely constrained, possibly constrained, possibly unconstrained, and likely unconstrained. Recommended management actions are ranked by priority for actions to investigate, protect, and restore a site.  No recommended actions assumes baseline maintainence and monitoring is sufficient for a site. Recommended actions were defined by a local stakeholder group (see Figure \\@ref(fig:pritem))."}
# requires spat, scrs

thrsh <- 0.79; tails <- 0.1

##
# nhd sgr str class
sgrcls <- getcls2(spat, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  left_join(spat, ., by = 'COMID') %>% 
  dplyr::select(COMID, strcls)

##
# get biological condition expectations
cls <- getcls2(spat, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  mutate(COMID = as.character(COMID)) 

# get csci difference
sgrscrs <- spat %>% 
  dplyr::select(COMID, core0.50) %>% 
  mutate(COMID = as.character(COMID)) %>% 
  left_join(scrs, ., by = 'COMID') %>% 
  group_by(COMID, StationCode, lat, long) %>% 
  summarise(
    csci = mean(csci, na.rm = TRUE)
  ) %>% 
  ungroup %>%
  left_join(cls, by = 'COMID')

# priorities
pritab <- tibble(
  typelv = paste0('Type', stringr::str_pad(seq(1:16), pad = '0', width = 2)),
  I = c(rep(c('H', '', 'H', 'H'), 2), rep(c('M', 'M', '', 'M'), 2)),
  P = c(rep(c('H', 'M', 'M', ''), 2), rep(c('H', '', '', ''), 2)),
  R = c(rep(c('', '', 'M', 'H'), 2), rep(c('', 'L', 'L', 'L'), 2))
) %>% 
  gather('action', 'priority', I, P, R) %>% 
  mutate(priority = ifelse(priority == '', 'baseline', priority)) %>% 
  spread(action, priority) %>% 
  mutate(
    I = factor(I, levels = c('H', 'M', 'L', 'baseline'), labels = c('High', 'Medium', 'Low', 'baseline')),
    P = factor(P, levels = c('H', 'M', 'L', 'baseline'), labels = c('High', 'Medium', 'Low', 'baseline')),
    R = factor(R, levels = c('H', 'M', 'L', 'baseline'), labels = c('High', 'Medium', 'Low', 'baseline'))
  )

##
# stuff to plot

# relative site scores
sgrexp <- site_exp(spat, sgrscrs, thrsh = thrsh, tails = tails, modls = 'core') %>% 
  dplyr::select(-data, -datcut) %>% 
  mutate(
    strcls = factor(strcls, levels = levels(strcls)),
    perf = factor(perf, levels = rev(levels(perf))),
    typelv = as.character(typelv)
    ) %>% 
  filter(!is.na(perf))

# priorities for sgr
sgrpri <- sgrexp %>% 
  left_join(pritab, by = 'typelv') %>% 
  dplyr::select(StationCode, lat, long, typelv, I, P, R)

# hydrolines
spatdat <- spat %>% 
  dplyr::select(COMID) %>% 
  mutate(id = as.character(1:nrow(.)))
st_geometry(spatdat) <- NULL
spatfrt <- spat %>% 
  as('Spatial') %>% 
  fortify %>% 
  left_join(spatdat, by = 'id') %>% 
  mutate(COMID = as.character(COMID)) %>% 
  left_join(cls, by = 'COMID') %>% 
  mutate(
    strcls = factor(strcls, levels = levels(strcls))
  ) %>% 
  filter(!is.na(strcls))
  
# wshed boundary fortified
shedfrt <- shed %>% 
  as('Spatial') %>% 
  fortify 


thm <- theme_void(base_family = 'serif') +
  theme(
    legend.position = 'top',
    # legend.justification = 'left',
    # legend.box.just = 'left',
    axis.title = element_blank(), 
    strip.background = element_blank()
  )

##
# relative site scores

# sgr all leg
pleg <- ggplot(sgrexp) +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls)) +
  geom_point(data = sgrexp, aes(x = long, y = lat, shape = perf, fill = strcls), size = 3, alpha = 0.7) +
  ggsn::scalebar(location = 'bottomright', y.min = 33.77, y.max = 33.8, x.min = -118, x.max = -117.7, dist = 10, st.dist=.5, st.size = 3, height = 0.3, dd2km = T, model = 'WGS84') +
  scale_colour_manual('Stream reach class', values = pal_exp(levels(spatfrt$strcls))) +
  scale_fill_manual(values = pal_exp(levels(sgrexp$strcls)), na.value = 'yellow', guide = F) +
  scale_shape_manual('Relative site score', values = c(24, 21, 25), guide = F) +
  guides(colour = guide_legend(title.position = 'left', ncol = 2)) +
  coord_equal() +
  thm
clsleg <- g_legend(pleg)

# under
sgrexpund <- sgrexp %>% 
  filter(perf == 'under scoring') %>% 
  mutate(strcls = forcats::fct_drop(strcls))
p1 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrexpund, aes(x = long, y = lat, fill = strcls, shape = perf), size = 3, alpha = 0.9) +
  ggsn::scalebar(location = 'bottomright', y.min = 33.77, y.max = 33.8, x.min = -118, x.max = -117.7, dist = 10, st.dist=.5, st.size = 3, height = 0.3, dd2km = T, model = 'WGS84') +
  scale_colour_manual('Stream reach class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual(values = pal_exp(levels(sgrexpund$strcls)), na.value = 'yellow', guide = F) +
  scale_shape_manual('', values = c(25)) +
  coord_equal() +
  thm + 
  theme(legend.position = c(0.5, 1.05))

# expected
sgrexpexp <- sgrexp %>% 
  filter(perf == 'expected') %>% 
  mutate(strcls = forcats::fct_drop(strcls))
p2 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrexpexp, aes(x = long, y = lat, fill = strcls, shape = perf), size = 3, alpha = 0.9) +
  scale_colour_manual('Stream reach class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual(values = pal_exp(levels(sgrexpexp$strcls)), na.value = 'yellow', guide = F) +
  scale_shape_manual('', values = c(21)) +
  coord_equal() +
  thm + 
  theme(legend.position = c(0.5, 1.05))

# over
sgrexpovr <- sgrexp %>% 
  filter(perf == 'over scoring') %>% 
  mutate(strcls = forcats::fct_drop(strcls))
p3 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrexpovr, aes(x = long, y = lat, fill = strcls, shape = perf), size = 3, alpha = 0.9) +
  scale_colour_manual('Stream reach class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual(values = pal_exp(levels(sgrexpovr$strcls)), na.value = 'yellow', guide = F) +
  scale_shape_manual('', values = c(24)) +
  coord_equal() +
  thm + 
  theme(legend.position = c(0.5, 1.05))

##
# site priorities

# investigate
p4 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrpri, aes(x = long, y = lat, fill = I, size = I), shape = 21, alpha = 1) +
  scale_colour_manual('Stream reach class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual('Investigate', values = pal_pri(levels(forcats::fct_drop(sgrpri$I)))) +
  scale_size_manual('Investigate', values = pal_siz(levels(forcats::fct_drop(sgrpri$I)))) +
  coord_equal() +
  thm + 
  theme(
    legend.position = c('none'), 
    plot.title = element_text(hjust = 0.5, size = 9)
    ) + 
  ggtitle('Investigate')

# protect
p5 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrpri, aes(x = long, y = lat, fill = P, size = P), shape = 21, alpha = 1) +
  scale_colour_manual('Stream reach class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual('Protect', values = pal_pri(levels(forcats::fct_drop(sgrpri$P)))) +
  scale_size_manual('Protect', values = pal_siz(levels(forcats::fct_drop(sgrpri$P)))) +
  coord_equal() +
  thm + 
  theme(
    legend.position = c('none'), 
    plot.title = element_text(hjust = 0.5, size = 9)
  ) + 
  ggtitle('Protect')

# restore
p6 <- ggplot() +
  geom_polygon(data = shedfrt, aes(x = long, y = lat, group = group), fill = 'white', colour = 'black', alpha = 0.7) +
  geom_path(data = spatfrt, aes(x = long, y = lat, group = id, colour = strcls), size = 0.3) +
  geom_point(data = sgrpri, aes(x = long, y = lat, fill = R, size = R), shape = 21, alpha = 1) +
  scale_colour_manual('Stream reach class', values = pal_exp(levels(spatfrt$strcls)), guide = F) +
  scale_fill_manual('Priority', values = pal_pri(levels(forcats::fct_drop(sgrpri$R)))) +
  scale_size_manual('Priority', values = pal_siz(levels(forcats::fct_drop(sgrpri$R)))) +
  coord_equal() +
  thm + 
  theme(
    legend.position = c('top'), 
    plot.title = element_text(hjust = 0.5, size = 9)
  ) + 
  ggtitle('Restore') +
  guides(fill = guide_legend(title.position = 'left'), size = guide_legend(title.position = 'left'))
prileg <- g_legend(p6)
p6 <- p6 + theme(legend.position = 'none')

# png('figs/sgrresmap.png', height = 7.5, width = 8, units = 'in', res = 400, family = 'serif')
grid.arrange(
  arrangeGrob(clsleg),
  arrangeGrob(p1, p2, p3, ncol = 3),
  arrangeGrob(prileg),
  arrangeGrob(p4, p5, p6, ncol = 3),
  ncol = 1, heights = c(0.2, 1, 0.1, 1)
)
# dev.off()
```

```{r pritem, fig.height = 4.75, fig.width = 7, fig.cap = 'Template provided to stakeholders for prioritization of recommended actions for each stream type.  The reach types (Table \\@ref(tab:typetab)) relate to the stream class for the biological expectation (likely unconstrained, possibly unconstrained, possibly constrained, likely constrained), relative site score for the observed CSCI (over scoring, expected, under scoring), and location of the score relative to a hypothetical biological threshold (dashed line, above or below).  Horizontal lines are the range of expected CSCI score for a site with tick marks for the median. Priority actions defined by stakeholders are shown on the right for each stream type. Actions are generalized as investigate, protect, or monitor as high (H), medium (M), or low (L) priority.  Blank cells indicate that no additional measures are recommended beyond the baseline monitoring and maintenance practiced at all sites.'}
sts <- paste('Site', seq(1:16))

# example data, csci scores
scrs_ex <- data.frame(
  Site = factor(sts, levels = sts),
  csci = c(1.25, 0.98, 0.81, 0.68, 1.14, 0.87, 0.73, 0.58, 0.98, 0.83, 0.68, 0.5, 0.88, 0.76, 0.57, 0.39)
)

# example data, stream predictions
exps_ex <- data.frame(
  Site = factor(sts, levels = sts),
  minv = rep(c(0.84, 0.68, 0.58, 0.43), each = 4),
  maxv = rep(c(1.14, 0.98, 0.88, 0.73), each = 4),
  stringsAsFactors = F
) %>% 
  mutate(medv = ((maxv - minv) / 2) + minv)

# calculate class, performance, type, 
plot_ex <- proc_all(exps_ex, scrs_ex, thrsh = 0.79, tails = 0.1) %>% 
  dplyr::rename(
    `Stream\nclass` = `Stream class`
  ) %>% 
  mutate(`Stream\nclass` = factor(`Stream\nclass`, levels = rev(levels(`Stream\nclass`))))

# priorities
pritab <- tibble(
  Type = seq(1:length(sts)),
  Investigate = c(rep(c('H', '', 'H', 'H'), 2), rep(c('M', 'M', '', 'M'), 2)),
  Protect = c(rep(c('H', 'M', 'M', ''), 2), rep(c('H', '', '', ''), 2)),
  Restore = c(rep(c('', '', 'M', 'H'), 2), rep(c('', 'L', 'L', 'L'), 2))
  ) %>% 
  gather('action', 'priority', -Type)

mythm <- theme_minimal(base_family = 'serif', base_size = 12) +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.line.x = element_line(), 
    axis.line.y = element_line(), 
    axis.ticks.y = element_line(), 
    axis.text.x = element_blank(),
    legend.position = 'top',
    plot.margin = grid::unit(c(5.5, 0, 5.5, 5.5), units = 'pt')
  )

p1 <- ggplot(plot_ex, aes(x = typelv)) + 
  geom_errorbar(aes(ymin = minv_qt, ymax = maxv_qt, colour = `Stream\nclass`), width = 0, size = 2, alpha = 0.2) + 
  geom_errorbar(aes(ymin = minv_qt, ymax = maxv_qt, colour = `Stream\nclass`), width = 0, size = 2, alpha = 0.7) + 
  geom_point(aes(y = medv), colour = 'white', size = 0.75, alpha = 0.6, shape = 15) +
  geom_point(aes(y  = `CSCI score`, fill = `Stream\nclass`, shape = perf), size = 4, alpha = 0.8) +
  geom_hline(yintercept = 0.79, linetype = 'dashed') +
  scale_colour_manual('Stream reach class', values = pal_exp(levels(plot_ex$`Stream\nclass`)), 
                    guide = guide_legend(direction = 'vertical', title.position = 'left', ncol = 2)) +
  scale_fill_manual(values = pal_exp(levels(plot_ex$`Stream\nclass`)), 
                    guide = F) +
  scale_shape_manual('Relative site score', values = c(25, 21, 24)) +
  scale_x_discrete('Reach type', limits = rev(levels(plot_ex$typelv)), labels = rev(c(1:nrow(plot_ex)))) +
  scale_y_continuous('CSCI score') +
  guides(colour = guide_legend(title.position = 'top', ncol = 2), shape = guide_legend(title.position = 'top')) + 
  mythm +
  coord_flip() + 
  ggtitle('')
p1leg <- g_legend(p1)
p1 <- p1 + mythm %+replace% theme(legend.position = 'none')

p2 <- ggplot(pritab, aes(x = Type, y = 1)) +
  geom_text(aes(label = priority), family = 'serif') + 
  facet_wrap(~action) + 
  coord_flip() + 
  scale_x_reverse(breaks = c(1:length(sts)), labels = c(1:length(sts))) + 
  theme(
    panel.background = element_rect(fill = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(family = 'serif', size = 11),
    axis.ticks.x = element_line(color = 'white'),
    axis.text.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(), 
    # axis.text.y = element_text(family = 'serif', size = 12),
    axis.title = element_text(colour = 'white'), 
    plot.margin = grid::unit(c(4, 5.5, 5.5, -3), units = 'pt')
  )

grid.arrange(
  p1leg, 
  arrangeGrob(p1, p2, ncol = 2, widths = c(1, 0.8)), 
  heights = c(0.25, 1)
)
```

```{r calicnstr, fig.height = 5, fig.width = 7, fig.cap = 'Factors associated with constrained and unconstrained stream reaches by major regions in California. Importance measures were obtained from random forest models of 130 watershed and riparian measures of landscape and geological characteristics from the StreamCat dataset [@Hill16]. The top five variables for each region are shown.  The importance measures describe the mean decrease in prediction accuracy with exclusion of a variable across 1000 random trees for each model. Stream reach classes as possibly or likely were combined for constrained and unconstrained to evaluate the complete dataset. CV: Central Valley, CH: Chaparral, DM: Deserts Modoc, NC: North Coast, SN: Sierra Nevada, SC: South Coast.'}

# format for plotting, all data
toplo <- cnstrfrst %>% 
  mutate(mods = purrr::map(mods, function(x){

    out <- x %>%   
      data.frame %>% 
      rownames_to_column('var') %>% 
      dplyr::select(var, MeanDecreaseAccuracy) %>% 
      arrange(-MeanDecreaseAccuracy) %>% 
      .[1:5, ] %>% 
      mutate(var = factor(var, levels = var)) 
    
    return(out)
    
    })
  ) %>% 
  unnest %>% 
  dplyr::rename(
    Region = PSA6,
    Importance = MeanDecreaseAccuracy
    ) %>% 
  mutate(Region = factor(Region, 
         levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
         labels = c('CV', 'CH', 'DM', 'NC', 'SN', 'SC'))
  )

# these have to be manually changed
toplo <- toplo %>% 
  mutate(var = factor(var, 
                      levels = c('AgKffactWs', 'CBNFWs', 'FertWs', 'PctCrop2011Ws', 'PctCrop2011WsRp100', 'PctHay2011Ws', 'PctHay2011WsRp100', 'PctImp2006Ws', 'PctImp2006WsRp100', 'PctUrbLo2011Ws', 'PctUrbLo2011WsRp100', 'PctUrbMd2011Ws'), 
                      labels = c('soil erod.', 'bio. N fixation', 'fertilizer', '% crop', '% riparian crop', '% hay', '% riparian hay', '% imp.', '% riparian imp.', '% lo urban', '% riparian lo urban', '% mid urban')
  ))

cols <- brewer.pal(9, 'Paired')[c(6, 2)]

ylims <- max(toplo$Importance)
toplo1 <- toplo %>% 
  unique %>% 
  group_by(Region) %>% 
  nest %>% 
  arrange(Region) %>% 
  mutate(plos = pmap(list(as.character(Region), data), function(Region, data){
    
    # format the data
    x <- data %>% 
      mutate(var = factor(var, levels = var))
    
    # make the plot
    p <- ggplot(x, aes(x = var, y = Importance, group = 1)) + 
      geom_segment(aes(xend = var, yend = 0)) +
      geom_point(colour = 'black') +
      theme_bw(base_family = 'serif') +
      theme(
        axis.text.x = element_text(angle = 30, hjust = 1, size = 7), 
        axis.title.x = element_blank(), 
        plot.title = element_text(hjust = 0.5), 
        axis.title.y = element_blank(), 
        legend.position = 'top'
      ) +
      scale_y_continuous(limits = c(0, ylims)) +
      ggtitle(as.character(Region))
    
    return(p)
    
  }))

p1 <- toplo1$plos[[1]] + theme(legend.position = 'none')
p2 <- toplo1$plos[[2]] + theme(legend.position = 'none')
p3 <- toplo1$plos[[3]] + theme(legend.position = 'none')
p4 <- toplo1$plos[[4]] + theme(legend.position = 'none')
p5 <- toplo1$plos[[5]] + theme(legend.position = 'none')
p6 <- toplo1$plos[[6]]
grid.arrange(
  p1, p2, p3, p4, p5, p6, ncol = 3, left = 'Importance'
)
```

```{r lndscpimp, fig.height = 5, fig.width = 7, fig.cap = "Importance measures for landscape variables used to develop the landscape model of expected stream bioassessment scores in California. Values were obtained from quantile regression models of twenty landscape measures shown in Table \\@ref(tab:crvr) obtained from the StreamCat dataset [@Hill16]. The importance measures describe the percent increase in mean square error and the increase in node impurity with exclusion of a variable across all random trees for each model [@Meinshausen17]."}
varImpPlot(rf_core, main = NULL)
```

```{r sensplo, fig.height = 8, fig.width = 6, fig.cap = 'Changes in stream reach classes by region and statewide for different scenarios used to define biological constraints.  Twenty-seven scenarios were tested that evaluated different combinations of certainty in the CSCI predictions (nine scenarios more certain to less certain as identified by the tail cutoff for the expected range) and potential CSCI threshold (three scenarios for relaxed to more conservative).  The percentage of total stream length for each classification is shown for each scenario. CV: Central Valley, CH: Chaparral, DM: Deserts Modoc, NC: North Coast, SN: Sierra Nevada, SC: South Coast.'}

# search grid
grd_chk <- list(
  thrsh = c(0.63, 0.79, 0.92), 
  tails = seq(0.05, 0.45, by = 0.05)
) %>% 
  cross_df

# stream class sensitivity
senscls <- sensres %>% 
  purrr::map(~ .x[[1]]) %>% 
  enframe %>% 
  bind_cols(grd_chk, .) %>% 
  dplyr::select(-name) %>% 
  unnest %>% 
  mutate(
    thrsh = as.character(thrsh),
    tails = as.character(tails), 
    Region = gsub('^statewide$', 'Statewide', Region),
    strcls = factor(strcls, levels = rev(levels(strcls)))
  ) 

# results plot
pres <- ggplot(senscls, aes(x = tails, y = perc, fill = strcls, group = strcls)) + 
  geom_bar(stat = 'identity', colour = scales::alpha('black', 0.5), width = 1, alpha = 0.7) +
  facet_grid(Region ~ thrsh) +
  scale_fill_manual('Stream reach class', values = pal_exp(levels(senscls$strcls))) +
  theme_bw(base_family = 'serif') +     
  scale_y_continuous('% stream length', expand = c(0, 0)) + 
  scale_x_discrete('Certainty in CSCI predictions (more to less)', expand = c(0, 0)) +
  theme(
    strip.background = element_blank(), 
    axis.text.x = element_text(size = 7),
    axis.text.y = element_text(size = 7),
    legend.position = 'top', 
    panel.grid = element_blank()
  ) + 
  guides(fill = guide_legend(title.position = 'left', ncol = 2))


pleg <- g_legend(pres)
pres <- pres + theme(legend.position = 'none')

grobsz <- gpar(cex = 0.7)
grid.arrange(
  arrangeGrob(
    pleg,
    textGrob('Example CSCI threshold (relaxed to conservative)', gp = grobsz), 
    pres,
    heights= c(0.1, 0.02, 1), ncol = 1
  ) 
)
```

# Tables 

```{r crvr, tidy = F}
# streamcat variables used in core models

nms <- c("CanalDensCat", "CanalDensWs", "PctImp2006Cat", "PctImp2006Ws", "PctImp2006CatRp100", 
         "PctImp2006WsRp100", "TotUrb2011Ws", "TotUrb2011Cat", "TotUrb2011WsRp100", "TotUrb2011CatRp100", 
         "TotAg2011Ws", "TotAg2011Cat", "TotAg2011WsRp100", "TotAg2011CatRp100", "RdDensCat", "RdDensWs", 
         "RdDensCatRp100", "RdDensWsRp100", "RdCrsCat", "RdCrsWs")
scl <- c('catchment', 'watershed', 'catchment', 'watershed', 'catchment, riparian', 'watershed, riparian',
         'watershed', 'catchment', 'watershed, riparian', 'catchment, riparian', 'watershed', 'catchment', 
         'watershed, riparian', 'catchment, riparian', 'catchment', 'watershed', 'catchment, riparian', 
         'watershed, riparian', 'catchment', 'watershed')
dsc <- c(
  'Density of NHDPlus line features classified as canal, ditch, or pipeline',
  'Density of NHDPlus line features classified as canal, ditch, or pipeline',
  'Mean imperviousness of anthropogenic surfaces (NLCD 2006)',
  'Mean imperviousness of anthropogenic surfaces (NLCD 2006)',
  'Mean imperviousness of anthropogenic surfaces (NLCD 2006)',
  'Mean imperviousness of anthropogenic surfaces (NLCD 2006)',
  'Total urban land use as sum of developed open, low, medium, and high intensity (NLCD 2011)',
  'Total urban land use as sum of developed open, low, medium, and high intensity (NLCD 2011)',
  'Total urban land use as sum of developed open, low, medium, and high intensity (NLCD 2011)',
  'Total urban land use as sum of developed open, low, medium, and high intensity (NLCD 2011)',
  'Total argricultural land use as sum of hay and crops (NLCD 2011)',
  'Total argricultural land use as sum of hay and crops (NLCD 2011)',
  'Total argricultural land use as sum of hay and crops (NLCD 2011)',
  'Total argricultural land use as sum of hay and crops (NLCD 2011)',
  'Density of roads (2010 Census Tiger Lines)',
  'Density of roads (2010 Census Tiger Lines)',
  'Density of roads (2010 Census Tiger Lines)',
  'Density of roads (2010 Census Tiger Lines)',
  'Density of roads-stream intersections (2010 Census Tiger Lines-NHD stream lines)',
  'Density of roads-stream intersections (2010 Census Tiger Lines-NHD stream lines)'
)

unt <- c('km/sq km', 'km/sq km', '%', '%', '%', '%', '%', '%', '%', '%', '%', '%', '%', '%',
         'km/sq km', 'km/sq km', 'km/sq km', 'km/sq km', 'crossings/sq km', 
         'crosssings/sq km')

totab <- data.frame(nms, scl, dsc, unt) %>% 
  dplyr::rename(Name = nms, Scale = scl, Description = dsc, Unit = unt)

# table stuff
cap.val <- 'Land use variables used to develop the landscape model of stream bioassessment scores.  All variables were obtained from StreamCat [@Hill16].  The measurement scale for each variable is at the catchment, watershed, and/or riparian scale (100 m buffer) relative to a stream reach. Total urban and agriculture land use variables were based on sums of indvidual variables in StreamCat as noted in the desciption.'

# table
knitr::kable(totab, booktabs = T, caption = cap.val)
```

```{r clsdef, tidy = F}
# table content format
totab <- tibble(
  Class = c('Likely unconstrained', 'Possibly unconstrained', 'Possibly constrained', 'Likely constrained'),
  Definition = c('Lower bound of prediction interval is above threshold', 'Median prediction is above threshold', 'Median prediction is below threshold', 'Upper bound of prediction interval is below threshold'), 
  Example = c('10th percentile > 0.79', '50th percentile > 0.79', '50th percentile < 0.79', '90th percentile < 0.79')
  )

# table stuff
cap.val <- 'Stream class definitions describing potential biological constraints.  Classes are based on the overlap of the range of likely bioassessment scores with a potential threshold for a biological objective.  Identifying stream classes requires selecting the cutoff range of likely scores from the landscape model and a chosen threshold for the objective.'

# table
knitr::kable(totab, booktabs = T, caption = cap.val)
```

```{r typetab, tidy = F}
# table content format
totab <- typetab %>% 
  mutate(
    `Observed score` = gsub('>=', '$\\\\geq$', `Observed score`),
    `Reach expectation` = ifelse(duplicated(`Reach expectation`), '', paste0('**', `Reach expectation`, '**')), 
    Type = as.character(Type)
  ) %>% 
  dplyr::rename(`Relative site score` = `Site performance`) %>% 
  dplyr::select(-Sites)

# table stuff
cap.val <- 'Possible site types based on stream reach classification, relative site score, and observed CSCI score. The observed score column describes where a CSCI score is observed relative to the lower and upper percentiles (e.g., 10th and 90th) of expected scores for a reach and the chosen CSCI threshold (e.g., 10th percentile of scores at reference sites or 0.79) for nominally low or high values.'

# table
knitr::kable(totab, booktabs = T, caption = cap.val)
```

```{r perftab}
# observed and predicted data
obsdat <- csci_comid %>%
  dplyr::select(COMID, StationCode, SiteSet, SelectedSample, CSCI, PSA6c, RegImpQ) %>% 
  filter(SelectedSample %in% 'Selected')
prddat <- comid_prd %>% 
  dplyr::select(COMID, core0.50)

# combined data to eval for perf
dat <- obsdat %>% 
  inner_join(prddat, by = 'COMID') %>% 
  dplyr::rename(
    observed = CSCI,
    predicted = core0.50
  ) %>% 
  dplyr::select(SiteSet, PSA6c, observed, predicted)

# total dataset performance
totdf <- dat %>% 
  group_by(SiteSet) %>% 
  nest %>% 
  mutate(data = purrr::map(data, function(x){

    nval <- nrow(x)
    aveobs <- mean(x$observed, na.rm = T)
    sdobs <- sd(x$observed, na.rm = T)
    aveprd <- mean(x$predicted, na.rm = T)
    sdprd <- sd(x$predicted, na.rm = T)
    mod <- lm(predicted ~ observed, data = x)
    intv <- coefficients(mod)[1]
    slov <- coefficients(mod)[2]
    corv <- with(x, cor.test(observed, predicted))$estimate
    errv <- with(x, sqrt(mean((predicted - observed)^2, na.rm = T)))
    
    out <- tibble(set = 'Statewide', nval, aveobs, sdobs, aveprd, sdprd, corv, errv, intv, slov)
    return(out)
    
  })) %>% 
  unnest

# PSA regional performance
regdf <- dat %>% 
  group_by(PSA6c, SiteSet) %>% 
  nest %>% 
  mutate(data = purrr::map(data, function(x){
    
    nval <- nrow(x)
    aveobs <- mean(x$observed, na.rm = T)
    sdobs <- sd(x$observed, na.rm = T)
    aveprd <- mean(x$predicted, na.rm = T)
    sdprd <- sd(x$predicted, na.rm = T)
    ttst <- with(x, t.test(observed, predicted, na.rm = T))
    mod <- lm(predicted ~ observed, data = x)
    intv <- coefficients(mod)[1]
    slov <- coefficients(mod)[2]
    corv <- with(x, cor.test(observed, predicted))$estimate
    errv <- with(x, sqrt(mean((predicted - observed)^2, na.rm = T)))
    
    out <- tibble(nval, aveobs, sdobs, aveprd, sdprd, corv, errv, intv, slov)
    return(out)
    
  })) %>% 
  unnest %>% 
  dplyr::rename(set = PSA6c) %>% 
  dplyr::select(SiteSet, set, everything())

# combine and prep for table
allerr <- totdf %>% 
  bind_rows(regdf) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  mutate(
    sdobs = paste0('(', sdobs, ')'), 
    sdprd = paste0('(', sdprd, ')'), 
    set = factor(set, levels = c('Statewide', 'CH', 'CV', 'DM', 'NC', 'SC', 'SN'))
  ) %>% 
  unite('Observed', aveobs, sdobs, sep = ' ') %>% 
  unite('Predicted', aveprd, sdprd, sep = ' ') %>% 
  dplyr::rename(
    n = nval,
    Correlation = corv, 
    RMSE = errv, 
    Slope = slov, 
    Intercept = intv,
    Location = set, 
    Dataset = SiteSet
  ) %>% 
  arrange(Dataset, Location) %>% 
  mutate(Dataset = ifelse(duplicated(Dataset), '', Dataset))

# table stuff
cap.val <- 'Performance of the landscape model by calibration and validation datasets in predicting CSCI scores.  The statewide dataset (Figure \\@ref(fig:calires)) and individual regions of California (Figure \\@ref(fig:calimap) are evaluated.  Averages and standard deviations (in parentheses) for observed and predicted values of each dataset are shown.  Correlations, root mean squared errors (RMSE), intercept, and slopes are for comparisons of predicted and observed values to evaluate model performance.'

# table
knitr::kable(allerr, booktabs = T, caption = cap.val)
```

*Table \@ref(tab:clstot): (\#tab:clstot) Summary of stream length for each stream class statewide and in major regions of California (Figures \@ref(fig:calimap), \@ref(fig:calires)).  Lengths are in kilometers with the percentage of the total length in a region in parentheses. CV: Central Valley, CH: Chaparral, DM: Deserts Modoc, NC: North Coast, SN: Sierra Nevada, SC: South Coast.*
```{r clstot}
st_geometry(strclslen) <- NULL
lentot <- strclslen %>% 
  filter(!is.na(strcls)) %>% 
  mutate(
    Region = factor(PSA6, 
                  levels = c('Central Valley', 'Chaparral', 'Deserts Modoc', 'North Coast', 'Sierra Nevada', 'South Coast'),
                  labels = c('CV', 'CH', 'DM', 'NC', 'SN', 'SC')
    )
  ) %>% 
  group_by(Region, strcls) %>% 
  summarise(len = sum(lens)) %>% 
  spread(strcls, len, fill = 0) %>% 
  gather('strcls', 'len', -Region) %>% 
  group_by(Region) %>% 
  mutate(
    perc = 100 * len / sum(len), 
    perc = round(perc, 0),
    perc = paste0('(', perc, ')'),
    len = round(len, 0), 
    strcls = factor(strcls, levels = c('likely constrained', 'possibly constrained', 'possibly unconstrained', 'likely unconstrained'))
  ) %>% 
  unite(`Stream km (%)`, len, perc, sep = ' ') %>% 
  arrange(Region, strcls) %>% 
  spread(strcls, `Stream km (%)`)

lentotall <- strclslen %>% 
  filter(!is.na(strcls)) %>% 
  group_by(strcls) %>% 
  summarise(len = sum(lens)) %>%
  ungroup %>% 
  mutate(
    perc = 100 * len / sum(len), 
    perc = round(perc, 0),
    perc = paste0('(', perc, ')'),
    len = round(len, 0), 
    strcls = factor(strcls, levels = c('likely constrained', 'possibly constrained', 'possibly unconstrained', 'likely unconstrained'))
  ) %>% 
  unite(`Stream km (%)`, len, perc, sep = ' ') %>% 
  arrange(strcls) %>% 
  mutate(Region = 'Statewide') %>% 
  spread(strcls, `Stream km (%)`)

totab <- bind_rows(lentotall, lentot)

# use flextable
brd <- fp_border(color="black")

tab <- regulartable(totab) %>% 
  font(fontname = 'Times', part = 'all') %>% 
  fontsize(size = 12, part = 'all') %>% 
  border_remove %>%
  set_header_labels(Region = 'Region', `likely constrained` = 'likely', `possibly constrained` = 'possibly', `possibly unconstrained` = 'possibly', `likely unconstrained` = 'likely') %>% 
  add_header(Region = '', `likely constrained` = 'constrained', `possibly constrained` = 'constrained', `possibly unconstrained` = 'unconstrained', `likely unconstrained` = 'unconstrained') %>% 
  merge_h(part = 'header', i = 1) %>% 
  hline(part = 'header', border = brd) %>% 
  align(align = 'left', part = 'all') %>% 
  autofit 
tab
```

*Table \@ref(tab:reltot): \(\#tab:reltot) Summary of CSCI scores by relative expectations for each stream class statewide and in each major region of California (Figures \@ref(fig:calimap), \@ref(fig:calires)). Average (standard deviation) scores and counts (percents) of the number of monitoring stations in each relative expectation and region are shown.  Sites are over scoring if the observed scores are above the range of expectations at a reach, expected if within the range, or under scoring if below the range. CV: Central Valley, CH: Chaparral, DM: Deserts Modoc, NC: North Coast, SN: Sierra Nevada, SC: South Coast.*
```{r reltot, eval = T}
cscipsa <- csci_comid %>% 
  dplyr::select(COMID, PSA6c) %>% 
  unique %>% 
  mutate(COMID = as.character(COMID))

# format table of site counts by region
reltot <- caliexp %>% 
  dplyr::select(COMID, csci, StationCode, strcls, perf) %>% 
  filter(!is.na(strcls)) %>% 
  left_join(cscipsa, by = 'COMID') %>% 
  dplyr::rename(Region = PSA6c) %>% 
  group_by(Region, perf) %>% 
  summarise(
    n = n(), 
    csciave = mean(csci, na.rm = T), 
    csciave = round(csciave, 2),
    cscisd = sd(csci, na.rm = T), 
    cscisd = round(cscisd, 2), 
    cscisd = paste0('(', cscisd, ')')
  ) %>% 
  group_by(Region) %>% 
  mutate(
    perc = n / sum(n), 
    perc = round(100 * perc, 0), 
    perc = paste0('(', perc, ')')
  ) %>% 
  unite('csci', csciave, cscisd, sep = ' ') %>% 
  unite('n_perc', n, perc, sep = ' ') %>% 
  complete(Region, perf, fill = list('n_perc' = '0 (0)', csci = '-')) %>% 
  gather('var', 'val', -Region, -perf) %>%
  arrange(Region, perf) %>%
  unite('colnm', perf, var, sep = '-') %>%
  spread(colnm, val) %>%
  .[, c(1, 6, 7, 2, 3, 4, 5)]

# whole state
reltotall <- caliexp %>% 
  dplyr::select(COMID, csci, StationCode, strcls, perf) %>% 
  filter(!is.na(strcls)) %>% 
  left_join(cscipsa, by = 'COMID') %>% 
  dplyr::rename(Region = PSA6c) %>% 
  group_by(perf) %>% 
  summarise(
    n = n(), 
    csciave = mean(csci, na.rm = T), 
    csciave = round(csciave, 2),
    cscisd = sd(csci, na.rm = T), 
    cscisd = round(cscisd, 2), 
    cscisd = paste0('(', cscisd, ')')
  ) %>% 
  ungroup %>% 
  mutate(
    perc = n / sum(n), 
    perc = round(100 * perc, 0), 
    perc = paste0('(', perc, ')')
  ) %>% 
  unite('csci', csciave, cscisd, sep = ' ') %>% 
  unite('n_perc', n, perc, sep = ' ') %>% 
  gather('var', 'val', -perf) %>%
  arrange(perf) %>%
  unite('colnm', perf, var, sep = '-') %>%
  mutate(Region = 'Statewide') %>% 
  spread(colnm, val) %>%
  .[, c(1, 6, 7, 2, 3, 4, 5)]

totab <- bind_rows(reltotall, reltot)

# use flextable
brd <- fp_border(color="black")

tab <- regulartable(totab) %>% 
  font(fontname = 'Times', part = 'all') %>% 
  fontsize(size = 12, part = 'all') %>% 
  border_remove %>%
  set_header_labels(Region = 'Region', `expected-csci` = 'CSCI', `expected-n_perc` = 'n (%)', `over scoring-csci` = 'CSCI', `over scoring-n_perc` = 'n (%)', `under scoring-csci` = 'CSCI', `under scoring-n_perc` = 'n (%)') %>% 
  add_header(Region = '', `expected-csci` = 'expected', `expected-n_perc` = 'expected', `over scoring-csci` = 'over scoring', `over scoring-n_perc` = 'over scoring', `under scoring-csci` = 'under scoring', `under scoring-n_perc` = 'under scoring') %>% 
  merge_h(part = 'header') %>% 
  hline(part = 'header', border = brd) %>% 
  align(align = 'left', part = 'all') %>% 
  autofit 
tab
```

```{r typscrs}
totab <- typscrs %>% 
  mutate(
    grps = factor(grps, levels = c('urb', 'ag', 'oth'), labels = c('Urban', 'Ag', 'Open')),
    Region = ifelse(duplicated(Region), '', Region)
    ) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  unite('5th - 95th (More certain)', lo05, hi95, sep = ' - ') %>% 
  unite('25th - 75th', lo25, hi75, sep = ' - ') %>% 
  unite('45th - 55th (Less certain)', lo45, hi55, sep = ' - ')

# table stuff
cap.val <- 'Ranges of expected CSCI scores for sites that are typically urban, agricultural, or open (neither urban nor agricultural) land uses by major regions in California and statewide. Ranges can be used to identify approximate expectations for stream reaches with insufficient data for application of the landscape model. CV: Central Valley, CH: Chaparral, DM: Deserts Modoc, NC: North Coast, SN: Sierra Nevada, SC: South Coast.'

# table
knitr::kable(totab, booktabs = T, caption = cap.val)
```

# References


